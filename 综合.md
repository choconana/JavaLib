# Springæ¡†æ¶

- [SpringMVC](https://snailclimb.gitee.io/javaguide/#/docs/system-design/framework/spring/SpringMVC-Principle)

## [SpringCloud](https://github.com/dyc87112/SpringCloud-Learning)

### [Eureka](https://blog.csdn.net/zhuyanlin09/article/details/89598245)

#### 1. ä¸‰ç»„ä»¶

* æœåŠ¡æä¾›è€…

  1. å¯åŠ¨åï¼Œå‘æ³¨å†Œä¸­å¿ƒå‘èµ·registerè¯·æ±‚ï¼Œ**æ³¨å†ŒæœåŠ¡**ï¼›

  2. åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œ**å¿ƒè·³æœºåˆ¶**ï¼Œå®šæ—¶å‘æ³¨å†Œä¸­å¿ƒå‘é€renewå¿ƒè·³ï¼Œè¯æ˜â€œæˆ‘è¿˜æ´»ç€â€ï¼›

  3. åœæ­¢æœåŠ¡æä¾›è€…ï¼Œå‘æ³¨å†Œä¸­å¿ƒå‘èµ·**cancelè¯·æ±‚**ï¼Œ**æ¸…ç©º**å½“å‰æœåŠ¡æ³¨å†Œä¿¡æ¯ï¼›

* æœåŠ¡æ¶ˆè´¹è€…

  1. å¯åŠ¨åï¼Œä»æ³¨å†Œä¸­å¿ƒ**æ‹‰å–**æœåŠ¡æ³¨å†Œä¿¡æ¯ï¼›

  2. åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œ**å®šæ—¶æ›´æ–°**æœåŠ¡æ³¨å†Œä¿¡æ¯ï¼›

  3. æœåŠ¡æ¶ˆè´¹è€…å‘èµ·**è¿œç¨‹è°ƒç”¨**ï¼›

* æ³¨å†Œä¸­å¿ƒ

  1. å¯åŠ¨åï¼Œä»å…¶ä»–èŠ‚ç‚¹**æ‹‰å–**æœåŠ¡æ³¨å†Œä¿¡æ¯ï¼›

  2. è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå®šæ—¶è¿è¡Œevictä»»åŠ¡ï¼Œ**å‰”é™¤**æ²¡æœ‰æŒ‰æ—¶renewçš„æœåŠ¡ï¼ˆåŒ…æ‹¬éæ­£å¸¸åœæ­¢å’Œç½‘ç»œæ•…éšœçš„æœåŠ¡ï¼‰ï¼›

  3. è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¥æ”¶åˆ°çš„registerã€renewã€cancelè¯·æ±‚ï¼Œéƒ½ä¼š**åŒæ­¥**è‡³å…¶ä»–æ³¨å†Œä¸­å¿ƒèŠ‚ç‚¹ï¼›

#### 2. æ•°æ®å­˜å‚¨ç»“æ„

![Eurekaæ•°æ®å­˜å‚¨ç»“æ„](assets\Eurekaæ•°æ®å­˜å‚¨ç»“æ„.png)

##### æ•°æ®å­˜å‚¨å±‚

* `registry`æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŒå±‚çš„`ConcurrentHashMap`ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼›
* `Lease`å¯¹è±¡åŒ…å«äº†æœåŠ¡è¯¦æƒ…å’ŒæœåŠ¡æ²»ç†ç›¸å…³çš„å±æ€§ã€‚

##### äºŒçº§ç¼“å­˜å±‚

* ä¸€çº§ç¼“å­˜ï¼š`ConcurrentHashMap<Key,Value> readOnlyCacheMap`ï¼Œæœ¬è´¨ä¸Šæ˜¯`HashMap`ï¼Œæ— è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜æœåŠ¡ä¿¡æ¯çš„å¯¹å¤–è¾“å‡ºæ•°æ®ç»“æ„ï¼›
* äºŒçº§ç¼“å­˜ï¼š`Loading<Key,Value> readWriteCacheMap`ï¼Œæœ¬è´¨ä¸Šæ˜¯`guava`çš„ç¼“å­˜ï¼ŒåŒ…å«å¤±æ•ˆæœºåˆ¶ï¼Œä¿å­˜æœåŠ¡ä¿¡æ¯çš„å¯¹å¤–è¾“å‡ºæ•°æ®ç»“æ„ã€‚

#### 3. æœåŠ¡æ³¨å†Œæœºåˆ¶

![EurekaæœåŠ¡æ³¨å†Œæœºåˆ¶](assets\EurekaæœåŠ¡æ³¨å†Œæœºåˆ¶.png)

#### 4. æœåŠ¡ç»­çº¦æœºåˆ¶

![EurekaæœåŠ¡ç»­çº¦æœºåˆ¶](assets\EurekaæœåŠ¡ç»­çº¦æœºåˆ¶.png)

#### 5. æœåŠ¡æ³¨é”€æœºåˆ¶

![EurekaæœåŠ¡æ³¨é”€æœºåˆ¶](assets\EurekaæœåŠ¡æ³¨é”€æœºåˆ¶.png)

#### 6. æœåŠ¡å‰”é™¤æœºåˆ¶

![EurekaæœåŠ¡æ³¨é”€æœºåˆ¶](assets\EurekaæœåŠ¡æ³¨é”€æœºåˆ¶.png)

#### 7. æœåŠ¡è·å–æœºåˆ¶

![EurekaæœåŠ¡è·å–æœºåˆ¶](assets\EurekaæœåŠ¡è·å–æœºåˆ¶.png)

#### 8. æœåŠ¡åŒæ­¥æœºåˆ¶

##### 1. å¯åŠ¨æ—¶åŒæ­¥

![EurekaæœåŠ¡åŒæ­¥æœºåˆ¶ä¹‹å¯åŠ¨æ—¶åŒæ­¥](assets\EurekaæœåŠ¡åŒæ­¥æœºåˆ¶ä¹‹å¯åŠ¨æ—¶åŒæ­¥.png)



##### 2. è¿è¡Œæ—¶åŒæ­¥

![EurekaæœåŠ¡åŒæ­¥æœºåˆ¶ä¹‹è¿è¡Œæ—¶åŒæ­¥](assets\EurekaæœåŠ¡åŒæ­¥æœºåˆ¶ä¹‹è¿è¡Œæ—¶åŒæ­¥.png)



## [IoC](https://javadoop.com/post/spring-ioc#toc_1)

**IoCå®¹å™¨ç”¨æ¥ç®¡ç†è¢«æ³¨è§£æ ‡æ³¨çš„ç±»çš„å®ä¾‹ï¼Œåœ¨ç¨‹åºéœ€è¦ç”¨å¾—åˆ°çš„æ—¶å€™ï¼Œè¿”å›å¯¹åº”çš„å®ä¾‹**

![1600333512928](assets\IoCå®¹å™¨çš„ä½œç”¨.png)

### æµç¨‹

![1600418386948](assets\SpringIoCæµç¨‹.png)

#### 1. åˆ›å»ºBeanå‰çš„å‡†å¤‡

##### â‘  prepareRefresh()

å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦ï¼›

#### 2. (æœ€é‡è¦)åŠ è½½å¹¶æ³¨å†ŒBean: `obtainFreshBeanFactory()`

* è¿™ä¸€æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼š**è§£æ**æˆä¸€ä¸ªä¸ª`Bean`å®šä¹‰ï¼Œæ³¨å†Œåˆ°`BeanFactory`ä¸­çš„`beanDefinitionMap`ï¼›

```java
private final Map<String, BeanDefinition> beanDefinitionMap = new ConcurrentHashMap(256);
```

* æ­¤æ—¶ï¼ŒBean**è¿˜æ²¡æœ‰åˆå§‹åŒ–**ï¼Œåªæ˜¯**é…ç½®ä¿¡æ¯éƒ½æå–**å‡ºæ¥äº†

1. å…³é—­æ—§çš„ `BeanFactory `(å¦‚æœæœ‰)ï¼Œåˆ›å»ºæ–°çš„ BeanFactoryï¼ŒåŠ è½½ Bean å®šä¹‰ã€æ³¨å†Œ Bean ç­‰ç­‰ï¼›
2. è¿”å›åˆšåˆšåˆ›å»ºçš„`BeanFactory`ï¼›

![1600449643134](assets\SpringIoCä¹‹åŠ è½½å¹¶æ³¨å†ŒBean.png)

##### refreshBeanFactory()

1. å¦‚æœå½“å‰`ApplicationContext`åŠ è½½è¿‡`BeanFactory`ï¼Œå°±é”€æ¯æ‰€æœ‰`Bean`ï¼Œå…³é—­`BeanFactory`ï¼›
2. åˆå§‹åŒ–ä¸€ä¸ª`DefaultListableBeanFactory beanFactory = createBeanFactory()`ï¼›
3. è®¾ç½® BeanFactory çš„ä¸¤ä¸ªé…ç½®å±æ€§ï¼šæ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨`customizeBeanFactory(beanFactory)`ï¼›
4. æ ¹æ®é…ç½®ï¼ŒåŠ è½½ Bean åˆ° BeanFactory ä¸­`loadBeanDefinitions(beanFactory)`;

##### customizeBeanFactory(beanFactory)

* é…ç½®æ˜¯å¦å…è®¸ BeanDefinition è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨ï¼›
* è¦†ç›–ï¼šå®šä¹‰ bean æ—¶ä½¿ç”¨äº†**ç›¸åŒçš„ id æˆ– name**ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullï¼Œå¦‚æœåœ¨**åŒä¸€é…ç½®æ–‡ä»¶**ä¸­é‡å¤äº†ï¼Œä¼š**æŠ›é”™**ï¼Œä½†æ˜¯å¦‚æœ**ä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶**ä¸­ï¼Œä¼šå‘ç”Ÿ**è¦†ç›–**ï¼›
* é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring å…è®¸å¾ªç¯ä¾èµ–ï¼›

##### loadBeanDefinitions(beanFactory)

* è§£æXMLé…ç½®æ–‡ä»¶ï¼Œæˆ–è€…æ‰«æåŒ…è·¯å¾„ä¸‹çš„ç±»ï¼Œå¹¶é€šè¿‡åå°„è·å–è¢«æ ‡æ³¨çš„é…ç½®ç±»ä¸­çš„ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨åˆå§‹åŒ–é˜¶æ®µè£…é…åˆ°`Bean`ä¸­ï¼›

#### 3. åˆå§‹åŒ–å‰çš„å·¥ä½œ

##### â‘¢ prepareBeanFactory(beanFactory)

è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ beanï¼›

##### â‘£ postProcessBeanFactory(beanFactory)

è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œ**æ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆ**äº†ï¼Œä½†æ˜¯éƒ½è¿˜**æ²¡æœ‰åˆå§‹åŒ–**ï¼›

##### â‘¤ invokeBeanFactoryPostProcessors(beanFactory)

è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) æ–¹æ³•ï¼›

##### â‘¥ registerBeanPostProcessors(beanFactory)

æ³¨å†Œ `BeanPostProcessor `çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ `BeanFactoryPostProcessor `çš„åŒºåˆ«ï¼›
		æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: `postProcessBeforeInitialization` å’Œ `postProcessAfterInitialization`ï¼›
 		ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚æ³¨æ„ï¼Œåˆ°è¿™é‡Œ Bean è¿˜æ²¡åˆå§‹åŒ–ï¼›

##### å›½é™…åŒ–å’Œäº‹ä»¶å¹¿æ’­

##### â‘¦ onRefresh()

* é’©å­æ–¹æ³•ï¼›
* å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰ï¼›

#### 4. Beançš„åˆå§‹åŒ–

* åœ¨è¿™åˆå§‹åŒ–å‰ï¼Œ`BeanFactory`å·²ç»åˆ›å»ºå®Œæˆï¼Œå¹¶ä¸”æ‰€æœ‰çš„å®ç°äº† `BeanFactoryPostProcessor`æ¥å£çš„éœ€è¦å‰ç½®å¤„ç†çš„ `Bean` éƒ½å·²ç»åˆå§‹åŒ–ï¼Œ Spring å·²ç»â€œæ‰‹åŠ¨â€æ³¨å†Œäº†ä¸€äº›ä¸ç¯å¢ƒå’Œç³»ç»Ÿå±æ€§ç­‰æœ‰å…³çš„ç‰¹æ®Š Beanï¼Œå¦‚ `environment`ã€`systemProperties` ç­‰ã€‚

![1600427896218](assets\åˆå§‹åŒ–Beanæµç¨‹.png)

##### â‘§ finishBeanFactoryInitialization(beanFactory)

* åˆå§‹åŒ–æ‰€æœ‰çš„ `singleton beans`ï¼ˆ**lazy-inité™¤å¤–**ï¼‰;
* åˆå§‹åŒ–çš„åŠ¨ä½œåŒ…è£…åœ¨`beanFactory.getBean(...) `ä¸­ï¼›

1. é€šè¿‡`this.beanDefinitionNames`è·å–æ‰€æœ‰çš„`beanNames`ï¼›
2. åœ¨å¾ªç¯ä¸­ï¼Œæ ¹æ®`beanName`åˆå§‹åŒ–æ‰€æœ‰**éæ‡’åŠ è½½**çš„`singleton beans`ï¼›

###### 1. getBean(BeanName)

```java
public Object getBean(String name) throws BeansException {
   return doGetBean(name, null, null, false);
}
```

###### 2. doGetBean()

1. æ ¹æ®`beanName`æ£€æŸ¥æ˜¯å¦å·²ç»åˆ›å»ºè¿‡äº†ï¼›

   ~~~java
   Object sharedInstance = getSingleton(beanName);
   ~~~

2. å¦‚æœå·²ç»åˆ›å»ºå¹¶ä¸”`args`ä¸ä¸ºç©ºï¼Œå°±è·å–è¿™ä¸ª`bean`ï¼›

3.  å¦åˆ™å°±åˆ›å»ºæ–°çš„`bean`ï¼›

4. å¦‚æœå­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™å°±å…ˆæ³¨å†Œä¾èµ–å…³ç³»ï¼Œå¹¶åˆå§‹åŒ–è¢«ä¾èµ–çš„`bean`ï¼›

5. åˆ›å»º`bean`ï¼Œ`createBean(beanName, mbd, args)`ï¼›

###### 3. createBean()

1. ç¡®ä¿ BeanDefinition ä¸­çš„ Class è¢«åŠ è½½ï¼›

~~~java
Class<?> resolvedClass = resolveBeanClass(mbd, beanName);
if (resolvedClass != null && !mbd.hasBeanClass() && mbd.getBeanClassName() != null) {
	mbdToUse = new RootBeanDefinition(mbd);
	mbdToUse.setBeanClass(resolvedClass);
}
~~~

2. åˆ›å»º`bean`ï¼Œ`Object beanInstance = doCreateBean(beanName, mbdToUse, args)`

###### 4. (è§£å†³å¾ªç¯ä¾èµ–)doCreateBean()

1. åˆ¤æ–­`beanName`æ˜¯ä¸æ˜¯`FactoryBean`ï¼Œä¸æ˜¯å°±å»**åˆå§‹åŒ–`bean`ï¼š`createBeanInstance()`**ï¼›

   ```java
   // Instantiate the bean.
   BeanWrapper instanceWrapper = null;
   if (mbd.isSingleton()) {
       instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);
   }
   if (instanceWrapper == null) {
       // è¯´æ˜ä¸æ˜¯ FactoryBeanï¼Œè¿™é‡Œå®ä¾‹åŒ– Beanï¼Œè¿™é‡Œéå¸¸å…³é”®ï¼Œç»†èŠ‚ä¹‹åå†è¯´
       instanceWrapper = createBeanInstance(beanName, mbd, args);
   }
   ```

2. **è§£å†³å¾ªç¯ä¾èµ–**ï¼Œå°†`bean`æ”¾å…¥ä¸‰çº§ç¼“å­˜ä¸­ï¼›

   ```java
   this.addSingletonFactory(beanName, () -> {
       return this.getEarlyBeanReference(beanName, mbd, bean);
   });
   ```

   ![1589340629038](assets\å¾ªç¯ä¾èµ–è§£å†³æ–¹æ¡ˆ.png)

   â€‹		**Aåœ¨æ‰§è¡Œ`populateBean()`ä¹‹å‰ä¼šé€šè¿‡`addSingletonFactory` æ”¾å…¥ä¸‰çº§ç¼“å­˜ä¸­ï¼Œå½“Aè¦è£…é…Bï¼ŒBä¹Ÿè¦è£…é…Aæ—¶ï¼Œä¼šå†æ¬¡å»è·å–Aï¼Œæ­¤æ—¶å°±é€šè¿‡`getSingleton`è¿›å…¥åˆ°ä¸‰çº§ç¼“å­˜ä¸­ï¼Œé€šè¿‡`singletonFactory.getObject()`è·å¾—Açš„å®ä¾‹ï¼Œç„¶åæ”¾å…¥äºŒçº§ç¼“å­˜ï¼Œå¹¶æ¸…é™¤ä¸‰çº§ç¼“å­˜ï¼ŒBæ‹¿åˆ°Aå°±æ‰§è¡Œ`populateBean()`åé¢çš„é€»è¾‘ï¼Œæœ€ç»ˆå¾—åˆ°å®Œå¤‡çš„Bï¼Œå¹¶æ”¾å…¥ä¸€çº§ç¼“å­˜ï¼Œè¡¨æ˜å½»åº•å®Œæˆå®ä¾‹Bçš„åˆ›å»ºï¼Œç„¶åè¿”å›ç»™Aï¼Œæœ€ç»ˆAä¹Ÿå®Œæˆäº†å®ä¾‹åŒ–ã€‚**

   * `prototype`å¾ªç¯ä¾èµ–æ— æ³•è§£å†³ï¼Œå› ä¸ºSpringå®¹å™¨ä¸å¯¹`prototype`è¿›è¡Œç¼“å­˜ï¼Œå› æ­¤æ— æ³•æå‰æš´éœ²ä¸€ä¸ªåˆ›å»ºä¸­çš„Beanï¼›ä½†`prototype`å’Œ`singleton`çš„å¾ªç¯ä¾èµ–å¯ä»¥è§£å†³ï¼›

   * ç”±äºè§£å†³çš„æ—¶å€™ï¼ŒAå¯¹è±¡å·²ç»åˆ›å»ºå‡ºæ¥(**è°ƒç”¨äº†æ„é€ å™¨**)ï¼Œå¦‚æœæ˜¯**æ„é€ å™¨çš„å¾ªç¯ä¾èµ–**ï¼ŒSpringè‡ªèº«æ˜¯æ— æ³•è§£å†³çš„ï¼Œå¯ä»¥åœ¨æ„é€ æ–¹æ³•çš„å‚æ•°å‰åŠ ä¸Š`@Lazy`å®ç°å»¶è¿ŸåŠ è½½æ¥è§£å†³æ­¤é—®é¢˜:
     * å‘ç°éœ€è¦B,æŸ¥è¯¢å­—æ®µbçš„æ‰€æœ‰æ³¨è§£,å‘ç°æœ‰`@lazy`æ³¨è§£,é‚£ä¹ˆå°±**ä¸ç›´æ¥åˆ›å»ºB**äº†,è€Œæ˜¯ä½¿ç”¨åŠ¨æ€ä»£ç†åˆ›å»ºä¸€ä¸ª**ä»£ç†ç±»B**ï¼›

   ~~~java
   @Component
   public class CircularDepencyA {
    
       private CircularDepB circB;
    
       @Autowired
       public CircularDepA(@Lazy CircularDepB circB) {
           this.circB = circB;
       }
   }
   ~~~

   

3. åˆå§‹åŒ–`bean`çš„å®ä¾‹ï¼›

   1. å±æ€§è£…é…ï¼š`populateBean(beanName, mbd, instanceWrapper)`ï¼›
   2. å¤„ç† bean åˆå§‹åŒ–å®Œæˆåçš„å„ç§å›è°ƒï¼š`initializeBean(beanName, exposedObject, mbd)`ï¼›

##### â‘¨ finishRefresh()

æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆï¼›

#### å¼‚å¸¸å¤„ç†

```java
// Destroy already created singletons to avoid dangling resources.
// é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº
destroyBeans();

// Reset 'active' flag.
cancelRefresh(ex);

// æŠŠå¼‚å¸¸å¾€å¤–æŠ›
throw ex;
```

#### â‘© resetCommonCaches()

* åœ¨`finally{}`ä¸­ï¼›
* ç¼“å­˜æ¸…é™¤ï¼›

#### `singleton`å’Œ`prototype`

å½“ä½ éœ€è¦**å…¨å±€çš„å”¯ä¸€æ ‡è¯†**çš„æ—¶å€™å¯ä»¥ç”¨singleton,è€Œä¸”singletonåªåˆ›å»ºä¸€ä¸ªå¯¹è±¡,ç³»ç»Ÿæ¶ˆè€—èµ„æºå°.ä½†æ˜¯ç”¨**singletonå¯èƒ½ä¼šæœ‰çº¿ç¨‹å®‰å…¨çš„é—®é¢˜**ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°prototype ã€‚**è€ƒè™‘å¹¶å‘çš„é—®é¢˜ï¼Œå»ºè®®éƒ½ç”¨prototype**ã€‚

## AOP

### åŠ¨æ€ä»£ç†

* ä»£ç†æ¨¡å¼ï¼šä½¿ç”¨**ä»£ç†å¯¹è±¡æ¥ä»£æ›¿å¯¹çœŸå®å¯¹è±¡(real object)çš„è®¿é—®**ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨**ä¸ä¿®æ”¹åŸç›®æ ‡å¯¹è±¡**çš„å‰æä¸‹ï¼Œæä¾›é¢å¤–çš„åŠŸèƒ½æ“ä½œï¼Œæ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚
* é™æ€ä»£ç†ï¼šåœ¨ç¼–è¯‘æ—¶å°±å°†æ¥å£ã€å®ç°ç±»ã€ä»£ç†ç±»è¿™äº›éƒ½å˜æˆäº†ä¸€ä¸ªä¸ªå®é™…çš„ class æ–‡ä»¶ã€‚
  * ç¼ºç‚¹ï¼šå¯¹ç›®æ ‡å¯¹è±¡çš„**æ¯ä¸ªæ–¹æ³•**çš„å¢å¼ºéƒ½æ˜¯æ‰‹åŠ¨å®Œæˆçš„ï¼Œ**éå¸¸ä¸çµæ´»**ï¼ˆ_æ¯”å¦‚æ¥å£ä¸€æ—¦æ–°å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡å’Œä»£ç†å¯¹è±¡éƒ½è¦è¿›è¡Œä¿®æ”¹_ï¼‰ï¼›
* åŠ¨æ€ä»£ç†ï¼šä» JVM è§’åº¦æ¥è¯´ï¼ŒåŠ¨æ€ä»£ç†æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆç±»å­—èŠ‚ç ï¼Œå¹¶åŠ è½½åˆ° JVM ä¸­çš„ï¼›
  * ä¼˜ç‚¹ï¼šæ›´åŠ çµæ´»ï¼Œä¸éœ€è¦é’ˆå¯¹æ¯ä¸ªç›®æ ‡ç±»éƒ½å•ç‹¬åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œå¹¶ä¸”ä¹Ÿä¸æ˜¯è¦å¿…é¡»å®ç°æ¥å£ï¼Œå¯ä»¥ç›´æ¥ä»£ç†å®ç°ç±»ï¼›

#### JDKåŠ¨æ€ä»£ç†

**åœ¨ Java åŠ¨æ€ä»£ç†æœºåˆ¶ä¸­ InvocationHandler æ¥å£å’Œ Proxy ç±»æ˜¯æ ¸å¿ƒã€‚**

* ä½¿ç”¨æ­¥éª¤ï¼š

  1. è‡ªå®šä¹‰ä¸€ä¸ªJDKåŠ¨æ€ä»£ç†æ¥å£åŠå…¶å®ç°ç±»ï¼›

  2. ç„¶åå»å®ç°`InvocationHandler `ï¼Œå¹¶é‡å†™`invoke()`ï¼›

     * **é€šè¿‡Proxy ç±»çš„ newProxyInstance() åˆ›å»ºçš„ä»£ç†å¯¹è±¡åœ¨è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…ä¼šè°ƒç”¨åˆ°å®ç°InvocationHandler æ¥å£çš„ç±»çš„ invoke()æ–¹æ³•ã€‚** å¯ä»¥åœ¨ `invoke()` æ–¹æ³•ä¸­è‡ªå®šä¹‰å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚åœ¨æ–¹æ³•æ‰§è¡Œå‰ååšä»€ä¹ˆäº‹æƒ…ã€‚

     ```java
     public interface InvocationHandler {
     
         /**
          * å½“ä½ ä½¿ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•çš„æ—¶å€™å®é™…ä¼šè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•
          * @param proxy   åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»
     	 * @param method  ä¸ä»£ç†ç±»å¯¹è±¡è°ƒç”¨çš„æ–¹æ³•ç›¸å¯¹åº”
     	 * @param args 	  å½“å‰ method æ–¹æ³•çš„å‚æ•°
          */
         public Object invoke(Object proxy, Method method, Object[] args)
             throws Throwable;
     }
     ```

  3. å°†è‡ªå®šä¹‰çš„ä»£ç†ç±»ä½œä¸º`Proxy.newProxyInstance(ClassLoader loader,Class<?>[] interfaces,InvocationHandler h)`çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè¯¥æ–¹æ³•ä¼š**åˆ›å»ºä»£ç†å¯¹è±¡**ï¼›

  4. è·å–ä»£ç†å¯¹è±¡ï¼šè·å–ä»£ç†å¯¹è±¡çš„å·¥å‚ç±»

     ```java
     public class JdkProxyFactory {
         public static Object getProxy(Object target) {
             return Proxy.newProxyInstance(
                     target.getClass().getClassLoader(), // ç›®æ ‡ç±»çš„ç±»åŠ è½½
                 	// ä»£ç†éœ€è¦å®ç°çš„æ¥å£ï¼Œå¯æŒ‡å®šå¤šä¸ª
                     target.getClass().getInterfaces(),  
                	 	// ä»£ç†å¯¹è±¡å¯¹åº”çš„è‡ªå®šä¹‰ InvocationHandler
                     new DebugInvocationHandler(target)   
             );
         }
     }
     ```

  5. ä½¿ç”¨

     ```java
     SmsService smsService = (SmsService) JdkProxyFactory.getProxy(new SmsServiceImpl());
     smsService.send("java");
     ```

* ç¼ºç‚¹ï¼šåªèƒ½ä»£ç†**å®ç°äº†æ¥å£çš„ç±»**ï¼Œç”¨CGLIBæœºåˆ¶æ¥é¿å…ï¼›

#### CGLIBåŠ¨æ€ä»£ç†

**[CGLIB](https://github.com/cglib/cglib)(*Code Generation Library*)æ˜¯ä¸€ä¸ªåŸºäº[ASM](http://www.baeldung.com/java-asm)çš„å­—èŠ‚ç ç”Ÿæˆåº“ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨è¿è¡Œæ—¶å¯¹å­—èŠ‚ç è¿›è¡Œä¿®æ”¹å’ŒåŠ¨æ€ç”Ÿæˆã€‚**CGLIB é€šè¿‡**ç»§æ‰¿æ–¹å¼**å®ç°ä»£ç†ã€‚

**åœ¨ CGLIB åŠ¨æ€ä»£ç†æœºåˆ¶ä¸­ MethodInterceptor æ¥å£å’Œ Enhancer ç±»æ˜¯æ ¸å¿ƒã€‚**

* ä½¿ç”¨æ­¥éª¤ï¼š

  1. è‡ªå®šä¹‰ä¸€ä¸ªç±»ï¼›

  2. ç„¶åå»å®ç°æ–¹æ³•æ‹¦æˆªå™¨`MethodInterceptor`ï¼Œå¹¶é‡å†™`intercept()`ï¼Œè·Ÿ`invoke()`ç±»ä¼¼ï¼›

     ```java
     public interface MethodInterceptor
     extends Callback{
         // æ‹¦æˆªè¢«ä»£ç†ç±»ä¸­çš„æ–¹æ³•
         /**
          * @param obj         è¢«ä»£ç†çš„å¯¹è±¡ï¼ˆéœ€è¦å¢å¼ºçš„å¯¹è±¡ï¼‰
          * @param method      è¢«æ‹¦æˆªçš„æ–¹æ³•ï¼ˆéœ€è¦å¢å¼ºçš„æ–¹æ³•ï¼‰
          * @param args        æ–¹æ³•å…¥å‚
          * @param methodProxy ç”¨äºè°ƒç”¨åŸå§‹æ–¹æ³•
          */
         public Object intercept(Object obj, java.lang.reflect.Method method, Object[] args,
                                    MethodProxy proxy) throws Throwable;
     }
     ```

  3. è·å–ä»£ç†ç±»ï¼›

     ```java
     import net.sf.cglib.proxy.Enhancer;
     
     public class CglibProxyFactory {
     
         public static Object getProxy(Class<?> clazz) {
             // åˆ›å»ºåŠ¨æ€ä»£ç†å¢å¼ºç±»
             Enhancer enhancer = new Enhancer();
             // è®¾ç½®ç±»åŠ è½½å™¨
             enhancer.setClassLoader(clazz.getClassLoader());
             // è®¾ç½®è¢«ä»£ç†ç±»
             enhancer.setSuperclass(clazz);
             // è®¾ç½®æ–¹æ³•æ‹¦æˆªå™¨
             enhancer.setCallback(new DebugMethodInterceptor());
             // åˆ›å»ºä»£ç†ç±»
             return enhancer.create();
         }
     }
     ```

  4. ä½¿ç”¨ï¼›

     ```java
     AliSmsService aliSmsService = (AliSmsService) CglibProxyFactory.getProxy(AliSmsService.class);
     aliSmsService.send("java");
     ```

#### JDK åŠ¨æ€ä»£ç†å’Œ CGLIB åŠ¨æ€ä»£ç†å¯¹æ¯”

1. **JDK åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†å®ç°äº†æ¥å£çš„ç±»ï¼Œè€Œ CGLIB å¯ä»¥ä»£ç†æœªå®ç°ä»»ä½•æ¥å£çš„ç±»ã€‚** å¦å¤–ï¼Œ CGLIB åŠ¨æ€ä»£ç†æ˜¯é€šè¿‡ç”Ÿæˆä¸€ä¸ªè¢«ä»£ç†ç±»çš„å­ç±»æ¥æ‹¦æˆªè¢«ä»£ç†ç±»çš„æ–¹æ³•è°ƒç”¨ï¼Œå› æ­¤**ä¸èƒ½ä»£ç†å£°æ˜ä¸º final ç±»å‹çš„ç±»å’Œæ–¹æ³•**ã€‚
2. å°±äºŒè€…çš„**æ•ˆç‡**æ¥è¯´ï¼Œå¤§éƒ¨åˆ†æƒ…å†µéƒ½æ˜¯ **JDK åŠ¨æ€ä»£ç†æ›´ä¼˜ç§€**ï¼Œéšç€ JDK ç‰ˆæœ¬çš„å‡çº§ï¼Œè¿™ä¸ªä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ã€‚

## SpringBoot

* ç†å¿µï¼š**çº¦å®šä¼˜äºé…ç½®**

### è‡ªåŠ¨è£…é…

* å®ç°ï¼šä½¿ç”¨`@SpringBootApplication `ï¼›
* ç‰¹ç‚¹ï¼š
  1. å†…åµŒ`servlet`å®¹å™¨ï¼Œåº”ç”¨æ— éœ€æ‰“åŒ…æˆwaræ ¼å¼ï¼Œå¯ä»¥ç›´æ¥ä»¥jaræ ¼å¼è¿è¡Œï¼›
  2. æä¾›äº†å¤šä¸ªå¯é€‰æ‹©çš„starterä»¥ç®€åŒ–mavenä¾èµ–ç®¡ç†ï¼›
  3. æ— éœ€é…ç½®XMLé…ç½®æ–‡ä»¶ï¼Œå‡å°‘é…ç½®æ—¶é—´ï¼Œæé«˜å¼€å‘æ•ˆç‡ï¼›
  4. æä¾›äº†ä¸€æ•´å¥—å¯¹åº”ç”¨çŠ¶æ€çš„ç›‘æ§ä¸ç®¡ç†çš„åŠŸèƒ½æ¨¡å—ï¼ˆå¼•å…¥`spring-boot-starter-actuator`ï¼‰ï¼ŒåŒ…æ‹¬åº”ç”¨çš„çº¿ç¨‹ä¿¡æ¯ã€å†…å­˜ä¿¡æ¯ã€åº”ç”¨å¥åº·çŠ¶æ€ç­‰ï¼›

#### [åŸç†](https://sylvanassun.github.io/2018/01/08/2018-01-08-spring_boot_auto_configure/)

* `@Conditional`ï¼š`Spring4`æä¾›çš„æ–°ç‰¹æ€§ï¼Œæ ¹æ®ç‰¹å®šçš„æ¡ä»¶æ¥åˆ›å»º`Bean`ï¼š

  1. åœ¨`Spring`çš„é…ç½®æ–‡ä»¶ä¸­æ˜¯å¦è®¾ç½®äº†æŸä¸ªç‰¹å®šçš„å€¼ï¼›
  2. æ˜¯å¦å­˜åœ¨ç‰¹å®šçš„ç³»ç»Ÿå±æ€§ï¼›
  3. åœ¨`Spring`å®¹å™¨ä¸­æ˜¯å¦å·²ç»æ³¨å†Œäº†æŸç§ç±»å‹çš„`Bean`ï¼Œæ²¡æœ‰å°±æ³¨å†Œåˆ°å®¹å™¨ï¼›
  4. åœ¨ç±»è·¯å¾„ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„ç±»ï¼Œæ²¡æœ‰å°±æ³¨å†Œåˆ°å®¹å™¨ï¼›

  **è‡ªå®šä¹‰æ¡ä»¶ç±»é€šè¿‡å®ç°`Condition`æ¥å£ï¼Œç„¶ååŠ å…¥åˆ°é…ç½®ç±»ä¸­ï¼Œå¹¶åœ¨é…ç½®ç±»ä¸Šå£°æ˜`@Conditional`ï¼Œæœ€åå¯ä»¥æ ¹æ®è‡ªå®šä¹‰çš„æ¡ä»¶æ³¨å†Œåˆ°`Bean`ï¼›**

  ~~~java
  public class UserDAOBeanNotPresentsCondition implements Condition {
  	@Override
  	public boolean matches(ConditionContext conditionContext, AnnotatedTypeMetadata metadata) {
  		UserDAO userDAO = conditionContext.getBeanFactory().getBean(UserDAO.class);
  		return (userDAO == null);
  	}
  }
  ~~~

* `@SpringBootApplication`ï¼š`@Configuration` + **`@EnableAutoConfiguration`** + `@ComponentScan`;

  ![1600101289206](assets\springbootè‡ªåŠ¨è£…é…æµç¨‹.png)





# MySQL

## æ•°æ®åº“è®¾è®¡

### 1. [åˆ†åº“åˆ†è¡¨](https://blog.csdn.net/weixin_44062339/article/details/100491744)

#### å‚ç›´åˆ†è¡¨

* å®šä¹‰ï¼šå¯ä»¥æŠŠä¸€ä¸ªå®½è¡¨çš„å­—æ®µæŒ‰è®¿é—®é¢‘æ¬¡ã€æ˜¯å¦æ˜¯**å¤§å­—æ®µ**çš„åŸåˆ™æ‹†åˆ†ä¸ºå¤šä¸ªè¡¨ï¼Œæ¯ä¸ªè¡¨å­˜å‚¨å…¶ä¸­ä¸€éƒ¨åˆ†å­—æ®µï¼›
* åœºæ™¯ï¼šç³»ç»Ÿç»å¯¹**å¹¶å‘é‡å¹¶æ²¡æœ‰ä¸Šæ¥ï¼Œè¡¨çš„è®°å½•å¹¶ä¸å¤š**ï¼Œä½†æ˜¯**å­—æ®µå¤š**ï¼Œå¹¶ä¸”**çƒ­ç‚¹æ•°æ®å’Œéçƒ­ç‚¹æ•°æ®åœ¨ä¸€èµ·**ï¼Œ**å•è¡Œæ•°æ®æ‰€éœ€çš„å­˜å‚¨ç©ºé—´è¾ƒå¤§ã€‚ä»¥è‡³äºæ•°æ®åº“ç¼“å­˜çš„æ•°æ®è¡Œå‡å°‘**ï¼ŒæŸ¥è¯¢æ—¶ä¼šå»è¯»ç£ç›˜æ•°æ®äº§ç”Ÿå¤§é‡çš„éšæœºè¯»IOï¼Œäº§ç”ŸIOç“¶é¢ˆã€‚
  * ä¸ºä»€ä¹ˆå¤§å­—æ®µIOæ•ˆç‡ä½ï¼š
    1. ç”±äºæ•°æ®é‡æœ¬èº«å¤§ï¼Œéœ€è¦æ›´é•¿çš„è¯»å–æ—¶é—´ï¼›
    2. è·¨é¡µï¼Œ**é¡µæ˜¯æ•°æ®åº“å­˜å‚¨å•ä½**ï¼Œå¾ˆå¤šæŸ¥æ‰¾åŠå®šä½æ“ä½œéƒ½æ˜¯ä»¥é¡µä¸ºå•ä½ï¼Œå•é¡µå†…çš„æ•°æ®è¡Œè¶Šå¤šæ•°æ®åº“æ•´ä½“æ€§èƒ½è¶Šå¥½ï¼Œè€Œå¤§å­—æ®µå ç”¨ç©ºé—´å¤§ï¼Œ**å•é¡µå†…å­˜å‚¨è¡Œæ•°å°‘ï¼Œå› æ­¤IOæ•ˆç‡è¾ƒä½**ã€‚
    3. **æ•°æ®åº“ä»¥è¡Œä¸ºå•ä½å°†æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­**ï¼Œè¿™æ ·è¡¨ä¸­å­—æ®µé•¿åº¦è¾ƒçŸ­ä¸”è®¿é—®é¢‘ç‡è¾ƒé«˜ï¼Œå†…å­˜èƒ½åŠ è½½æ›´å¤šçš„æ•°æ®ï¼Œ**å‘½ä¸­ç‡æ›´é«˜ï¼Œå‡å°‘äº†ç£ç›˜IO**ï¼Œä»è€Œæå‡äº†æ•°æ®åº“æ€§èƒ½ã€‚
* ç»“æœï¼š
  * æ¯ä¸ª**è¡¨**çš„**ç»“æ„**éƒ½ä¸ä¸€æ ·ï¼›
  * æ¯ä¸ª**è¡¨**çš„**æ•°æ®**ä¹Ÿä¸ä¸€æ ·ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªè¡¨çš„**å­—æ®µ**è‡³å°‘æœ‰ä¸€åˆ—äº¤é›†ï¼Œä¸€èˆ¬æ˜¯ä¸»é”®ï¼Œç”¨äº**å…³è”æ•°æ®**ï¼›
  * æ‰€æœ‰**è¡¨**çš„**å¹¶é›†**æ˜¯å…¨é‡æ•°æ®ï¼›
* æå‡ï¼šä½¿ä¸šåŠ¡æ¸…æ™°ï¼Œæå‡éƒ¨åˆ†æ€§èƒ½ï¼›
* ç¼ºé™·ï¼šå°½é‡ä»ä¸šåŠ¡è§’åº¦**é¿å…è”æŸ¥**ï¼Œå¦åˆ™æ€§èƒ½æ–¹é¢å°†å¾—ä¸å¿å¤±ï¼›

#### å‚ç›´åˆ†åº“

* å®šä¹‰ï¼šæŒ‰ç…§ä¸šåŠ¡å°†è¡¨è¿›è¡Œåˆ†ç±»ï¼Œåˆ†å¸ƒåˆ°ä¸åŒçš„æ•°æ®åº“ä¸Šï¼Œæ¯ä¸ªåº“å¯ä»¥æ”¾åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯**ä¸“åº“ä¸“ç”¨**ï¼›
* åœºæ™¯ï¼šç³»ç»Ÿç»å¯¹å¹¶å‘é‡ä¸Šæ¥äº†ï¼Œå¹¶ä¸”å¯ä»¥æŠ½è±¡å‡ºå•ç‹¬çš„ä¸šåŠ¡æ¨¡å—ï¼›
* ç»“æœï¼š
  * æ¯ä¸ª**åº“**çš„**ç»“æ„**éƒ½ä¸ä¸€æ ·ï¼›
  * æ¯ä¸ª**åº“**çš„**æ•°æ®**ä¹Ÿä¸ä¸€æ ·ï¼Œæ²¡æœ‰äº¤é›†ï¼›
  * æ‰€æœ‰**åº“**çš„**å¹¶é›†**æ˜¯å…¨é‡æ•°æ®ï¼›
* æå‡ï¼šå¤šä¸ªæœåŠ¡å™¨å…±åŒè´Ÿè½½ï¼Œå¤§å¤§æå‡æ€§èƒ½ï¼Œè¿˜èƒ½æé«˜æ•´ä½“æ¶æ„çš„ä¸šåŠ¡æ¸…æ™°åº¦ï¼Œä¸åŒçš„ä¸šåŠ¡åº“å¯æ ¹æ®è‡ªèº«æƒ…å†µå®šåˆ¶ä¼˜åŒ–æ–¹æ¡ˆï¼›
* ç¼ºé™·ï¼šéœ€è¦è§£å†³è·¨åº“å¸¦æ¥çš„å¤æ‚é—®é¢˜ï¼Œ**é¿å…è·¨åº“è”æŸ¥**ï¼›

#### æ°´å¹³åˆ†åº“

* å®šä¹‰ï¼šæŠŠåŒä¸€ä¸ªè¡¨çš„æ•°æ®æŒ‰ä¸€å®šè§„åˆ™æ‹†åˆ†åˆ°ä¸åŒçš„æ•°æ®åº“ä¸­ï¼Œæ¯ä¸ªåº“å¯ä»¥æ”¾åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼›
* åœºæ™¯ï¼šç³»ç»Ÿç»å¯¹å¹¶å‘é‡ä¸Šæ¥äº†ï¼Œåˆ†è¡¨éš¾ä»¥æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰æ˜æ˜¾çš„ä¸šåŠ¡å½’å±æ¥å‚ç›´åˆ†åº“ï¼›
* ç»“æœï¼š
  * æ¯ä¸ª**åº“**çš„**ç»“æ„**éƒ½ä¸€æ ·ï¼›
  * æ¯ä¸ª**åº“**çš„**æ•°æ®**éƒ½ä¸ä¸€æ ·ï¼Œæ²¡æœ‰äº¤é›†ï¼›
  * æ‰€æœ‰**åº“**çš„**å¹¶é›†**æ˜¯å…¨é‡æ•°æ®ï¼›
* æå‡ï¼šè§£å†³äº†å•åº“å¤§é‡çš„æ•°æ®å¯¹æœåŠ¡å™¨çš„å‹åŠ›ï¼›
* ç¼ºé™·ï¼šéœ€è¦è§£å†³è·¨åº“å¸¦æ¥çš„å¤æ‚é—®é¢˜ï¼Œä»¥åŠæ•°æ®è·¯ç”±é—®é¢˜

#### æ°´å¹³åˆ†è¡¨

* å®šä¹‰ï¼šåœ¨åŒä¸€ä¸ªæ•°æ®åº“å†…ï¼ŒæŠŠåŒä¸€ä¸ªè¡¨çš„æ•°æ®æŒ‰ä¸€å®šè§„åˆ™æ‹†åˆ°å¤šä¸ªè¡¨ä¸­ï¼›
* åœºæ™¯ï¼šç³»ç»Ÿç»å¯¹å¹¶å‘é‡å¹¶æ²¡æœ‰ä¸Šæ¥ï¼Œåªæ˜¯å•è¡¨çš„æ•°æ®é‡å¤ªå¤šï¼Œå½±å“äº†SQLæ•ˆç‡ï¼ŒåŠ é‡äº†CPUè´Ÿæ‹…ï¼Œä»¥è‡³äºæˆä¸ºç“¶é¢ˆï¼›
* ç»“æœï¼š
  - æ¯ä¸ª**è¡¨**çš„**ç»“æ„**éƒ½ä¸€æ ·ï¼›
  - æ¯ä¸ª**è¡¨**çš„**æ•°æ®**éƒ½ä¸ä¸€æ ·ï¼Œæ²¡æœ‰äº¤é›†ï¼›
  - æ‰€æœ‰**è¡¨**çš„**å¹¶é›†**æ˜¯å…¨é‡æ•°æ®ï¼›
* æå‡ï¼šæ€§èƒ½å°å¹…æå‡ï¼Œä»…ä»…æ˜¯å¯¹æ°´å¹³åˆ†åº“çš„ä¸€ä¸ªè¡¥å……ä¼˜åŒ–ï¼›
* ç¼ºé™·ï¼š

#### å¸¦æ¥çš„é—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆ

##### 1. ä¸»é”®ID

1. UUIDï¼šæœ¬åœ°ç”Ÿæˆï¼Œä½†æ˜¯å¤ªé•¿ï¼Œä½œä¸ºä¸»é”®æ€§èƒ½å¾ˆå·®ï¼Œè€Œä¸”ä¸å…·å¤‡æœ‰åºæ€§ï¼›

2. ç³»ç»Ÿå½“å‰æ—¶é—´+ç”¨æˆ·IDåå››ä½+éšæœºæ•°ï¼›

3. `twitter`çš„`snowflake`ç®—æ³•

   * æ ¸å¿ƒæ€æƒ³ï¼šä½¿ç”¨ä¸€ä¸ª 64 bit çš„ long å‹çš„**æ•°å­—**ä½œä¸ºå…¨å±€å”¯ä¸€ idã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åº”ç”¨ååˆ†å¹¿æ³›ï¼Œä¸”ID å¼•å…¥äº†æ—¶é—´æˆ³ï¼ŒåŸºæœ¬ä¸Šä¿æŒè‡ªå¢çš„ï¼›

   * ##### æ ¼å¼

     ![img](https://img2020.cnblogs.com/blog/813155/202005/813155-20200511162334239-459232117.png)

     - 1bit - é¦–ä½æ— æ•ˆç¬¦

     - 41bit - æ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰

       - 41ä½å¯ä»¥è¡¨ç¤º2^41^ -1ä¸ªæ•°å­—ï¼›
       - 2^41^ -1æ¯«ç§’ï¼Œæ¢ç®—æˆå¹´å°±æ˜¯è¡¨ç¤º 69 å¹´çš„æ—¶é—´

     - 10bit - å·¥ä½œæœºå™¨id

       - 5bit - datacenterIdæœºæˆ¿id
       - 5bit - workerIdæœºå™¨ id

     - 12bit - åºåˆ—å·

       åºåˆ—å·ï¼Œç”¨æ¥è®°å½•åŒä¸€ä¸ªdatacenterIdä¸­æŸä¸€ä¸ªæœºå™¨ä¸ŠåŒæ¯«ç§’å†…äº§ç”Ÿçš„ä¸åŒidï¼›

   * ##### ä¼˜ç‚¹

     - æ¯«ç§’æ•°åœ¨é«˜ä½ï¼Œè‡ªå¢åºåˆ—åœ¨ä½ä½ï¼Œæ•´ä¸ªIDéƒ½æ˜¯è¶‹åŠ¿é€’å¢çš„ã€‚
     - ä¸ä¾èµ–æ•°æ®åº“ç­‰ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œä»¥æœåŠ¡çš„æ–¹å¼éƒ¨ç½²ï¼Œç¨³å®šæ€§æ›´é«˜ï¼Œç”ŸæˆIDçš„æ€§èƒ½ä¹Ÿæ˜¯éå¸¸é«˜çš„ã€‚
     - å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹æ€§åˆ†é…bitä½ï¼Œéå¸¸çµæ´»ã€‚

     ##### ç¼ºç‚¹

     - é›ªèŠ±ç®—æ³•åœ¨å•æœºç³»ç»Ÿä¸ŠIDæ˜¯é€’å¢çš„ï¼Œä½†æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå¤šèŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„æ—¶é’Ÿå¹¶ä¸èƒ½ä¿è¯ä¸å®Œå…¨åŒæ­¥ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šå‡ºç°ä¸æ˜¯å…¨å±€é€’å¢çš„æƒ…å†µã€‚å¦‚æœç³»ç»Ÿæ—¶é—´è¢«å›è°ƒï¼Œæˆ–è€…æ”¹å˜ï¼Œå¯èƒ½ä¼šé€ æˆidå†²çªæˆ–è€…é‡å¤ã€‚

##### 2. è·¨åº“Joinçš„å‡ ç§è§£å†³æ€è·¯

1. å…¨å±€è¡¨
2. å­—æ®µå†—ä½™

## MyISAMå’ŒInnodbçš„åŒºåˆ«

1. **æ˜¯å¦æ”¯æŒè¡Œçº§é”** : MyISAM åªæœ‰**è¡¨çº§é”(**table-level locking)ï¼Œè€ŒInnoDB æ”¯æŒè¡Œçº§é”(row-level locking)å’Œè¡¨çº§é”,**é»˜è®¤ä¸ºè¡Œçº§é”**ã€‚
2. **æ˜¯å¦æ”¯æŒäº‹åŠ¡å’Œå´©æºƒåçš„å®‰å…¨æ¢å¤ï¼š MyISAM** å¼ºè°ƒçš„æ˜¯**æ€§èƒ½**ï¼Œ**æ¯æ¬¡æŸ¥è¯¢å…·æœ‰åŸå­æ€§**,å…¶æ‰§è¡Œé€Ÿåº¦æ¯”InnoDBç±»å‹æ›´å¿«ï¼Œä½†æ˜¯**ä¸æä¾›äº‹åŠ¡æ”¯æŒ**ã€‚ä½†æ˜¯**InnoDB** æä¾›äº‹åŠ¡æ”¯æŒäº‹åŠ¡ï¼Œå¤–éƒ¨é”®ç­‰é«˜çº§æ•°æ®åº“åŠŸèƒ½ã€‚ å…·æœ‰äº‹åŠ¡(commit)ã€å›æ»š(rollback)å’Œå´©æºƒä¿®å¤èƒ½åŠ›(crash recovery capabilities)çš„äº‹åŠ¡å®‰å…¨(transaction-safe (ACID compliant))å‹è¡¨ã€‚
   * InnoDBè¿™ç§è¡Œé”å®ç°ç‰¹ç‚¹æ„å‘³ç€ï¼šåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼ŒInnoDBæ‰ä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ï¼ŒInnoDBå°†ä½¿ç”¨è¡¨é”ï¼ï¼›
3. **æ˜¯å¦æ”¯æŒå¤–é”®ï¼š** MyISAMä¸æ”¯æŒï¼Œè€ŒInnoDBæ”¯æŒã€‚
4. **æ˜¯å¦æ”¯æŒMVCC** ï¼šä»… InnoDB æ”¯æŒã€‚åº”å¯¹é«˜å¹¶å‘äº‹åŠ¡, MVCCæ¯”å•çº¯çš„åŠ é”æ›´é«˜æ•ˆ;**MVCCåªåœ¨ `READ COMMITTED` å’Œ `REPEATABLE READ` ä¸¤ä¸ªéš”ç¦»çº§åˆ«ä¸‹å·¥ä½œ**;MVCCå¯ä»¥ä½¿ç”¨ ä¹è§‚(optimistic)é” å’Œ æ‚²è§‚(pessimistic)é”æ¥å®ç°;å„æ•°æ®åº“ä¸­MVCCå®ç°å¹¶ä¸ç»Ÿä¸€ã€‚

## ç´¢å¼•



## MVCC

MVCC (Multiversion Concurrency Control)ï¼Œå³**å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æŠ€æœ¯**,å®ƒä½¿å¾—å¤§éƒ¨åˆ†æ”¯æŒè¡Œé”çš„äº‹åŠ¡å¼•æ“ï¼Œä¸å†å•çº¯çš„ä½¿ç”¨è¡Œé”æ¥è¿›è¡Œæ•°æ®åº“çš„å¹¶å‘æ§åˆ¶ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æŠŠ**æ•°æ®åº“çš„è¡Œé”ä¸è¡Œçš„å¤šä¸ªç‰ˆæœ¬ç»“åˆèµ·æ¥**ï¼Œåªéœ€è¦å¾ˆå°çš„å¼€é”€,å°±å¯ä»¥å®ç°**éé”å®šè¯»**ï¼Œä»è€Œå¤§å¤§æé«˜æ•°æ®åº“ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚

* MVCCç‰¹ç‚¹ï¼š
  * **æ¯è¡Œ**æ•°æ®éƒ½å­˜åœ¨ä¸€ä¸ªç‰ˆæœ¬ï¼Œ**æ¯æ¬¡æ•°æ®æ›´æ–°æ—¶éƒ½æ›´æ–°è¯¥ç‰ˆæœ¬**
  * **ä¿®æ”¹æ—¶å¤åˆ¶**å‡ºå½“å‰ç‰ˆæœ¬éšæ„ä¿®æ”¹ï¼Œå„ä¸ªäº‹åŠ¡ä¹‹é—´æ— å¹²æ‰°
  * **ä¿å­˜æ—¶æ¯”è¾ƒ**ç‰ˆæœ¬å·ï¼Œå¦‚æœæˆåŠŸï¼ˆcommitï¼‰ï¼Œåˆ™è¦†ç›–åŸè®°å½•ï¼›å¤±è´¥åˆ™æ”¾å¼ƒå¤åˆ¶ï¼ˆrollbackï¼‰

  æ¯è¡Œéƒ½æœ‰ç‰ˆæœ¬å·ï¼Œä¿å­˜æ—¶æ ¹æ®ç‰ˆæœ¬å·å†³å®šæ˜¯å¦æˆåŠŸï¼Œå¬èµ·æ¥å«æœ‰**ä¹è§‚é”**çš„å‘³é“ï¼›

## è¿æ¥æ± 

* å¦‚æœä¸ç”¨æ•°æ®åº“è¿æ¥æ± ï¼Œä¸€æ¬¡sqlæŸ¥è¯¢è¯·æ±‚ä¼šç»è¿‡ä»¥ä¸‹æ­¥éª¤ï¼š
  1. å’Œ`MySQL server`å»ºç«‹`TCP`è¿æ¥ï¼š
     * ä¸‰æ¬¡æ¡æ‰‹ï¼›
  2. `MySQL`æƒé™è®¤è¯ï¼š
     1. `Server`å‘`Client`å‘é€å¯†é’¥ï¼›
     2. `Client`ä½¿ç”¨å¯†é’¥åŠ å¯†ç”¨æˆ·åã€å¯†ç ç­‰ä¿¡æ¯ï¼Œå°†åŠ å¯†åçš„æŠ¥æ–‡å‘é€ç»™`Server`ï¼›
     3. `Server`æ ¹æ®`Client`è¯·æ±‚åŒ…ï¼ŒéªŒè¯æ˜¯å¦æ˜¯åˆæ³•ç”¨æˆ·ï¼Œç„¶åç»™`Client`å‘é€è®¤è¯ç»“æœï¼›
  3. `Client`å‘é€`SQL`è¯­å¥ï¼›
  4. `Server`è¿”å›è¯­å¥æ‰§è¡Œç»“æœï¼›
  5. `MySQL`å…³é—­ï¼›
  6. `TCP`è¿æ¥æ–­å¼€ï¼›
     * å››æ¬¡æŒ¥æ‰‹ï¼›
* ä¸ä½¿ç”¨è¿æ¥æ± çš„è¯ï¼Œä¸ºäº†æ‰§è¡Œä¸€æ¡ SQLï¼Œä¼šèŠ±å¾ˆå¤šæ—¶é—´åœ¨**å®‰å…¨è®¤è¯ã€ç½‘ç»œIO**ä¸Šï¼Œå¦‚æœä½¿ç”¨è¿æ¥æ± ï¼Œæ‰§è¡Œä¸€æ¡ SQL **å°±çœå»äº†å»ºç«‹è¿æ¥å’Œæ–­å¼€è¿æ¥æ‰€éœ€çš„é¢å¤–å¼€é”€**ã€‚
* ç”¨`connection.close()`ä¸ä¼šç›´æ¥å…³æ‰è¿æ¥ï¼Œè€Œæ˜¯è¢«è¿æ¥æ± å›æ”¶ï¼Œå®ç°å¤ç”¨ï¼›

# [æ¶ˆæ¯é˜Ÿåˆ—](https://adjava.netlify.app/#/./docs/high-concurrency/why-mq)

- ä¸»è¦ä½¿ç”¨åœºæ™¯ï¼šè§£è€¦ã€å¼‚æ­¥ã€é™æµå‰Šå³°ï¼›

- ç¼ºç‚¹ï¼šç³»ç»Ÿå¯ç”¨æ€§é™ä½ï¼Œå¤æ‚åº¦æé«˜ï¼Œæœ‰æ¶ˆæ¯ä¸¢å¤±çš„é£é™©ï¼Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼šå¼ºä¸€è‡´æ€§å˜ä¸ºæœ€ç»ˆä¸€è‡´æ€§ï¼›

- ä¿è¯é«˜å¯ç”¨ï¼š1. ä¸»ä»ï¼›2. æ•°æ®åˆ†ç‰‡ä¿å­˜åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œé€‰ä¸€ä¸ªleaderèŠ‚ç‚¹ä¸æ¶ˆè´¹è€…å¯¹æ¥ï¼›

- ä¿è¯æ¶ˆæ¯ä¸è¢«**é‡å¤æ¶ˆè´¹**ï¼šæ¯ä¸ªæ¶ˆæ¯å¸¦æœ‰ä¸€ä¸ªoffsetï¼Œæ¶ˆè´¹è€…å®šæœŸæŠŠæ¶ˆè´¹è¿‡çš„offsetæäº¤ä¸Šå»ï¼Œä½†ç”±äºé‡å¯ã€å®•æœºç­‰é—®é¢˜ï¼Œä»å¯èƒ½å­˜åœ¨é‡å¤æ¶ˆè´¹ï¼›ä½†æœ€é‡è¦çš„æ˜¯ä¿æŒ**å¹‚ç­‰æ€§**ï¼Œä¸ç®¡æ•°æ®é‡å¤å¤šå°‘æ¬¡ï¼Œè¦ç¡®ä¿å¯¹åº”çš„æ•°æ®æ˜¯å”¯ä¸€çš„æˆ–è€…ä¸ä¼šæ”¹å˜çš„ã€‚

  - ä¿è¯å¹‚ç­‰æ€§ï¼š

    1. æ ¹æ®**ä¸»é”®æŸ¥è¯¢**ï¼Œæ˜¯å¦æ•°æ®å·²ç»å­˜åœ¨ï¼Œå­˜åœ¨å°±ä¸å¿…å†å†™å…¥ï¼›
    2. å†™å…¥Redisï¼Œ**å¤©ç„¶å¹‚ç­‰æ€§**ï¼›**(æ€ä¹ˆä¿è¯?)**
    3. æ¯æ¡æ•°æ®ä¸­ä¿å­˜ä¸€ä¸ª**å…¨å±€å”¯ä¸€Id**ï¼Œæ ¹æ®idå»redisä¸­æŸ¥æ‰¾ï¼Œæ²¡æœ‰å°±å†™å…¥ï¼Œæ¶ˆè´¹ï¼›æœ‰å°±ä¸å†æ¶ˆè´¹å¤„ç†åŒä¸€æ¡æ•°æ®ï¼›
    4. é€šè¿‡æ•°æ®åº“çš„**å”¯ä¸€é”®**ä¿è¯é‡å¤æ•°æ®ä¸ä¼šé‡å¤æ’å…¥å¤šæ¡ï¼›

    â€‹            

- ä¿è¯æ¶ˆæ¯**å¯é ä¼ è¾“**ï¼š

  1. ç”Ÿäº§è€…å¼„ä¸¢æ•°æ®ï¼š
     1. [rocketmq](https://blog.csdn.net/LO_YUN/article/details/101673893)ï¼š
        1. msg -> rocketmq (ä¸å¯è¢«æ¶ˆè´¹)ï¼Œå‘é€å¤±è´¥ï¼Œå›æ»šï¼›
        2. å‘é€æˆåŠŸï¼Œç”Ÿäº§è€…æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œå¤±è´¥åˆ™å›æ»šï¼›
        3. æ‰§è¡ŒæˆåŠŸï¼Œç”Ÿäº§è€…**è¿”å›ä¸€ä¸ªcommitçŠ¶æ€**ç»™rocketmqï¼Œå¦‚æœrocketmqè¿Ÿè¿Ÿæ”¶ä¸åˆ°è¿”å›çš„ç»“æœï¼Œè¿™æ¡æ¶ˆæ¯çŠ¶æ€å˜ä¸º**unkown**ï¼Œç„¶åå›è°ƒæœåŠ¡æ¥å£ï¼Œ**æŸ¥è¯¢**è¿™æ¡æ¶ˆæ¯æ˜¯commitè¿˜æ˜¯rollbackï¼›
        4. rocketmq**ç¡®è®¤æ¶ˆæ¯**ä¸ºcommitï¼Œæ¶ˆè´¹è€…æ‰å¯ä»¥æ¶ˆè´¹åˆ°è¿™æ¡æ¶ˆæ¯ï¼›
        5. æ¶ˆè´¹è€…æ“ä½œæ•°æ®åº“ï¼Œæ‰§è¡Œè‡ªå·±çš„äº‹åŠ¡ï¼›
        6. æ¶ˆè´¹è€…æˆåŠŸæ¶ˆè´¹åè¿”å›ä¸€ä¸ªACKæ¶ˆæ¯ç»™rocketmqï¼Œå¦‚æœæˆåŠŸæ¶ˆè´¹åˆ™æ˜¾ç¤ºæ¶ˆè´¹æˆåŠŸï¼Œå¦åˆ™rocketmqä¼šé‡å‘æ¶ˆæ¯ç»™æ¶ˆè´¹è€…ï¼›
  2. MQå¼„ä¸¢æ•°æ®ï¼šå¼€å¯rabbitmqæŒä¹…åŒ–ï¼Œå°†æ¶ˆæ¯å†™å…¥åä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ï¼ŒmqæŒ‚äº†ï¼Œæ¢å¤åè‡ªåŠ¨è¯»å–ä¹‹å‰å­˜å‚¨çš„æ•°æ®ï¼›
  3. æ¶ˆè´¹è€…å¼„ä¸¢æ•°æ®ï¼šçœ‹1ä¸­ç¬¬6æ¡ï¼›

- ä¿è¯æ¶ˆæ¯çš„**é¡ºåºæ€§**ï¼šæ¯ä¸ªpartitionä¸­åˆ†nä¸ªå†…å­˜queueï¼Œå…·æœ‰ç›¸åŒkeyçš„æ•°æ®æ”¾åˆ°åŒä¸€ä¸ªqueueï¼Œç„¶åå¯¹äºnä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«æ¶ˆè´¹ä¸€ä¸ªå†…å­˜queueï¼›

- æ¶ˆæ¯å»¶æ—¶ï¼š

  1. å…ˆä¿®å¤æ¶ˆè´¹è€…çš„é—®é¢˜ï¼Œç¡®ä¿æ¢å¤æ¶ˆè´¹é€Ÿåº¦ï¼Œç„¶åå°†ç°æœ‰æ¶ˆè´¹è€…éƒ½åœæ‰ï¼›
  2. ä¸´æ—¶æ–°å»ºå¤šä¸ªtopicï¼Œqueueï¼›
  3. å†™ä¸€ä¸ª**ä¸´æ—¶åˆ†å‘æ•°æ®çš„æ¶ˆè´¹è€…**ç¨‹åºï¼Œå°†ç§¯å‹çš„æ•°æ®å¼•æµ(å‡åŒ€è½®è¯¢å†™å…¥)åˆ°ä¸´æ—¶queueä¸­ï¼›
  4. ä¸´æ—¶å¾ç”¨10å€æœºå™¨æ¥éƒ¨ç½²æ¶ˆè´¹è€…ï¼Œæ¯ä¸€æ‰¹æ¶ˆè´¹è€…æ¶ˆè´¹ä¸´æ—¶queueçš„æ•°æ®ï¼Œç›¸å½“äºä¸´æ—¶å°†queueå’Œæ¶ˆè´¹è€…èµ„æºæ‰©å¤§10å€ï¼Œä»¥æ­£å¸¸10å€çš„é€Ÿåº¦æ¶ˆè´¹ç§¯å‹çš„æ•°æ®ï¼›
  5. æ¢å¤åŸæ¥çš„çŠ¶æ€ï¼›

- æ¶ˆæ¯ç§¯å‹å¯¼è‡´çš„è¿‡æœŸå¤±æ•ˆï¼šæ‰‹åŠ¨æŸ¥å‡ºæ¥å‘åˆ°messagequeueè¡¥ä¸Šå»ï¼›

- `pagecache`

# ç¼“å­˜(redis)

## æ•°æ®ç»“æ„

![image-20230415124719322](./assets/redis/redisåº•å±‚æ•°æ®ç»“æ„.png)

### å…¨å±€å“ˆå¸Œè¡¨

![image-20230415125016936](./assets/redis/å…¨å±€å“ˆå¸Œè¡¨æ•°æ®ç»“æ„.png)

Redisä½¿ç”¨å…¨å±€å“ˆå¸Œè¡¨æ¥ä¿å­˜æ‰€æœ‰é”®å€¼å¯¹ï¼Œå“ˆå¸Œè¡¨æ¯ä¸€é¡¹æ˜¯ä¸€ä¸ªdictEntryç»“æ„ä½“ï¼Œç”¨æ¥æŒ‡å‘ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå¦‚å›¾

![image-20230415101304365](./assets/redis/dictEntryæ•°æ®ç»“æ„.png)

dictEntryç»“æ„ä¸­æœ‰ä¸‰ä¸ªå­—èŠ‚çš„æŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘å®é™…æ•°æ®çš„keyã€valueå’Œä¸‹ä¸€ä¸ªdictEntryï¼Œå…±24å­—èŠ‚ã€‚

âš ï¸ Redisä½¿ç”¨çš„å†…å­˜åˆ†é…åº“jemallocä¼šåˆ†é…æœ€æ¥è¿‘ç”³è¯·å­—èŠ‚æ•°çš„**2çš„å¹‚æ¬¡æ–¹**çš„æ•°çš„ç©ºé—´ï¼Œå› æ­¤dictEntryé€šå¸¸ä¼šå ç”¨32å­—èŠ‚

### RedisObject

Redisä½¿ç”¨RedisObjectç»“æ„ä½“æ¥ç»Ÿä¸€è®°å½•ä¸åŒæ•°æ®ç±»å‹çš„å…ƒæ•°æ®ï¼ŒåŒæ—¶æŒ‡å‘å®é™…æ•°æ®

![image-20230415100322224](./assets/redis/RedisObjectç¼–ç æ¨¡å¼æ•°æ®ç»“æ„.png)

é™¤äº†intç¼–ç ï¼ˆå¯ä»¥å­˜å‚¨longæ•´å‹ï¼‰ç›´æ¥å­˜å‚¨æ•°æ®æœ¬èº«ä¹‹å¤–ï¼Œå­˜å‚¨å…¶ä»–æ•°æ®ç»“æ„éƒ½éœ€è¦8å­—èŠ‚çš„æŒ‡é’ˆ

### 1. ç®€å•åŠ¨æ€å­—ç¬¦ä¸²SDS

![img](./assets/redis/ç®€å•åŠ¨æ€å­—ç¬¦ä¸²æ•°æ®ç»“æ„.jpg)

* sizeï¼š4å­—èŠ‚(lenï¼Œbufå®é™…ä½¿ç”¨é•¿åº¦)+4å­—èŠ‚(allocï¼Œbufå®é™…åˆ†é…é•¿åº¦)+1å­—èŠ‚(ç»“æŸç¬¦)+å®é™…æ•°æ®å¤§å°ï¼Œä¸€å…±è‡³å°‘9å­—èŠ‚

### 2. å‹ç¼©åˆ—è¡¨ziplist

ç”¨ä¸€ç³»åˆ—è¿ç»­çš„entryä¿å­˜æ•°æ®

![image-20230415125258571](./assets/redis/å‹ç¼©åˆ—è¡¨æ•°æ®ç»“æ„.png)

* å‹ç¼©åˆ—è¡¨ç»“æ„ï¼š
  1. zlbytes: åˆ—è¡¨é•¿åº¦
  2. zltail: åˆ—è¡¨å°¾éƒ¨åç§»é‡
  3. zllen: åˆ—è¡¨ä¸­entryä¸ªæ•°
  4. entry: 
     1. prev_len: å‰ä¸€ä¸ªentryçš„é•¿åº¦ï¼Œå‰entryé•¿åº¦ä¸º0~254å­—èŠ‚ï¼Œprev_lenä¸º1å­—èŠ‚ï¼Œå¦åˆ™ä¸º5å­—èŠ‚
     2. encoding: ç¼–ç æ–¹å¼ï¼Œ1å­—èŠ‚
     3. len: è‡ªèº«é•¿åº¦ï¼Œ4å­—èŠ‚
     4. content: å®é™…æ•°æ®
  5. zlend: åˆ—è¡¨ç»“æŸæ ‡å¿—ä½

## çº¿ç¨‹æ¨¡å‹

- **å•çº¿ç¨‹å·¥ä½œæ¨¡å‹**
- å†…éƒ¨ä½¿ç”¨æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼Œè¿™ä¸ªå¤„ç†å™¨æ˜¯å•çº¿ç¨‹çš„ï¼ŒåŒ…å«4ä¸ªéƒ¨åˆ†ï¼š
  1. å¤šä¸ªsocketï¼›
  2. IOå¤šè·¯å¤ç”¨ç¨‹åºï¼›
  3. æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼›
  4. äº‹ä»¶å¤„ç†å™¨(è¿æ¥åº”ç­”å¤„ç†å™¨ã€å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ã€å‘½ä»¤å›å¤å¤„ç†å™¨)ï¼›
- ä¸ºä»€ä¹ˆå•çº¿ç¨‹æ¨¡å‹æ•ˆç‡ä¹Ÿè¿™ä¹ˆé«˜ï¼Ÿ
  1. **çº¯å†…å­˜**æ“ä½œï¼›
  2. æ ¸å¿ƒæ˜¯åŸºäº**IOå¤šè·¯å¤ç”¨**æœºåˆ¶ï¼›
  3. **Cè¯­è¨€**å®ç°ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒCè¯­è¨€å®ç°çš„ç¨‹åºâ€œè·ç¦»â€æ“ä½œç³»ç»Ÿæ›´è¿‘ï¼Œæ‰§è¡Œé€Ÿåº¦ç›¸å¯¹æ›´å¿«ï¼›
  4. å•çº¿ç¨‹é¿å…äº†å¤šçº¿ç¨‹**é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢**çš„é—®é¢˜ï¼Œé¢„é˜²äº†å¤šçº¿ç¨‹å¯èƒ½äº§ç”Ÿçš„**ç«äº‰**é—®é¢˜ï¼›
- Redis6.0å¼•å…¥å¤šçº¿ç¨‹ï¼šå› ä¸ºè¯»å†™ç½‘ç»œçš„Read/Writeç³»ç»Ÿè°ƒç”¨åœ¨Redisæ‰§è¡ŒæœŸé—´å ç”¨äº†å¤§éƒ¨åˆ†CPUæ—¶é—´ï¼Œå¦‚æœæŠŠ**ç½‘ç»œè¯»å†™åšæˆå¤šçº¿ç¨‹çš„æ–¹å¼**å¯¹æ€§èƒ½ä¼šæœ‰å¾ˆå¤§çš„æå‡ï¼›**Redisçš„å¤šçº¿ç¨‹éƒ¨åˆ†åªæ˜¯ç”¨æ¥å¤„ç†ç½‘ç»œæ•°æ®çš„è¯»å†™å’Œåè®®è§£æï¼Œæ‰§è¡Œå‘½ä»¤ä»ç„¶æ˜¯å•çº¿ç¨‹ã€‚**ä¹‹æ‰€ä»¥è¿™ä¹ˆè®¾è®¡æ˜¯ä¸æƒ³ Redis å› ä¸ºå¤šçº¿ç¨‹è€Œå˜å¾—å¤æ‚ï¼Œéœ€è¦å»æ§åˆ¶ keyã€luaã€äº‹åŠ¡ã€LPUSH/LPOP ç­‰ç­‰çš„å¹¶å‘é—®é¢˜ã€‚
- Redis é€‰æ‹©ä½¿**ç”¨å•çº¿ç¨‹æ¨¡å‹å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚**ä¸»è¦è¿˜æ˜¯å› ä¸º **CPU ä¸æ˜¯ Redis æœåŠ¡å™¨çš„ç“¶é¢ˆ**ï¼Œæ‰€ä»¥ä½¿ç”¨å¤šçº¿ç¨‹æ¨¡å‹å¸¦æ¥çš„æ€§èƒ½æå‡å¹¶**ä¸èƒ½æŠµæ¶ˆ**å®ƒå¸¦æ¥çš„å¼€å‘æˆæœ¬å’Œç»´æŠ¤æˆæœ¬ï¼Œ**ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆä¹Ÿä¸»è¦åœ¨ç½‘ç»œ I/O æ“ä½œä¸Šï¼›**è€Œ Redis å¼•å…¥å¤šçº¿ç¨‹æ“ä½œä¹Ÿæ˜¯å‡ºäºæ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼Œå¯¹äºä¸€äº›å¤§é”®å€¼å¯¹çš„åˆ é™¤æ“ä½œï¼Œé€šè¿‡**å¤šçº¿ç¨‹éé˜»å¡åœ°é‡Šæ”¾å†…å­˜ç©ºé—´ä¹Ÿèƒ½å‡å°‘å¯¹ Redis ä¸»çº¿ç¨‹é˜»å¡çš„æ—¶é—´**ï¼Œæé«˜æ‰§è¡Œçš„æ•ˆç‡ã€‚

## å¸¸è§æ•°æ®ç±»å‹

1. `Strings`ï¼šæ™®é€šsetã€getæ“ä½œï¼Œåšç®€å•çš„KVç¼“å­˜(åº•å±‚å®ç°)

   * æ˜¯ä¸€ç§åŠ¨æ€å­—ç¬¦ä¸²ï¼Œç±»ä¼¼`ArrayList`

   ```bash
   set college szu
   ```

2. `Hashes`ï¼šè¿™ä¸ªæ˜¯ç±»ä¼¼ map çš„ä¸€ç§ç»“æ„ï¼Œè¿™ä¸ªä¸€èˆ¬å°±æ˜¯å¯ä»¥å°†ç»“æ„åŒ–çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸€ä¸ªå¯¹è±¡ï¼ˆå‰ææ˜¯**è¿™ä¸ªå¯¹è±¡æ²¡åµŒå¥—å…¶ä»–çš„å¯¹è±¡**ï¼‰ç»™ç¼“å­˜åœ¨ Redis é‡Œï¼Œç„¶åæ¯æ¬¡è¯»å†™ç¼“å­˜çš„æ—¶å€™ï¼Œå¯ä»¥å°±æ“ä½œ hash é‡Œçš„**æŸä¸ªå­—æ®µ**ã€‚

   * ç›¸å½“äº Java ä¸­çš„ **HashMap**ï¼Œå†…éƒ¨å®ç°ä¹Ÿå·®ä¸å¤šç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡ **"æ•°ç»„ + é“¾è¡¨"** çš„é“¾åœ°å€æ³•æ¥è§£å†³éƒ¨åˆ† **å“ˆå¸Œå†²çª**ï¼›
   * **å†…éƒ¨åŒ…å«ä¸¤ä¸ª hashtable**ï¼Œé€šå¸¸æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ª hashtable æ˜¯æœ‰å€¼çš„ï¼Œä½†æ˜¯åœ¨å­—å…¸æ‰©å®¹ç¼©å®¹æ—¶ï¼Œéœ€è¦åˆ†é…æ–°çš„ hashtableï¼Œç„¶åè¿›è¡Œ **æ¸è¿›å¼æ¬è¿** ï¼›
   * æ‰©å®¹æ˜¯æ¯”è¾ƒè€—æ—¶é—´çš„ï¼Œéœ€è¦é‡æ–°ç”³è¯·æ–°çš„æ•°ç»„ï¼Œç„¶åå°†æ—§å­—å…¸æ‰€æœ‰é“¾è¡¨ä¸­çš„å…ƒç´ é‡æ–°æŒ‚æ¥åˆ°æ–°çš„æ•°ç»„ä¸‹é¢ï¼Œè¿™æ˜¯ä¸€ä¸ª O(n) çº§åˆ«çš„æ“ä½œï¼Œä½œä¸ºå•çº¿ç¨‹çš„ Redis å¾ˆéš¾æ‰¿å—è¿™æ ·è€—æ—¶çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ Redis ä½¿ç”¨ **æ¸è¿›å¼ rehash** å°æ­¥æ¬è¿

   ```bash
   xÂ hset person name bingohset person age 20hset person id 1hget person nameâ€‹person = { Â  Â "name": "bingo", Â  Â "age": 20,	 Â  Â "id": 1}bash
   ```

3. `Lists`ï¼šæœ‰åºåˆ—è¡¨

   * ç›¸å½“äº Java è¯­è¨€ä¸­çš„ **LinkedList**ï¼Œå¯ä»¥æ˜¯åŒé“¾è¡¨ï¼Œä¹Ÿå¯ä»¥æ˜¯å¸¦å¤´å°¾èŠ‚ç‚¹çš„åŒé“¾è¡¨ï¼›æ³¨æ„å®ƒæ˜¯é“¾è¡¨è€Œä¸æ˜¯æ•°ç»„ã€‚è¿™æ„å‘³ç€ list çš„æ’å…¥å’Œåˆ é™¤æ“ä½œéå¸¸å¿«ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œä½†æ˜¯ç´¢å¼•å®šä½å¾ˆæ…¢ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼›

     ![Redis listNodeç»“æ„](assets\Redis listNodeç»“æ„.png)

     ![Redis listNodeç»“æ„](assets\Redis listç»“æ„.jpg)

   * é€šè¿‡ list å­˜å‚¨ä¸€äº›åˆ—è¡¨å‹çš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼ç²‰ä¸åˆ—è¡¨ã€æ–‡ç« çš„è¯„è®ºåˆ—è¡¨ä¹‹ç±»çš„ä¸œè¥¿ï¼›

   * å¯ä»¥é€šè¿‡ `lrange `å‘½ä»¤ï¼Œè¯»å–æŸä¸ªé—­åŒºé—´å†…çš„å…ƒç´ ï¼Œå¯ä»¥åŸºäº list å®ç°åˆ†é¡µæŸ¥è¯¢ï¼›åŸºäº Redis å®ç°ç®€å•çš„é«˜æ€§èƒ½åˆ†é¡µï¼Œå¯ä»¥åšç±»ä¼¼å¾®åšé‚£ç§ä¸‹æ‹‰ä¸æ–­åˆ†é¡µçš„ä¸œè¥¿ï¼Œæ€§èƒ½é«˜ï¼Œå°±ä¸€é¡µä¸€é¡µèµ°ã€‚

   ```bash
   # 0å¼€å§‹ä½ç½®ï¼Œ-1ç»“æŸä½ç½®ï¼Œç»“æŸä½ç½®ä¸º-1æ—¶ï¼Œè¡¨ç¤ºåˆ—è¡¨çš„æœ€åä¸€ä¸ªä½ç½®ï¼Œå³æŸ¥çœ‹æ‰€æœ‰ã€‚
   lrange mylist 0 -1
   ```

   - ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä» list å¤´è¿›å»ï¼Œä» list å°¾å·´é‚£é‡Œå‡ºæ¥ã€‚

   ```bash
   lpush mylist 1
   lpush mylist 2
   lpush mylist 3 4 5
   
   # 1
   rpop mylist
   ```

4. `Sets`ï¼šæ— åºé›†åˆï¼Œè‡ªåŠ¨å»é‡ã€‚

   * ç›¸å½“äº`HashSet`ï¼›

   - å¯¹ä¸€äº›æ•°æ®è¿›è¡Œ**å¿«é€Ÿçš„å…¨å±€å»é‡**ï¼Œä½ å½“ç„¶ä¹Ÿå¯ä»¥åŸºäº jvm å†…å­˜é‡Œçš„ HashSet è¿›è¡Œå»é‡ï¼Œä½†æ˜¯å¦‚æœä½ çš„æŸä¸ªç³»ç»Ÿéƒ¨ç½²åœ¨å¤šå°æœºå™¨ä¸Šå‘¢ï¼Ÿå¾—åŸºäº Redis è¿›è¡Œå…¨å±€çš„ set å»é‡ã€‚
   - å¯ä»¥åŸºäº set ç©å„¿äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„æ“ä½œï¼Œæ¯”å¦‚äº¤é›†å§ï¼Œå¯ä»¥æŠŠä¸¤ä¸ªäººçš„ç²‰ä¸åˆ—è¡¨æ•´ä¸€ä¸ªäº¤é›†ï¼Œçœ‹çœ‹ä¿©äººçš„å…±åŒå¥½å‹ã€‚

   ```bash
   #-------æ“ä½œä¸€ä¸ªset-------
   # æ·»åŠ å…ƒç´ 
   sadd mySet 1
   
   # æŸ¥çœ‹å…¨éƒ¨å…ƒç´ 
   smembers mySet
   
   # åˆ¤æ–­æ˜¯å¦åŒ…å«æŸä¸ªå€¼
   sismember mySet 3
   
   # åˆ é™¤æŸä¸ª/äº›å…ƒç´ 
   srem mySet 1
   srem mySet 2 4
   
   # æŸ¥çœ‹å…ƒç´ ä¸ªæ•°
   scard mySet
   
   # éšæœºåˆ é™¤ä¸€ä¸ªå…ƒç´ 
   spop mySet
   
   #-------æ“ä½œå¤šä¸ªset-------
   # å°†ä¸€ä¸ªsetçš„å…ƒç´ ç§»åŠ¨åˆ°å¦å¤–ä¸€ä¸ªset
   smove yourSet mySet 2
   
   # æ±‚ä¸¤setçš„äº¤é›†
   sinter yourSet mySet
   
   # æ±‚ä¸¤setçš„å¹¶é›†
   sunion yourSet mySet
   
   # æ±‚åœ¨yourSetä¸­è€Œä¸åœ¨mySetä¸­çš„å…ƒç´ 
   sdiff yourSet mySet
   ```

   

5. `Sorted Sets`ï¼šæ’åºçš„ setï¼Œå»é‡ä½†å¯ä»¥æ’åºï¼Œå†™è¿›å»çš„æ—¶å€™ç»™ä¸€ä¸ªåˆ†æ•°ï¼Œè‡ªåŠ¨æ ¹æ®åˆ†æ•°æ’åºã€‚

   * ç±»ä¼¼äº Java ä¸­ **SortedSet** å’Œ **HashMap** çš„ç»“åˆä½“ï¼Œä¸€æ–¹é¢å®ƒæ˜¯ä¸€ä¸ª setï¼Œä¿è¯äº†å†…éƒ¨ value çš„å”¯ä¸€æ€§ï¼Œå¦ä¸€æ–¹é¢å®ƒå¯ä»¥ä¸ºæ¯ä¸ª value èµ‹äºˆä¸€ä¸ª score å€¼ï¼Œç”¨æ¥ä»£è¡¨æ’åºçš„æƒé‡ã€‚
   * å®ƒçš„å†…éƒ¨å®ç°ç”¨çš„æ˜¯ä¸€ç§å«åš **ã€Œ[è·³è·ƒè¡¨](https://mp.weixin.qq.com/s/NOsXdrMrWwq4NTm180a6vw)ã€** çš„æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸€ç§å¤šå±‚é“¾è¡¨ç»“æ„ï¼Œæ’å…¥èŠ‚ç‚¹çš„æ—¶å€™ä¼šéšæœºå‡ºä¸€ä¸ªå±‚æ•°ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º`O(logN)`ï¼›

   ![è·³è·ƒè¡¨](assets\è·³è·ƒè¡¨.png)

   ```bash
   zadd board 85 zhangsan
   zadd board 72 lisi
   zadd board 96 wangwu
   zadd board 63 zhaoliu
   
   # è·å–æ’åå‰ä¸‰çš„ç”¨æˆ·ï¼ˆé»˜è®¤æ˜¯å‡åºï¼Œæ‰€ä»¥éœ€è¦ rev æ”¹ä¸ºé™åºï¼‰
   zrevrange board 0 3
   
   # è·å–æŸç”¨æˆ·çš„æ’å
   zrank board zhaoliu
   ```

   | è·³è¡¨ä¼˜åŠ¿ ğŸ‘ | è·³è¡¨åŠ£åŠ¿ ğŸ‘ |
   | ---------- | ---------- |
   | **å®ç°ç®€å•** | æœ€åæƒ…å†µä¸‹æ˜¯ O(n)ï¼ˆæ¦‚ç‡å¾ˆå°ï¼‰ |
   | æ’å…¥/åˆ é™¤ä¸éœ€è¦é‡å¹³è¡¡ | å ç”¨ç©ºé—´ç•¥å¤§ï¼ˆå¤šçº§ç´¢å¼•ï¼‰ |
   | **èŒƒå›´æŸ¥è¯¢æ€§èƒ½æä½³** | æ€§èƒ½ä¾èµ–éšæœºå±‚åˆ†å¸ƒ |
   | **å¹¶å‘å‹å¥½æ€§å¼º** | ç†è®ºåŸºç¡€ä¸å¦‚æ ‘â€œä¸¥æ ¼â€ |

   | çº¢é»‘æ ‘ / AVL ä¼˜åŠ¿ ğŸ‘  | çº¢é»‘æ ‘ / AVL åŠ£åŠ¿ ğŸ‘            |
   | -------------------- | ------------------------------ |
   | ä¸¥æ ¼å¹³è¡¡ï¼Œæ€§èƒ½ç¨³å®š   | å®ç°å¤æ‚ï¼Œç»´æŠ¤ä»£ä»·é«˜           |
   | æœ€åæƒ…å†µæ€§èƒ½å¯æ§     | èŒƒå›´éå†ä¸å¦‚è·³è¡¨è‡ªç„¶           |
   | **èŠ‚ç‚¹ç©ºé—´åˆ©ç”¨ç‡é«˜** | **ä¸é€‚åˆé¢‘ç¹æ’å…¥åˆ é™¤å¹¶å‘åœºæ™¯** |

6. `Bitmaps`

7. `HyperLogLogs`

8. `Streams`

## è¿‡æœŸç­–ç•¥

- å¸¸è§é—®é¢˜

  1. å¾€ Redis å†™å…¥çš„æ•°æ®æ€ä¹ˆæ²¡äº†ï¼Ÿ

     **ç”¨å†…å­˜å½“ç¼“å­˜ï¼Œä½†æ˜¯å†…å­˜æœ‰é™**ï¼ŒRedisç©ºé—´è‡ªç„¶ä¹Ÿæœ‰é™ï¼Œè¶…è¿‡æœ€å¤§ç©ºé—´å°±å¿…é¡»èˆå¼ƒä¸€äº›æ•°æ®ï¼Œæ¯”å¦‚èˆå¼ƒä¸å¸¸ç”¨çš„æ•°æ®ã€‚

  2. æ•°æ®æ˜æ˜è¿‡æœŸäº†ï¼Œæ€ä¹ˆè¿˜å ç”¨ç€å†…å­˜ï¼Ÿ

     è¿™æ˜¯ç”± Redis çš„è¿‡æœŸç­–ç•¥æ¥å†³å®šã€‚

- è¿‡æœŸç­–ç•¥ï¼šå®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤

  - å®šæœŸåˆ é™¤ï¼šRedis é»˜è®¤æ˜¯æ¯éš” 100ms å°±**éšæœºæŠ½å–**ä¸€äº›è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ keyï¼Œæ£€æŸ¥å…¶æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±åˆ é™¤ã€‚è¿™å¯èƒ½ä¼šå‡ºç°è¿‡æœŸçš„keyæ²¡è¢«åˆ é™¤æ‰ï¼Œéœ€è¦**æƒ°æ€§åˆ é™¤**ï¼›
  - æƒ°æ€§åˆ é™¤ï¼šåœ¨ä½ **è·å–**æŸä¸ª key çš„æ—¶å€™ï¼ŒRedis ä¼š**æ£€æŸ¥**ä¸€ä¸‹ ï¼Œè¿™ä¸ª key å¦‚æœè®¾ç½®äº†è¿‡æœŸæ—¶é—´é‚£ä¹ˆæ˜¯å¦è¿‡æœŸäº†ï¼Ÿå¦‚æœè¿‡æœŸäº†æ­¤æ—¶å°±ä¼šåˆ é™¤ï¼Œä¸ä¼šç»™ä½ è¿”å›ä»»ä½•ä¸œè¥¿ã€‚
  - ç»è¿‡ä¸Šé¢ä¸¤ç§åˆ é™¤ç­–ç•¥ä»å¯èƒ½æ¼æ‰è¿‡æœŸçš„keyï¼Œé•¿æœŸä¸‹å»keyä¼šå¤§é‡å †ç§¯ï¼Œè€—å°½å†…å­˜ï¼Œæ­¤æ—¶è¿˜æœ‰å†…å­˜æ·˜æ±°æœºåˆ¶ï¼›

- å†…å­˜æ·˜æ±°æœºåˆ¶

  1. **allkeys-lru**ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨**é”®ç©ºé—´**ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ keyï¼ˆè¿™ä¸ªæ˜¯**æœ€å¸¸ç”¨**çš„ï¼‰ï¼›
  2. volatile-lruï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨**è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´**ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ keyï¼ˆè¿™ä¸ªä¸€èˆ¬ä¸å¤ªåˆé€‚ï¼‰ï¼›
  3. volatile-randomï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨**è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´**ä¸­ï¼Œ**éšæœºç§»é™¤**æŸä¸ª keyï¼›
  4. volatile-ttlï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨**è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´**ä¸­ï¼Œæœ‰**æ›´æ—©è¿‡æœŸæ—¶é—´**çš„ key ä¼˜å…ˆç§»é™¤ã€‚

## é«˜å¹¶å‘ã€é«˜å¯ç”¨

- redisåŸºäºå“¨å…µæœºåˆ¶çš„ä¸»ä»æ¶æ„ï¼š**å•ä¸»ç”¨æ¥å†™å…¥æ•°æ®ï¼Œå¤šä»ç”¨æ¥æŸ¥è¯¢æ•°æ®**ï¼›
- redisé›†ç¾¤ï¼šå®ç°é«˜å¹¶å‘çš„åŒæ—¶ï¼Œ**å®¹çº³å¤§é‡æ•°æ®**ï¼›

### redis[ä¸»ä»æ¶æ„](https://adjava.netlify.app/#/./docs/high-concurrency/redis-master-slave)

ä¸€ä¸»å¤šä»+å“¨å…µæœºåˆ¶

#### Redis replication çš„æ ¸å¿ƒæœºåˆ¶

- Redis é‡‡ç”¨**å¼‚æ­¥æ–¹å¼**å¤åˆ¶æ•°æ®åˆ° slave èŠ‚ç‚¹ï¼Œslave node ä¼š**å‘¨æœŸæ€§åœ°ç¡®è®¤**è‡ªå·±æ¯æ¬¡å¤åˆ¶çš„æ•°æ®é‡ï¼›

- ä¸€ä¸ª master node æ˜¯å¯ä»¥é…ç½®å¤šä¸ª slave nodeï¼Œslave node ä¹Ÿå¯ä»¥è¿æ¥å…¶ä»–çš„ slave nodeï¼›

- slave node åšå¤åˆ¶çš„æ—¶å€™ï¼Œ**ä¸ä¼š block** master node çš„æ­£å¸¸å·¥ä½œï¼›

- slave node åœ¨åšå¤åˆ¶çš„æ—¶å€™ï¼Œä¹Ÿä¸ä¼š block å¯¹è‡ªå·±çš„æŸ¥è¯¢æ“ä½œï¼Œå®ƒä¼šç”¨æ—§çš„æ•°æ®é›†æ¥æä¾›æœåŠ¡ï¼›ä½†æ˜¯**å¤åˆ¶å®Œæˆ**çš„æ—¶å€™ï¼Œéœ€è¦**åˆ é™¤æ—§**æ•°æ®é›†ï¼Œ**åŠ è½½æ–°**æ•°æ®é›†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼š**æš‚åœå¯¹å¤–æœåŠ¡**äº†ï¼›

- æ³¨æ„ï¼Œå¦‚æœé‡‡ç”¨äº†ä¸»ä»æ¶æ„ï¼Œé‚£ä¹ˆå»ºè®®å¿…é¡»**å¼€å¯** master node çš„[**æŒä¹…åŒ–**](https://adjava.netlify.app/#/docs/high-concurrency/redis-persistence)ï¼Œä¸å»ºè®®ç”¨ slave node ä½œä¸º master node çš„æ•°æ®çƒ­å¤‡ï¼Œå› ä¸ºé‚£æ ·çš„è¯ï¼Œå¦‚æœä½ å…³æ‰ master çš„æŒä¹…åŒ–ï¼Œå¯èƒ½åœ¨ master å®•æœºé‡å¯çš„æ—¶å€™æ•°æ®æ˜¯ç©ºçš„ï¼Œç„¶åå¯èƒ½ä¸€ç»è¿‡å¤åˆ¶ï¼Œ slave node çš„æ•°æ®ä¹Ÿä¸¢äº†ã€‚

  â€‹         slave node å¯ä»¥**è‡ªåŠ¨æ¥ç®¡** master nodeï¼Œä½†ä¹Ÿå¯èƒ½ sentinel è¿˜æ²¡æ£€æµ‹åˆ° master failureï¼Œmaster node å°±è‡ªåŠ¨é‡å¯äº†ï¼Œè¿˜æ˜¯å¯èƒ½å¯¼è‡´ä¸Šé¢æ‰€æœ‰çš„ slave node æ•°æ®è¢«æ¸…ç©ºã€‚

#### Redis ä¸»ä»å¤åˆ¶çš„æ ¸å¿ƒåŸç†

1. å¯åŠ¨ä¸€ä¸ªslave nodeçš„æ—¶å€™ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ª`PSYNC`å‘½ä»¤ç»™master nodeï¼›
2. å¦‚æœè¿™æ˜¯ slave node **åˆæ¬¡è¿æ¥**åˆ° master nodeï¼Œé‚£ä¹ˆä¼šè§¦å‘ä¸€æ¬¡ `full resynchronization` **å…¨é‡å¤åˆ¶**ï¼Œslave ä¼šå…ˆ**å†™å…¥æœ¬åœ°ç£ç›˜ï¼Œç„¶åå†ä»æœ¬åœ°ç£ç›˜åŠ è½½åˆ°å†…å­˜**ä¸­ï¼›slave node å¦‚æœè·Ÿ master node æœ‰ç½‘ç»œæ•…éšœï¼Œæ–­å¼€äº†è¿æ¥ï¼Œä¼šè‡ªåŠ¨é‡è¿ï¼Œè¿æ¥ä¹‹å master node ä»…ä¼šå¤åˆ¶ç»™ slave éƒ¨åˆ†ç¼ºå°‘çš„æ•°æ®ã€‚
3. ä¸»ä»å¤åˆ¶çš„**æ–­ç‚¹ç»­ä¼ **ï¼šmaster node ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ª **backlog**ï¼Œmaster å’Œ slave éƒ½ä¼šä¿å­˜ä¸€ä¸ª replica offset è¿˜æœ‰ä¸€ä¸ª **master run id**ï¼Œoffset å°±æ˜¯ä¿å­˜åœ¨ backlog ä¸­çš„ã€‚å¦‚æœ master å’Œ slave ç½‘ç»œè¿æ¥æ–­æ‰äº†ï¼Œslave ä¼šè®© master **ä»ä¸Šæ¬¡ replica offset å¼€å§‹ç»§ç»­å¤åˆ¶**ï¼Œå¦‚æœæ²¡**æœ‰æ‰¾åˆ°å¯¹åº”çš„ offset**ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œä¸€æ¬¡ **`resynchronization` ã€‚**
4. è¿‡æœŸkeyå¤„ç†ï¼šslave ä¸ä¼šè¿‡æœŸ keyï¼Œ**åªä¼šç­‰å¾… master è¿‡æœŸ key**ã€‚å¦‚æœ master è¿‡æœŸäº†ä¸€ä¸ª keyï¼Œæˆ–è€…é€šè¿‡ LRU æ·˜æ±°äº†ä¸€ä¸ª keyï¼Œé‚£ä¹ˆä¼šæ¨¡æ‹Ÿä¸€æ¡ del å‘½ä»¤å‘é€ç»™ slaveï¼›

#### å…¨é‡å¤åˆ¶

- master æ‰§è¡Œ bgsave ï¼Œåœ¨æœ¬åœ°ç”Ÿæˆä¸€ä»½ rdb å¿«ç…§æ–‡ä»¶ã€‚

- master node å°† rdb å¿«ç…§æ–‡ä»¶å‘é€ç»™ slave nodeï¼Œå¦‚æœ rdb å¤åˆ¶æ—¶é—´è¶…è¿‡ 60ç§’ï¼ˆrepl-timeoutï¼‰ï¼Œé‚£ä¹ˆ slave node å°±ä¼šè®¤ä¸ºå¤åˆ¶å¤±è´¥ï¼Œå¯ä»¥é€‚å½“è°ƒå¤§è¿™ä¸ªå‚æ•°(å¯¹äºåƒå…†ç½‘å¡çš„æœºå™¨ï¼Œä¸€èˆ¬æ¯ç§’ä¼ è¾“ 100MBï¼Œ6G æ–‡ä»¶ï¼Œå¾ˆå¯èƒ½è¶…è¿‡ 60s)

- master node åœ¨ç”Ÿæˆ rdb æ—¶ï¼Œä¼šå°†æ‰€æœ‰æ–°çš„å†™å‘½ä»¤ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œåœ¨ slave node ä¿å­˜äº† rdb ä¹‹åï¼Œå†å°†æ–°çš„å†™å‘½ä»¤å¤åˆ¶ç»™ slave nodeã€‚

- å¦‚æœåœ¨å¤åˆ¶æœŸé—´ï¼Œå†…å­˜ç¼“å†²åŒºæŒç»­æ¶ˆè€—è¶…è¿‡ 64MBï¼Œæˆ–è€…ä¸€æ¬¡æ€§è¶…è¿‡ 256MBï¼Œé‚£ä¹ˆåœæ­¢å¤åˆ¶ï¼Œå¤åˆ¶å¤±è´¥ã€‚

  ```bash
  client-output-buffer-limit slave 256MB 64MB 60
  ```

- slave node æ¥æ”¶åˆ° rdb ä¹‹åï¼Œæ¸…ç©ºè‡ªå·±çš„æ—§æ•°æ®ï¼Œç„¶åé‡æ–°åŠ è½½ rdb åˆ°è‡ªå·±çš„å†…å­˜ä¸­ï¼ŒåŒæ—¶**åŸºäºæ—§çš„æ•°æ®ç‰ˆæœ¬**å¯¹å¤–æä¾›æœåŠ¡ã€‚

- å¦‚æœ slave node å¼€å¯äº† AOFï¼Œé‚£ä¹ˆä¼šç«‹å³æ‰§è¡Œ BGREWRITEAOFï¼Œé‡å†™ AOFã€‚

#### å¢é‡å¤åˆ¶

- å¦‚æœ**å…¨é‡å¤åˆ¶è¿‡ç¨‹ä¸­**ï¼Œmaster-slave **ç½‘ç»œè¿æ¥æ–­æ‰**ï¼Œé‚£ä¹ˆ slave é‡æ–°è¿æ¥ master æ—¶ï¼Œä¼šè§¦å‘å¢é‡å¤åˆ¶ã€‚
- master ç›´æ¥ä»è‡ªå·±çš„ **backlog** ä¸­è·å–éƒ¨åˆ†ä¸¢å¤±çš„æ•°æ®ï¼Œå‘é€ç»™ slave nodeï¼Œé»˜è®¤ backlog å°±æ˜¯ 1MBã€‚
- master å°±æ˜¯æ ¹æ® slave å‘é€çš„ psync ä¸­çš„ **offset** æ¥ä» backlog ä¸­è·å–æ•°æ®çš„ã€‚

#### å…¶ä»–

- master é»˜è®¤æ¯éš” 10ç§’ å‘é€ä¸€æ¬¡ heartbeatï¼Œslave node æ¯éš” 1ç§’ å‘é€ä¸€ä¸ª heartbeatï¼›
- master æ¯æ¬¡æ¥æ”¶åˆ°å†™å‘½ä»¤ä¹‹åï¼Œå…ˆåœ¨å†…éƒ¨å†™å…¥æ•°æ®ï¼Œç„¶å**å¼‚æ­¥**å‘é€ç»™ slave nodeï¼›
- å¦‚æœ master node æ­»æ‰äº†ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿæ²¡æ³•å†™æ•°æ®äº†ï¼Œå†™ç¼“å­˜çš„æ—¶å€™ï¼Œå…¨éƒ¨å¤±æ•ˆäº†ã€‚slave node è¿˜æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Œæ²¡æœ‰ master ç»™å®ƒä»¬å¤åˆ¶æ•°æ®äº†ï¼Œç³»ç»Ÿç›¸å½“äºä¸å¯ç”¨äº†ã€‚Redis çš„é«˜å¯ç”¨æ¶æ„ï¼Œå«åš `failover` **æ•…éšœè½¬ç§»**ï¼Œä¹Ÿå¯ä»¥å«åšä¸»å¤‡åˆ‡æ¢ã€‚
  - master node åœ¨æ•…éšœæ—¶ï¼Œè‡ªåŠ¨æ£€æµ‹ï¼Œå¹¶ä¸”å°†æŸä¸ª slave node è‡ªåŠ¨åˆ‡æ¢ä¸º master node çš„è¿‡ç¨‹ï¼Œå«åšä¸»å¤‡åˆ‡æ¢ã€‚è¿™ä¸ªè¿‡ç¨‹ï¼Œå®ç°äº† Redis çš„ä¸»ä»æ¶æ„ä¸‹çš„é«˜å¯ç”¨ã€‚

### RedisæŒä¹…åŒ–

æŒä¹…åŒ–ä¸»è¦æ˜¯åš**ç¾éš¾æ¢å¤ã€æ•°æ®æ¢å¤**ï¼Œä¹Ÿå¯ä»¥å½’ç±»åˆ°é«˜å¯ç”¨çš„ä¸€ä¸ªç¯èŠ‚ä¸­å»ï¼Œæ¯”å¦‚ä½  Redis æ•´ä¸ªæŒ‚äº†ï¼Œç„¶å Redis å°±ä¸å¯ç”¨äº†ï¼Œä½ è¦åšçš„äº‹æƒ…å°±æ˜¯è®© Redis å˜å¾—å¯ç”¨ï¼Œå°½å¿«å˜å¾—å¯ç”¨ã€‚

å¤§é‡çš„è¯·æ±‚è¿‡æ¥ï¼Œç¼“å­˜å…¨éƒ¨æ— æ³•å‘½ä¸­ï¼Œåœ¨ Redis é‡Œæ ¹æœ¬æ‰¾ä¸åˆ°æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å°±æ­»å®šäº†ï¼Œå‡ºç°**ç¼“å­˜é›ªå´©**é—®é¢˜ã€‚æ‰€æœ‰è¯·æ±‚æ²¡æœ‰åœ¨ Redis å‘½ä¸­ï¼Œå°±ä¼šå» mysql æ•°æ®åº“è¿™ç§æ•°æ®æºå¤´ä¸­å»æ‰¾ï¼Œä¸€ä¸‹å­ mysql æ‰¿æ¥é«˜å¹¶å‘ï¼Œç„¶åå°±æŒ‚äº†

#### RDBæœºåˆ¶

- å¯¹ Redis ä¸­çš„æ•°æ®æ‰§è¡Œ**å‘¨æœŸæ€§**çš„æŒä¹…åŒ–ã€‚
- ä¼˜ç‚¹ï¼š
  - RDB ä¼šç”Ÿæˆå¤šä¸ªæ•°æ®æ–‡ä»¶ï¼Œæ¯ä¸ªæ•°æ®æ–‡ä»¶éƒ½ä»£è¡¨äº†æŸä¸€ä¸ªæ—¶åˆ»ä¸­ Redis çš„æ•°æ®ï¼Œè¿™ç§å¤šä¸ªæ•°æ®æ–‡ä»¶çš„æ–¹å¼ï¼Œ**éå¸¸é€‚åˆåšå†·å¤‡**ï¼Œå¯ä»¥å°†è¿™ç§å®Œæ•´çš„æ•°æ®æ–‡ä»¶å‘é€åˆ°ä¸€äº›è¿œç¨‹çš„å®‰å…¨å­˜å‚¨ä¸Šå»ï¼›
  - ç›¸å¯¹äº AOF æŒä¹…åŒ–æœºåˆ¶æ¥è¯´ï¼Œç›´æ¥åŸºäº RDB æ•°æ®æ–‡ä»¶æ¥é‡å¯å’Œæ¢å¤ Redis è¿›ç¨‹ï¼Œæ›´åŠ å¿«é€Ÿï¼›
  - RDB å¯¹ Redis å¯¹å¤–æä¾›çš„è¯»å†™æœåŠ¡ï¼Œå½±å“éå¸¸å°ï¼Œå¯ä»¥è®© Redis **ä¿æŒé«˜æ€§èƒ½**ï¼›
- ç¼ºç‚¹ï¼š
  - RDB æ•°æ®å¿«ç…§æ–‡ä»¶ï¼Œéƒ½æ˜¯æ¯éš” 5 åˆ†é’Ÿï¼Œæˆ–è€…æ›´é•¿æ—¶é—´ç”Ÿæˆä¸€æ¬¡ï¼Œè¿™ä¸ªæ—¶å€™å°±å¾—æ¥å—ä¸€æ—¦ Redis è¿›ç¨‹å®•æœºï¼Œé‚£ä¹ˆä¼šä¸¢å¤±æœ€è¿‘ 5 åˆ†é’Ÿçš„æ•°æ®ï¼›
  - RDB æ¯æ¬¡åœ¨ fork å­è¿›ç¨‹æ¥æ‰§è¡Œ RDB å¿«ç…§æ•°æ®æ–‡ä»¶ç”Ÿæˆçš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®æ–‡ä»¶ç‰¹åˆ«å¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¯¹å®¢æˆ·ç«¯æä¾›çš„æœåŠ¡æš‚åœæ•°æ¯«ç§’ï¼Œæˆ–è€…ç”šè‡³æ•°ç§’ï¼›

#### AOF æœºåˆ¶

- å¯¹æ¯æ¡å†™å…¥å‘½ä»¤ä½œä¸ºæ—¥å¿—ï¼Œä»¥ `append-only` çš„æ¨¡å¼å†™å…¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œåœ¨ Redis é‡å¯çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡**å›æ”¾** AOF æ—¥å¿—ä¸­çš„å†™å…¥æŒ‡ä»¤æ¥é‡æ–°æ„å»ºæ•´ä¸ªæ•°æ®é›†ã€‚
- å¦‚æœåŒæ—¶ä½¿ç”¨ RDB å’Œ AOF ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼Œé‚£ä¹ˆåœ¨ Redis é‡å¯çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ **AOF** æ¥é‡æ–°æ„å»ºæ•°æ®ï¼Œå› ä¸º AOF ä¸­çš„**æ•°æ®æ›´åŠ å®Œæ•´**ã€‚
- ä¼˜ç‚¹ï¼š
  - ä¸€èˆ¬ AOF ä¼šæ¯éš” 1 ç§’ï¼Œé€šè¿‡ä¸€ä¸ªåå°çº¿ç¨‹æ‰§è¡Œä¸€æ¬¡ `fsync` æ“ä½œï¼Œæœ€å¤šä¸¢å¤± 1 ç§’é’Ÿçš„æ•°æ®ï¼›
  - AOF æ—¥å¿—æ–‡ä»¶ä»¥ `append-only` æ¨¡å¼å†™å…¥ï¼Œæ‰€ä»¥**æ²¡æœ‰ä»»ä½•ç£ç›˜å¯»å€çš„å¼€é”€**ï¼Œå†™å…¥æ€§èƒ½éå¸¸é«˜ï¼Œè€Œä¸”æ–‡ä»¶ä¸å®¹æ˜“ç ´æŸï¼Œå³ä½¿æ–‡ä»¶å°¾éƒ¨ç ´æŸï¼Œä¹Ÿå¾ˆå®¹æ˜“ä¿®å¤ï¼›
  - AOF æ—¥å¿—æ–‡ä»¶çš„å‘½ä»¤é€šè¿‡**å¯è¯»è¾ƒå¼º**çš„æ–¹å¼è¿›è¡Œè®°å½•ï¼Œè¿™ä¸ªç‰¹æ€§éå¸¸**é€‚åˆåšç¾éš¾æ€§çš„è¯¯åˆ é™¤çš„ç´§æ€¥æ¢å¤**ã€‚
- ç¼ºç‚¹ï¼š
  - AOF å¼€å¯åï¼Œæ”¯æŒçš„å†™ QPS ä¼šæ¯” RDB æ”¯æŒçš„å†™ QPS ä½ï¼Œå› ä¸º AOF ä¸€èˆ¬ä¼šé…ç½®æˆæ¯ç§’ `fsync` ä¸€æ¬¡æ—¥å¿—æ–‡ä»¶ï¼›
  - é€šè¿‡ AOF åšå†·å¤‡ï¼Œæ²¡æœ‰ RDB åšå†·å¤‡æ¥çš„æ¢å¤é€Ÿåº¦æ›´å¿«ï¼›

#### ä¸¤ç§æ–¹å¼çš„é€‰æ‹©

- ä¸è¦ä»…ä»…ä½¿ç”¨ RDBï¼Œå› ä¸ºé‚£æ ·ä¼šå¯¼è‡´ä½ ä¸¢å¤±å¾ˆå¤šæ•°æ®ï¼›
- ä¹Ÿä¸è¦ä»…ä»…ä½¿ç”¨ AOFï¼Œå› ä¸ºé‚£æ ·æœ‰ä¸¤ä¸ªé—®é¢˜ï¼šç¬¬ä¸€ï¼Œä½ é€šè¿‡ AOF åšå†·å¤‡ï¼Œæ²¡æœ‰ RDB åšå†·å¤‡æ¥çš„æ¢å¤é€Ÿåº¦æ›´å¿«ï¼›ç¬¬äºŒï¼ŒRDB æ¯æ¬¡ç®€å•ç²—æš´ç”Ÿæˆæ•°æ®å¿«ç…§ï¼Œæ›´åŠ å¥å£®ï¼Œå¯ä»¥é¿å… AOF è¿™ç§å¤æ‚çš„å¤‡ä»½å’Œæ¢å¤æœºåˆ¶çš„ bugï¼›
- Redis æ”¯æŒ**åŒæ—¶å¼€å¯å¼€å¯ä¸¤ç§æŒä¹…åŒ–æ–¹å¼**ï¼Œæˆ‘ä»¬å¯ä»¥ç»¼åˆä½¿ç”¨ AOF å’Œ RDB ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼Œç”¨ **AOF æ¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä½œä¸ºæ•°æ®æ¢å¤çš„ç¬¬ä¸€é€‰æ‹©**; **ç”¨ RDB æ¥åšä¸åŒç¨‹åº¦çš„å†·å¤‡**ï¼Œåœ¨ AOF æ–‡ä»¶éƒ½ä¸¢å¤±æˆ–æŸåä¸å¯ç”¨çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ RDB æ¥è¿›è¡Œ**å¿«é€Ÿçš„æ•°æ®æ¢å¤**ã€‚

### Rediså“¨å…µæœºåˆ¶

#### åŠŸèƒ½

- é›†ç¾¤ç›‘æ§ï¼šè´Ÿè´£ç›‘æ§ Redis master å’Œ slave è¿›ç¨‹æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚
- æ¶ˆæ¯é€šçŸ¥ï¼šå¦‚æœæŸä¸ª Redis å®ä¾‹æœ‰æ•…éšœï¼Œé‚£ä¹ˆå“¨å…µè´Ÿè´£å‘é€æ¶ˆæ¯ä½œä¸ºæŠ¥è­¦é€šçŸ¥ç»™ç®¡ç†å‘˜ã€‚
- æ•…éšœè½¬ç§»ï¼šå¦‚æœ master node æŒ‚æ‰äº†ï¼Œä¼šè‡ªåŠ¨è½¬ç§»åˆ° slave node ä¸Šã€‚
- é…ç½®ä¸­å¿ƒï¼šå¦‚æœæ•…éšœè½¬ç§»å‘ç”Ÿäº†ï¼Œé€šçŸ¥ client å®¢æˆ·ç«¯æ–°çš„ master åœ°å€ã€‚

## æ ¸å¿ƒçŸ¥è¯†

- å“¨å…µ**è‡³å°‘éœ€è¦ 3 ä¸ªå®ä¾‹**ï¼Œæ¥ä¿è¯è‡ªå·±çš„å¥å£®æ€§ã€‚
  - å¦‚æœæ˜¯æ•´ä¸ª M1 å’Œ S1 è¿è¡Œçš„æœºå™¨å®•æœºäº†ï¼Œé‚£ä¹ˆå“¨å…µåªæœ‰ 1 ä¸ªï¼Œæ­¤æ—¶å°±æ²¡æœ‰ majority æ¥å…è®¸æ‰§è¡Œæ•…éšœè½¬ç§»ï¼Œè™½ç„¶å¦å¤–ä¸€å°æœºå™¨ä¸Šè¿˜æœ‰ä¸€ä¸ª R1ï¼Œä½†æ˜¯æ•…éšœè½¬ç§»ä¸ä¼šæ‰§è¡Œï¼›
  - 3 ä¸ªå“¨å…µçš„ majority æ˜¯ 2
- å“¨å…µ + Redis ä¸»ä»çš„éƒ¨ç½²æ¶æ„ï¼Œæ˜¯**ä¸ä¿è¯æ•°æ®é›¶ä¸¢å¤±**çš„ï¼Œåªèƒ½ä¿è¯ Redis é›†ç¾¤çš„é«˜å¯ç”¨æ€§ã€‚
- å¯¹äºå“¨å…µ + Redis ä¸»ä»è¿™ç§å¤æ‚çš„éƒ¨ç½²æ¶æ„ï¼Œå°½é‡åœ¨æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒï¼Œéƒ½è¿›è¡Œå……è¶³çš„æµ‹è¯•å’Œæ¼”ç»ƒã€‚

#### å“¨å…µä¸»å¤‡åˆ‡æ¢çš„æ•°æ®ä¸¢å¤±é—®é¢˜

```bash
min-slaves-to-write 1
min-slaves-max-lag 10
## è¡¨ç¤ºï¼Œè¦æ±‚è‡³å°‘æœ‰ 1 ä¸ª slaveï¼Œæ•°æ®å¤åˆ¶å’ŒåŒæ­¥çš„å»¶è¿Ÿä¸èƒ½è¶…è¿‡ 10 ç§’ã€‚
```

1. å¼‚æ­¥å¤åˆ¶å¯¼è‡´çš„æ•°æ®ä¸¢å¤±ï¼šmaster->slave çš„å¤åˆ¶æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å¯èƒ½æœ‰éƒ¨åˆ†æ•°æ®è¿˜æ²¡å¤åˆ¶åˆ° slaveï¼Œmaster å°±å®•æœºäº†ï¼Œæ­¤æ—¶è¿™éƒ¨åˆ†æ•°æ®å°±ä¸¢å¤±äº†ï¼›

   - è§£å†³æ–¹æ¡ˆï¼šæœ‰äº† `min-slaves-max-lag` è¿™ä¸ªé…ç½®ï¼Œå°±å¯ä»¥ç¡®ä¿è¯´ï¼Œä¸€æ—¦ slave å¤åˆ¶æ•°æ®å’Œ ack å»¶æ—¶å¤ªé•¿ï¼Œå°±è®¤ä¸º**å¯èƒ½ master å®•æœºåæŸå¤±çš„æ•°æ®å¤ªå¤šäº†**ï¼Œé‚£ä¹ˆå°±æ‹’ç»å†™è¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥æŠŠ master å®•æœºæ—¶ç”±äºéƒ¨åˆ†æ•°æ®æœªåŒæ­¥åˆ° slave å¯¼è‡´çš„æ•°æ®ä¸¢å¤±é™ä½çš„å¯æ§èŒƒå›´å†…ã€‚

2. è„‘è£‚å¯¼è‡´çš„æ•°æ®ä¸¢å¤±ï¼šæŸä¸ª master æ‰€åœ¨æœºå™¨çªç„¶**è„±ç¦»äº†æ­£å¸¸çš„ç½‘ç»œ**ï¼Œè·Ÿå…¶ä»– slave æœºå™¨ä¸èƒ½è¿æ¥ï¼Œä½†æ˜¯å®é™…ä¸Š master è¿˜è¿è¡Œç€ã€‚æ­¤æ—¶å“¨å…µå¯èƒ½å°±ä¼š**è®¤ä¸º** master å®•æœºäº†ï¼Œç„¶åå¼€å¯é€‰ä¸¾ï¼Œå°†å…¶ä»– slave åˆ‡æ¢æˆäº† masterã€‚è¿™ä¸ªæ—¶å€™ï¼Œé›†ç¾¤é‡Œå°±ä¼šæœ‰ä¸¤ä¸ª master ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„**è„‘è£‚**ï¼›

   æ­¤æ—¶è™½ç„¶æŸä¸ª slave è¢«åˆ‡æ¢æˆäº† masterï¼Œä½†æ˜¯å¯èƒ½ client **è¿˜æ²¡æ¥å¾—åŠåˆ‡æ¢**åˆ°æ–°çš„ masterï¼Œè¿˜ç»§ç»­å‘æ—§ master å†™æ•°æ®ã€‚å› æ­¤**æ—§ master å†æ¬¡æ¢å¤çš„æ—¶å€™ï¼Œä¼šè¢«ä½œä¸ºä¸€ä¸ª slave æŒ‚åˆ°æ–°çš„ master ä¸Šå»**ï¼Œè‡ªå·±çš„æ•°æ®ä¼š**æ¸…ç©º**ï¼Œé‡æ–°ä»æ–°çš„ master å¤åˆ¶æ•°æ®ã€‚è€Œ**æ–°çš„ master å¹¶æ²¡æœ‰åæ¥ client å†™å…¥çš„æ•°æ®**ï¼Œå› æ­¤ï¼Œè¿™éƒ¨åˆ†æ•°æ®ä¹Ÿå°±ä¸¢å¤±äº†ã€‚

   - è§£å†³æ–¹æ¡ˆï¼šå¦‚æœä¸€ä¸ª master å‡ºç°äº†è„‘è£‚ï¼Œè·Ÿå…¶ä»– slave ä¸¢äº†è¿æ¥ï¼Œé‚£ä¹ˆä¸Šé¢ä¸¤ä¸ªé…ç½®å¯ä»¥ç¡®ä¿è¯´ï¼Œå¦‚æœ**ä¸èƒ½ç»§ç»­ç»™æŒ‡å®šæ•°é‡**çš„ slave å‘é€æ•°æ®ï¼Œè€Œä¸” slave **è¶…è¿‡** 10 ç§’æ²¡æœ‰ç»™è‡ªå·± ack æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±ç›´æ¥**æ‹’ç»**å®¢æˆ·ç«¯çš„å†™è¯·æ±‚ã€‚å› æ­¤åœ¨è„‘è£‚åœºæ™¯ä¸‹ï¼Œ**æœ€å¤šå°±ä¸¢å¤± 10 ç§’çš„æ•°æ®**ã€‚

#### slave -> masteré€‰ä¸¾ç®—æ³•

å¦‚æœä¸€ä¸ª master è¢«è®¤ä¸º odown äº†ï¼Œè€Œä¸” majority æ•°é‡çš„å“¨å…µéƒ½å…è®¸ä¸»å¤‡åˆ‡æ¢ï¼Œé‚£ä¹ˆæŸä¸ªå“¨å…µå°±ä¼šæ‰§è¡Œä¸»å¤‡åˆ‡æ¢æ“ä½œï¼Œæ­¤æ—¶é¦–å…ˆè¦é€‰ä¸¾ä¸€ä¸ª slave æ¥ï¼Œä¼šè€ƒè™‘ slave çš„ä¸€äº›ä¿¡æ¯ï¼š

- è·Ÿ master æ–­å¼€è¿æ¥çš„æ—¶é•¿
- slave ä¼˜å…ˆçº§
- å¤åˆ¶ offset
- run id

å¦‚æœä¸€ä¸ª slave è·Ÿ master æ–­å¼€è¿æ¥çš„æ—¶é—´å·²ç»è¶…è¿‡äº† `down-after-milliseconds` çš„ 10 å€ï¼Œå¤–åŠ  master å®•æœºçš„æ—¶é•¿ï¼Œé‚£ä¹ˆ slave å°±è¢«è®¤ä¸ºä¸é€‚åˆé€‰ä¸¾ä¸º masterã€‚

```
(down-after-milliseconds * 10) + milliseconds_since_master_is_in_SDOWN_stateCopy to clipboardErrorCopied
```

æ¥ä¸‹æ¥ä¼šå¯¹ slave è¿›è¡Œæ’åºï¼š

- æŒ‰ç…§ slave ä¼˜å…ˆçº§è¿›è¡Œæ’åºï¼Œ**slave priority è¶Šä½ï¼Œä¼˜å…ˆçº§å°±è¶Šé«˜**ã€‚
- å¦‚æœ slave priority ç›¸åŒï¼Œé‚£ä¹ˆçœ‹ replica offse**tï¼Œå“ªä¸ª slave å¤åˆ¶äº†è¶Šå¤šçš„æ•°æ®ï¼Œoffset è¶Šé åï¼Œä¼˜å…ˆçº§å°±è¶Šé«˜**ã€‚
- å¦‚æœä¸Šé¢ä¸¤ä¸ªæ¡ä»¶éƒ½ç›¸åŒï¼Œé‚£ä¹ˆ**é€‰æ‹©ä¸€ä¸ª run id æ¯”è¾ƒå°**çš„é‚£ä¸ª slaveã€‚



## å¸¸è§é—®é¢˜

1. æ•°æ®ä¸ä¸€è‡´ï¼š
2. ç¼“å­˜é›ªå´©ã€ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ï¼š
3. ç¼“å­˜å¹¶å‘ç«äº‰ï¼š

### ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´æ€§

- æœ€åˆçº§çš„ç¼“å­˜ä¸ä¸€è‡´é—®é¢˜ï¼šå…ˆ**æ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜**ã€‚å¦‚æœåˆ é™¤ç¼“å­˜å¤±è´¥äº†ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´æ•°æ®åº“ä¸­æ˜¯æ–°æ•°æ®ï¼Œç¼“å­˜ä¸­æ˜¯æ—§æ•°æ®ï¼Œæ•°æ®å°±å‡ºç°äº†ä¸ä¸€è‡´ã€‚
  - è§£å†³æ–¹æ¡ˆï¼š
    - **å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“**ã€‚å¦‚æœåˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œå°±ä¸ä¼šæ›´æ–°æ•°æ®åº“ï¼›å¦‚æœæ•°æ®åº“æ›´æ–°å¤±è´¥äº†ï¼Œé‚£ä¹ˆæ•°æ®åº“ä¸­æ˜¯æ—§æ•°æ®ï¼Œç¼“å­˜ä¸­æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆæ•°æ®ä¸ä¼šä¸ä¸€è‡´ã€‚å› ä¸ºè¯»çš„æ—¶å€™ç¼“å­˜æ²¡æœ‰ï¼Œæ‰€ä»¥å»è¯»äº†æ•°æ®åº“ä¸­çš„**æ—§æ•°æ®**ï¼Œç„¶åæ›´æ–°åˆ°ç¼“å­˜ä¸­ï¼›

### ç¼“å­˜é›ªå´©

- ç¼“å­˜æ„å¤–å®•æœºå¯¼è‡´ï¼Œç¼“å­˜æŒ‚æ‰ï¼Œå¤§é‡è¯·æ±‚è½åœ¨æ•°æ®åº“ä¸Šï¼›
- è§£å†³æ–¹æ¡ˆï¼š
  - äº‹å‰ï¼šRedisé«˜å¯ç”¨ï¼Œä¸»ä»+å“¨å…µï¼Œé¿å…å…¨ç›˜å´©æºƒï¼›
  - äº‹ä¸­ï¼šæœ¬åœ°ç¼“å­˜+hystrixé™æµ&é™çº§ï¼Œé¿å…mysqlè¢«æ‰“æ­»ï¼›
  - äº‹åï¼šRedisæŒä¹…åŒ–ï¼Œä¸€æ—¦é‡å¯ï¼Œè‡ªåŠ¨ä»ç£ç›˜ä¸ŠåŠ è½½æ•°æ®ï¼Œå¿«é€Ÿå›å¤ç¼“å­˜æ•°æ®ï¼›

### ç¼“å­˜ç©¿é€

- æ¯”å¦‚æ˜¯æ¶æ„æ”»å‡»ï¼Œå‘å‡ºå¤§é‡åœ¨ç¼“å­˜æŸ¥ä¸åˆ°å€¼çš„è¯·æ±‚ï¼Œç„¶åå°±ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œç›´æ¥ç©¿é€ç¼“å­˜å°†æ•°æ®åº“æ‰“æ­»ï¼›
- è§£å†³æ–¹æ¡ˆï¼š
  - æ¯æ¬¡ç³»ç»Ÿ A ä»æ•°æ®åº“ä¸­åªè¦æ²¡æŸ¥åˆ°ï¼Œå°±**å†™ä¸€ä¸ªç©ºå€¼åˆ°ç¼“å­˜**é‡Œå»ï¼Œæ¯”å¦‚ `set -999 UNKNOWN` ã€‚ç„¶åè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„è¯ï¼Œä¸‹æ¬¡æœ‰ç›¸åŒçš„ key æ¥è®¿é—®çš„æ—¶å€™ï¼Œåœ¨ç¼“å­˜å¤±æ•ˆä¹‹å‰ï¼Œéƒ½å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­å–æ•°æ®ï¼›

### ç¼“å­˜å‡»ç©¿

- æŸä¸ª key éå¸¸çƒ­ç‚¹ï¼Œè®¿é—®éå¸¸é¢‘ç¹ï¼Œå¤„äºé›†ä¸­å¼é«˜å¹¶å‘è®¿é—®çš„æƒ…å†µï¼Œå½“è¿™ä¸ª **key åœ¨å¤±æ•ˆçš„ç¬é—´**ï¼Œå¤§é‡çš„è¯·æ±‚å°±å‡»ç©¿äº†ç¼“å­˜ï¼Œç›´æ¥è¯·æ±‚æ•°æ®åº“ï¼Œå°±åƒæ˜¯åœ¨ä¸€é“å±éšœä¸Šå‡¿å¼€äº†ä¸€ä¸ªæ´;
- è§£å†³æ–¹æ¡ˆï¼ˆ**ç¼“å­˜çš„æ•°æ®æ›´æ–°æ—¶é—´**çš„è§’åº¦ï¼‰ï¼š
  - åŸºæœ¬ä¸æ›´æ–°ï¼šå°†çƒ­ç‚¹æ•°æ®è®¾ç½®ä¸ºæ°¸ä¸è¿‡æœŸï¼›
  - æ›´æ–°ä¸é¢‘ç¹ï¼Œä¸”ç¼“å­˜åˆ·æ–°çš„æµç¨‹è€—æ—¶è¾ƒå°‘ï¼šé‡‡ç”¨**äº’æ–¥é”**çš„æ–¹å¼ä¿è¯ä»…å°‘é‡çš„è¯·æ±‚å»è¯·æ±‚æ•°æ®åº“å¹¶é‡æ–°æ„å»ºç¼“å­˜ï¼Œå…¶ä½™è¯·æ±‚åœ¨é”é‡Šæ”¾åå¯ä»¥è®¿é—®åˆ°æ–°ç¼“å­˜ï¼›
  - æ›´æ–°é¢‘ç¹ï¼Œæˆ–è€…ç¼“å­˜åˆ·æ–°çš„æµç¨‹è€—æ—¶è¾ƒé•¿ï¼šåˆ©ç”¨**å®šæ—¶çº¿ç¨‹**åœ¨ç¼“å­˜è¿‡æœŸå‰**ä¸»åŠ¨**åœ°é‡æ–°æ„å»ºç¼“å­˜æˆ–è€…**å»¶å**ç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼Œä»¥ä¿è¯æ‰€æœ‰çš„è¯·æ±‚èƒ½ä¸€ç›´è®¿é—®åˆ°å¯¹åº”çš„ç¼“å­˜ï¼›

### Rediså¹¶å‘ç«äº‰é—®é¢˜

- Redisè‡ªå¸¦CASç±»çš„**ä¹è§‚é”**æ–¹æ¡ˆï¼šè¦å†™å…¥ç¼“å­˜çš„æ•°æ®ï¼Œéƒ½æ˜¯ä»mysqlé‡ŒæŸ¥å‡ºæ¥çš„ï¼Œåœ¨å†™å…¥mysqlä¸­å¿…é¡»ä¿å­˜ä¸€ä¸ª**æ—¶é—´æˆ³**ï¼Œä»mysqlæŸ¥å‡ºæ¥çš„æ—¶å€™ï¼Œæ—¶é—´æˆ³ä¹ŸæŸ¥å‡ºæ¥ã€‚æ¯æ¬¡å†™å…¥ç¼“å­˜ä¹‹å‰ï¼Œå…ˆåˆ¤æ–­å½“å‰çš„valueçš„æ—¶é—´æˆ³æ˜¯å¦æ¯”ç¼“å­˜é‡Œçš„è¦æ–°ï¼Œå¦‚æœæ˜¯ï¼Œå°±å¯ä»¥å†™å…¥ï¼Œå¦åˆ™å°±ä¸èƒ½å»è¦†ç›–æ–°çš„æ•°æ®ã€‚

## æœ¬åœ°ç¼“å­˜

Google Guava

Ehcache

Caxxxxx

# JavaåŸºç¡€

## å¤šæ€

å¤šæ€çš„å®ç°è¿‡ç¨‹ï¼Œå¯ä»¥è¯´æ˜¯**æ–¹æ³•è°ƒç”¨åŠ¨æ€åˆ†æ´¾**çš„è¿‡ç¨‹ï¼Œé€šè¿‡æ ˆå¸§çš„ä¿¡æ¯å»æ‰¾åˆ°è¢«è°ƒç”¨æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªå…·ä½“å®ç°çš„ç›´æ¥å¼•ç”¨å®Œæˆæ–¹æ³•è°ƒç”¨ã€‚

ä»¥ invokevirtual æŒ‡ä»¤ä¸ºä¾‹ï¼Œåœ¨æ‰§è¡Œæ—¶ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

1. å…ˆä»æ“ä½œæ ˆä¸­æ‰¾åˆ°å¯¹è±¡çš„å®é™…ç±»å‹ classï¼›
2. æ‰¾åˆ° class ä¸­ä¸è¢«è°ƒç”¨æ–¹æ³•ç­¾åç›¸åŒçš„æ–¹æ³•ï¼Œå¦‚æœæœ‰è®¿é—®æƒé™å°±è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼Œå¦‚æœæ²¡æœ‰è®¿é—®æƒé™å°±æŠ¥é”™ java.lang.IllegalAccessError ï¼›
3. å¦‚æœç¬¬ 2 æ­¥æ‰¾ä¸åˆ°ç›¸ç¬¦çš„æ–¹æ³•ï¼Œå°±å»æœç´¢ class çš„çˆ¶ç±»ï¼ŒæŒ‰ç…§ç»§æ‰¿å…³ç³»è‡ªä¸‹è€Œä¸Šä¾æ¬¡æ‰§è¡Œç¬¬ 2 æ­¥çš„æ“ä½œï¼›
4. å¦‚æœç¬¬ 3 æ­¥æ‰¾ä¸åˆ°ç›¸ç¬¦çš„æ–¹æ³•ï¼Œå°±æŠ¥é”™ java.lang.AbstractMethodError ï¼›

å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå­ç±»è¦†ç›–äº†çˆ¶ç±»çš„æ–¹æ³•ï¼Œåˆ™åœ¨å¤šæ€è°ƒç”¨ä¸­ï¼ŒåŠ¨æ€ç»‘å®šè¿‡ç¨‹ä¼šé¦–å…ˆç¡®å®šå®é™…ç±»å‹æ˜¯å­ç±»ï¼Œä»è€Œå…ˆæœç´¢åˆ°å­ç±»ä¸­çš„æ–¹æ³•ã€‚è¿™ä¸ªè¿‡ç¨‹ä¾¿æ˜¯æ–¹æ³•è¦†ç›–çš„æœ¬è´¨ã€‚

# Javaå®¹å™¨

## [ArrayList](https://snailclimb.gitee.io/javaguide/#/docs/java/collection/ArrayList)

### [æ‰©å®¹æœºåˆ¶](https://blog.csdn.net/zymx14/article/details/78324464?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.channel_param&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.channel_param)

1. **æœ€å¼€å§‹æ˜¯ä¸€ä¸ªç©ºæ•°ç»„**ï¼Œå½“æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™æ•°ç»„å®¹é‡æ‰å˜æˆ10ï¼š

~~~java
private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = {};

public ArrayList() {
	this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;
}
~~~

2. åœ¨ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ è°ƒç”¨`add()`æ—¶ï¼Œæ‰å¼€å§‹è®¾ç½®å®¹é‡ï¼›

~~~java
private static final int DEFAULT_CAPACITY = 10;
public boolean add(E e) {
    // æœ€å¼€å§‹sizeä¸º0
    ensureCapacityInternal(size + 1);  // Increments modCount!!
    //è¿™é‡Œçœ‹åˆ°ArrayListæ·»åŠ å…ƒç´ çš„å®è´¨å°±ç›¸å½“äºä¸ºæ•°ç»„èµ‹å€¼
    elementData[size++] = e;
    return true;
}
 private void ensureCapacityInternal(int minCapacity) {
     if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
         // è·å–â€œé»˜è®¤çš„å®¹é‡â€å’Œâ€œä¼ å…¥å‚æ•°â€ä¸¤è€…ä¹‹é—´çš„æœ€å¤§å€¼
         minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);
     }

     ensureExplicitCapacity(minCapacity);
 }
~~~

3. æ‰©å®¹å‰çš„åˆ¤æ–­ï¼›

~~~java
//åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹
private void ensureExplicitCapacity(int minCapacity) {
    modCount++;

    // overflow-conscious code
    if (minCapacity - elementData.length > 0)
        //è°ƒç”¨growæ–¹æ³•è¿›è¡Œæ‰©å®¹ï¼Œè°ƒç”¨æ­¤æ–¹æ³•ä»£è¡¨å·²ç»å¼€å§‹æ‰©å®¹äº†
        grow(minCapacity);
}

~~~

4. æ‰©å®¹çš„æ ¸å¿ƒæ–¹æ³•ï¼š
   * åœ¨`grow()`æ–¹æ³•æœ€åï¼Œè°ƒç”¨`Arrays.copyof`æ–¹æ³•ï¼Œå³**å¤åˆ¶**åŸæ•°ç»„å†…å®¹åˆ°ä¸€ä¸ªæ–°å®¹é‡çš„å¤§æ•°ç»„é‡Œã€‚è¿™é‡Œ`Arrays.copyof`æ–¹æ³•å®é™…æ˜¯è°ƒç”¨`System.arraycopy`æ–¹æ³•ã€‚

~~~java
// ä¸€äº›vmå¯èƒ½ä¼šåœ¨æ•°ç»„ä¸­ä¿ç•™ä¸€äº›headerä¿¡æ¯ï¼Œåˆ†é…æ›´å¤§çš„é•¿åº¦å¯èƒ½ä¼šå¯¼è‡´OutOfMemoryErrorå¼‚å¸¸
private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;

/**
 * ArrayListæ‰©å®¹çš„æ ¸å¿ƒæ–¹æ³•ã€‚
 */
private void grow(int minCapacity) {
    // oldCapacityä¸ºæ—§å®¹é‡ï¼ŒnewCapacityä¸ºæ–°å®¹é‡
    int oldCapacity = elementData.length;
    //å°†oldCapacity å³ç§»ä¸€ä½ï¼Œå…¶æ•ˆæœç›¸å½“äºoldCapacity /2ï¼Œ
    //æˆ‘ä»¬çŸ¥é“ä½è¿ç®—çš„é€Ÿåº¦è¿œè¿œå¿«äºæ•´é™¤è¿ç®—ï¼Œæ•´å¥è¿ç®—å¼çš„ç»“æœå°±æ˜¯å°†æ–°å®¹é‡æ›´æ–°ä¸ºæ—§å®¹é‡çš„1.5å€ï¼Œ
    int newCapacity = oldCapacity + (oldCapacity >> 1);
    //ç„¶åæ£€æŸ¥æ–°å®¹é‡æ˜¯å¦å¤§äºæœ€å°éœ€è¦å®¹é‡ï¼Œè‹¥è¿˜æ˜¯å°äºæœ€å°éœ€è¦å®¹é‡ï¼Œé‚£ä¹ˆå°±æŠŠæœ€å°éœ€è¦å®¹é‡å½“ä½œæ•°ç»„çš„æ–°å®¹é‡ï¼Œ
    if (newCapacity - minCapacity < 0)
        newCapacity = minCapacity;
    //å†æ£€æŸ¥æ–°å®¹é‡æ˜¯å¦è¶…å‡ºäº†ArrayListæ‰€å®šä¹‰çš„æœ€å¤§å®¹é‡ï¼Œ
    //è‹¥è¶…å‡ºäº†ï¼Œåˆ™è°ƒç”¨hugeCapacity()æ¥æ¯”è¾ƒminCapacityå’Œ MAX_ARRAY_SIZEï¼Œ
    //å¦‚æœminCapacityå¤§äºMAX_ARRAY_SIZEï¼Œåˆ™æ–°å®¹é‡åˆ™ä¸ºInterger.MAX_VALUEï¼Œå¦åˆ™ï¼Œæ–°å®¹é‡å¤§å°åˆ™ä¸º MAX_ARRAY_SIZEã€‚
    if (newCapacity - MAX_ARRAY_SIZE > 0)
        newCapacity = hugeCapacity(minCapacity);
    // minCapacity is usually close to size, so this is a win:
    elementData = Arrays.copyOf(elementData, newCapacity);
}

//æ¯”è¾ƒminCapacityå’Œ MAX_ARRAY_SIZE
private static int hugeCapacity(int minCapacity) {
    // ç‰¹åˆ«æ³¨æ„ï¼šint a = Integer.MAX_VALUE + 1ï¼›æ­¤æ—¶a < 0
    if (minCapacity < 0) // overflow
        throw new OutOfMemoryError();
    return (minCapacity > MAX_ARRAY_SIZE) ?
        Integer.MAX_VALUE :
    MAX_ARRAY_SIZE;
}
~~~



# JVM

## JVMå†…å­˜ç»“æ„

### ç¨‹åºè®¡æ•°å™¨

- ä½œç”¨ï¼š
  1. å­—èŠ‚ç è§£é‡Šå™¨é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨æ¥ä¾æ¬¡è¯»å–æŒ‡ä»¤ï¼Œä»è€Œå®ç°ä»£ç çš„æµç¨‹æ§åˆ¶ï¼›
  2. åœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œè®°å½•çš„æ˜¯å½“å‰çº¿ç¨‹çš„æ‰§è¡Œä½ç½®ï¼Œçº¿ç¨‹åˆ‡æ¢å›æ¥å°±çŸ¥é“ä»å“ªå¼€å§‹ç»§ç»­æ‰§è¡Œï¼›
- ç‰¹ç‚¹ï¼š
  1. å†…å­˜ç©ºé—´å°
  2. çº¿ç¨‹ç§æœ‰
  3. ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹æŒ‚é’©
  4. å”¯ä¸€ä¸ä¼šå‡ºç°OOMçš„å†…å­˜åŒºåŸŸ

### javaè™šæ‹Ÿæœºæ ˆ

æè¿°javaæ–¹æ³•è¿è¡Œè¿‡ç¨‹çš„å†…å­˜æ¨¡å‹

è™šæ‹Ÿæœºæ ˆä¸ºæ¯ä¸€ä¸ªå³å°†è¿è¡Œçš„javaæ–¹æ³•åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œé‡Œé¢å­˜æ”¾ï¼šå±€éƒ¨å˜é‡è¡¨(åŸºæœ¬ç±»å‹ã€å¯¹è±¡çš„å¼•ç”¨å’Œ`returnAddress`)ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ä¿¡æ¯ç­‰ï¼›

- å‡ºæ ˆå‹æ ˆçš„è¿‡ç¨‹ï¼š
  1. æ–¹æ³•åˆ›å»ºï¼Œå±€éƒ¨å˜é‡å­˜å…¥æ ˆå¸§çš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼›
  2. æ ˆé¡¶æ ˆå¸§ä¸ºæ­£åœ¨æ‰§è¡Œçš„æ´»åŠ¨æ ˆï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼Œåˆ›æ–°æ–°çš„æ ˆå¸§å‹å…¥æ ˆé¡¶ï¼›
  3. æ–¹æ³•ç»“æŸ(returnæˆ–è€…æŠ›å‡ºå¼‚å¸¸)ï¼Œæ ˆå¸§ç§»é™¤ï¼Œè¿”å›å€¼(å¦‚æœæœ‰)å˜ä¸ºæ ˆé¡¶æ ˆå¸§ä¸­æ“ä½œæ•°æ ˆçš„ä¸€ä¸ªæ“ä½œæ•°
- ç‰¹ç‚¹ï¼š
  1. **å±€éƒ¨å˜é‡è¡¨**éšç€æ ˆå¸§çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œå®ƒçš„**å¤§å°åœ¨ç¼–è¯‘æ—¶ç¡®å®š**ï¼Œåˆ›å»ºæ—¶åªéœ€åˆ†é…äº‹å…ˆè§„å®šçš„å¤§å°å³å¯ã€‚åœ¨æ–¹æ³•è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå±€éƒ¨å˜é‡è¡¨çš„å¤§å°ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚
  2. Java è™šæ‹Ÿæœºæ ˆä¼šå‡ºç°ä¸¤ç§å¼‚å¸¸ï¼šStackOverFlowError å’Œ OutOfMemoryError
     - StackOverFlowError è‹¥ Java è™šæ‹Ÿæœºæ ˆçš„å¤§å°**ä¸å…è®¸åŠ¨æ€æ‰©å±•**ï¼Œé‚£ä¹ˆå½“**çº¿ç¨‹è¯·æ±‚æ ˆçš„æ·±åº¦è¶…è¿‡å½“å‰ Java è™šæ‹Ÿæœºæ ˆçš„æœ€å¤§æ·±åº¦**æ—¶ï¼ŒæŠ›å‡º StackOverFlowError å¼‚å¸¸ï¼›
     - OutOfMemoryError è‹¥**å…è®¸åŠ¨æ€æ‰©å±•**ï¼Œé‚£ä¹ˆå½“çº¿ç¨‹è¯·æ±‚æ ˆæ—¶**å†…å­˜ç”¨å®Œäº†ï¼Œæ— æ³•å†åŠ¨æ€æ‰©å±•**æ—¶ï¼ŒæŠ›å‡º OutOfMemoryError å¼‚å¸¸ï¼›
  3. Java è™šæ‹Ÿæœºæ ˆä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰ï¼Œéšç€çº¿ç¨‹åˆ›å»ºè€Œåˆ›å»ºï¼Œéšç€çº¿ç¨‹çš„ç»“æŸè€Œé”€æ¯ï¼›

### æœ¬åœ°æ–¹æ³•æ ˆ

æœ¬åœ°æ–¹æ³•æ ˆæ˜¯ä¸º JVM è¿è¡Œ Native æ–¹æ³•å‡†å¤‡çš„ç©ºé—´ï¼Œç”±äºå¾ˆå¤š Native æ–¹æ³•éƒ½æ˜¯ç”¨ C è¯­è¨€å®ç°çš„ï¼Œæ‰€ä»¥å®ƒé€šå¸¸åˆå« C æ ˆã€‚å®ƒä¸ Java è™šæ‹Ÿæœºæ ˆå®ç°çš„åŠŸèƒ½ç±»ä¼¼ï¼Œåªä¸è¿‡æœ¬åœ°æ–¹æ³•æ ˆæ˜¯æè¿°æœ¬åœ°æ–¹æ³•è¿è¡Œè¿‡ç¨‹çš„å†…å­˜æ¨¡å‹ã€‚

### å †

å †æ˜¯ç”¨æ¥å­˜æ”¾å¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜å‚¨åœ¨å †ä¸­ã€‚

- ç‰¹ç‚¹
  - **çº¿ç¨‹å…±äº«**ï¼Œæ•´ä¸ª Java è™šæ‹Ÿæœºåªæœ‰ä¸€ä¸ªå †ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½è®¿é—®åŒä¸€ä¸ªå †ã€‚è€Œç¨‹åºè®¡æ•°å™¨ã€Java è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆéƒ½æ˜¯ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªã€‚
  - åœ¨è™šæ‹Ÿæœº**å¯åŠ¨æ—¶åˆ›å»º**ã€‚
  - æ˜¯åƒåœ¾å›æ”¶çš„ä¸»è¦åœºæ‰€ã€‚
  - è¿›ä¸€æ­¥å¯åˆ†ä¸ºï¼š**æ–°ç”Ÿä»£**(EdenåŒº From Survior To Survivor)ã€**è€å¹´ä»£**ã€‚

### æ–¹æ³•åŒº

æ–¹æ³•åŒºä¸ Java å †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œå®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®

### å…ƒæ•°æ®åŒº

JDK1.7å‰å«æ°¸ä¹…ä»£ï¼Œéƒ½æ˜¯æ–¹æ³•åŒºçš„å®ç°æ–¹å¼ï¼Œå› ä¸ºæ°¸ä¹…ä»£å—JVMè®¾ç½®å›ºå®šå¤§å°çš„é™åˆ¶ï¼Œæ— æ³•è¿›è¡Œè°ƒæ•´ï¼Œè€Œ**å…ƒç©ºé—´ç›´æ¥ä½¿ç”¨å†…å­˜**ï¼Œå—æœ¬æœºå¯ç”¨å†…å­˜çš„é™åˆ¶ï¼Œå†…å­˜æº¢å‡ºçš„æƒ…å†µæ›´å°‘ï¼›

## Javaå†…å­˜ç›¸å…³çŸ¥è¯†

### å†…å­˜å±éšœ

ä¸ºäº†è§£å†³é‡æ’åºé—®é¢˜ï¼Œå¤„ç†å™¨æä¾›å†…å­˜å±éšœæŒ‡ä»¤ï¼š

* å†™å†…å­˜å±éšœï¼šå¤„ç†å™¨å°†å­˜å‚¨ç¼“å­˜å€¼å†™å›ä¸»å­˜
* è¯»å†…å­˜å±éšœï¼šå¤„ç†å™¨å¤„ç†å¤±æ•ˆé˜Ÿåˆ—

`valatile`è¯»å‰æ’è¯»å±éšœï¼Œå†™ååŠ å†™å±éšœï¼Œé¿å…CPUé‡æ’å¯¼è‡´çš„å¯è§æ€§é—®é¢˜ï¼›

#### å†…å­˜å±éšœçš„ç§ç±»

`storeLoad`ï¼šå¼€é”€æœ€å¤§ï¼Œå…·æœ‰å››ç§å†…å­˜å±éšœåŠŸèƒ½ï¼›

`lock`ï¼š

`volatile`ï¼š

`final`ï¼š

## å››ç§å¼•ç”¨ç±»å‹

### 1. å¼ºå¼•ç”¨

ä¸ä¼šè¢«å›æ”¶ï¼›

### 2. è½¯å¼•ç”¨

å†…å­˜è¶³å¤Ÿï¼Œä¸ä¼šå›æ”¶ï¼›å†…å­˜ä¸è¶³ï¼Œæ‰å»å›æ”¶ï¼›

### 3. å¼±å¼•ç”¨

åƒåœ¾å›æ”¶å™¨ä¸€æ—¦å‘ç°åªå…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œä¸ç®¡å†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰ï¼›

### 4. è™šå¼•ç”¨

å½¢åŒè™šè®¾ï¼Œä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨ï¼Œå°±å’Œæ²¡æœ‰ä»»ä½•å¼•ç”¨ä¸€æ ·ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶ã€‚

**è™šå¼•ç”¨ä¸»è¦ç”¨æ¥è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ´»åŠ¨**ã€‚

### æ³¨æ„

åœ¨ç¨‹åºè®¾è®¡ä¸­ä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨å¼±å¼•ç”¨ä¸è™šå¼•ç”¨ï¼Œä½¿ç”¨**è½¯å¼•ç”¨çš„æƒ…å†µè¾ƒå¤š**ï¼Œè¿™æ˜¯å› ä¸º**è½¯å¼•ç”¨å¯ä»¥åŠ é€Ÿ JVM å¯¹åƒåœ¾å†…å­˜çš„å›æ”¶é€Ÿåº¦ï¼Œå¯ä»¥ç»´æŠ¤ç³»ç»Ÿçš„è¿è¡Œå®‰å…¨ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºï¼ˆOutOfMemoryï¼‰ç­‰é—®é¢˜çš„äº§ç”Ÿ**ã€‚

## JVMå†…å­˜åˆ†é…ä¸å›æ”¶

![JVMå †å†…å­˜åˆ†é…](assets/JVM%E5%A0%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D.png)

- å¤§éƒ¨åˆ†æƒ…å†µï¼Œå¯¹è±¡éƒ½ä¼šé¦–å…ˆåœ¨ **Eden åŒº**åŸŸåˆ†é…ï¼Œ**åœ¨ä¸€æ¬¡æ–°ç”Ÿä»£åƒåœ¾å›æ”¶å**ï¼Œå¦‚æœå¯¹è±¡è¿˜å­˜æ´»ï¼Œåˆ™ä¼šè¿›å…¥ **s0 æˆ–è€… s1**ï¼Œå¹¶ä¸”å¯¹è±¡çš„**å¹´é¾„è¿˜ä¼šåŠ  1**(Eden åŒº->Survivor åŒºåå¯¹è±¡çš„åˆå§‹å¹´é¾„å˜ä¸º 1)ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆ**é»˜è®¤ä¸º 15 å²**ï¼‰ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°**è€å¹´ä»£**ä¸­ã€‚å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡å‚æ•° `-XX:MaxTenuringThreshold` æ¥è®¾ç½®ã€‚å½“**ç´¯ç§¯çš„æŸä¸ªå¹´é¾„å¤§å°è¶…è¿‡äº†survivoråŒºçš„ä¸€åŠæ—¶**ï¼Œå–è¿™ä¸ªå¹´é¾„å’ŒMaxTenuringThresholdä¸­æ›´å°çš„ä¸€ä¸ªå€¼ï¼Œä½œä¸ºæ–°çš„æ™‹å‡å¹´é¾„é˜ˆå€¼ã€‚

![å †å†…å­˜åˆ†é…ç­–ç•¥](assets/%E5%A0%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5.png)



- ç»è¿‡ä¸€æ¬¡GCåï¼ŒEdenåŒºå’Œ"From"åŒºå·²ç»è¢«æ¸…ç©ºã€‚è¿™ä¸ªæ—¶å€™ï¼Œ**"From"å’Œ"To"ä¼šäº¤æ¢ä»–ä»¬çš„è§’è‰²**ï¼Œä¹Ÿå°±æ˜¯æ–°çš„"To"å°±æ˜¯ä¸Šæ¬¡GCå‰çš„â€œFromâ€ï¼Œæ–°çš„"From"å°±æ˜¯ä¸Šæ¬¡GCå‰çš„"To"ã€‚ä¸ç®¡æ€æ ·ï¼Œéƒ½ä¼š**ä¿è¯åä¸ºToçš„SurvivoråŒºåŸŸæ˜¯ç©ºçš„**ã€‚Minor GCä¼šä¸€ç›´é‡å¤è¿™æ ·çš„è¿‡ç¨‹ï¼Œç›´åˆ°â€œToâ€åŒºè¢«å¡«æ»¡ï¼Œ**"To"åŒºè¢«å¡«æ»¡ä¹‹åï¼Œä¼šå°†æ‰€æœ‰å¯¹è±¡ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­**ã€‚

* å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£ä¸­ eden åŒºåˆ†é…ã€‚**å½“ eden åŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡ Minor GCï¼›**

* å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼šä¸ºäº†é¿å…ä¸ºå¤§å¯¹è±¡åˆ†é…å†…å­˜æ—¶ç”±äº**åˆ†é…æ‹…ä¿**æœºåˆ¶å¸¦æ¥çš„å¤åˆ¶è€Œé™ä½æ•ˆç‡ï¼›

## åƒåœ¾å›æ”¶

ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆéšçº¿ç¨‹è€Œç”Ÿï¼Œä¹Ÿéšçº¿ç¨‹è€Œç­ï¼›æ ˆå¸§éšç€æ–¹æ³•çš„å¼€å§‹è€Œå…¥æ ˆï¼Œéšç€æ–¹æ³•çš„ç»“æŸè€Œå‡ºæ ˆã€‚è¿™å‡ ä¸ªåŒºåŸŸçš„å†…å­˜åˆ†é…å’Œå›æ”¶éƒ½å…·æœ‰**ç¡®å®šæ€§**ï¼Œåœ¨è¿™å‡ ä¸ªåŒºåŸŸå†…ä¸éœ€è¦è¿‡å¤šè€ƒè™‘å›æ”¶çš„é—®é¢˜ï¼Œå› ä¸ºæ–¹æ³•ç»“æŸæˆ–è€…çº¿ç¨‹ç»“æŸæ—¶ï¼Œå†…å­˜è‡ªç„¶å°±è·Ÿéšç€å›æ”¶äº†ã€‚

è€Œå¯¹äº Java å †å’Œæ–¹æ³•åŒºï¼Œæˆ‘ä»¬åªæœ‰åœ¨ç¨‹åºè¿è¡ŒæœŸé—´æ‰èƒ½çŸ¥é“ä¼šåˆ›å»ºå“ªäº›å¯¹è±¡ï¼Œè¿™éƒ¨åˆ†å†…å­˜çš„**åˆ†é…å’Œå›æ”¶éƒ½æ˜¯åŠ¨æ€çš„**ï¼Œåƒåœ¾æ”¶é›†å™¨æ‰€å…³æ³¨çš„æ­£æ˜¯è¿™éƒ¨åˆ†å†…å­˜ã€‚

- åˆ¤å®šå¯¹è±¡æ˜¯å¦å­˜æ´»ï¼šè‹¥ä¸€ä¸ªå¯¹è±¡**ä¸è¢«ä»»ä½•å¯¹è±¡æˆ–å˜é‡å¼•ç”¨**ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯æ— æ•ˆå¯¹è±¡ï¼Œéœ€è¦è¢«å›æ”¶ã€‚
- åœ¨å¯è¾¾æ€§åˆ†ææ³•ä¸­ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œä¹Ÿ**å¹¶éæ˜¯â€œéæ­»ä¸å¯â€**çš„ï¼Œè¿™æ—¶å€™å®ƒä»¬æš‚æ—¶å¤„äºâ€œç¼“åˆ‘é˜¶æ®µâ€ï¼Œè¦çœŸæ­£å®£å‘Šä¸€ä¸ªå¯¹è±¡æ­»äº¡ï¼Œè‡³å°‘è¦ç»å†**ä¸¤æ¬¡æ ‡è®°**è¿‡ç¨‹ï¼›å¯è¾¾æ€§åˆ†ææ³•ä¸­ä¸å¯è¾¾çš„å¯¹è±¡è¢«ç¬¬ä¸€æ¬¡æ ‡è®°å¹¶ä¸”è¿›è¡Œä¸€æ¬¡ç­›é€‰ï¼Œç­›é€‰çš„æ¡ä»¶æ˜¯æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œ finalize æ–¹æ³•ã€‚å½“å¯¹è±¡**æ²¡æœ‰è¦†ç›– finalize æ–¹æ³•**ï¼Œæˆ– finalize æ–¹æ³•**å·²ç»è¢«è™šæ‹Ÿæœºè°ƒç”¨è¿‡**æ—¶ï¼Œè™šæ‹Ÿæœºå°†è¿™ä¸¤ç§æƒ…å†µè§†ä¸ºæ²¡æœ‰å¿…è¦æ‰§è¡Œã€‚è¢«åˆ¤å®šä¸ºéœ€è¦æ‰§è¡Œçš„å¯¹è±¡å°†ä¼šè¢«**æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­è¿›è¡Œç¬¬äºŒæ¬¡æ ‡è®°**ï¼Œé™¤éè¿™ä¸ªå¯¹è±¡ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹å…³è”ï¼Œå¦åˆ™å°±ä¼šè¢«çœŸçš„å›æ”¶ã€‚

* **åºŸå¼ƒå¸¸é‡**ï¼šæ¯”å¦‚ï¼Œåœ¨å¸¸é‡æ± ä¸­å­˜åœ¨å­—ç¬¦ä¸² "abc"ï¼Œå¦‚æœå½“å‰æ²¡æœ‰ä»»ä½• String å¯¹è±¡å¼•ç”¨è¯¥å­—ç¬¦ä¸²å¸¸é‡çš„è¯ï¼Œå°±è¯´æ˜å¸¸é‡ "abc" å°±æ˜¯åºŸå¼ƒå¸¸é‡ï¼›
* **æ— ç”¨çš„ç±»**ï¼š3ä¸ªæ¡ä»¶ï¼š
  1. è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­**ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹**ï¼›
  2. åŠ è½½è¯¥ç±»çš„ **ClassLoader** å·²ç»è¢«å›æ”¶ï¼›
  3. è¯¥ç±»å¯¹åº”çš„ **java.lang.Class å¯¹è±¡**æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ï¼›



### ç­–ç•¥

- **å¼•ç”¨è®¡æ•°æ³•**ï¼šåœ¨å¯¹è±¡å¤´ç»´æŠ¤ç€ä¸€ä¸ª **counter è®¡æ•°å™¨**ï¼Œå¯¹è±¡è¢«å¼•ç”¨ä¸€æ¬¡åˆ™è®¡æ•°å™¨ +1ï¼›è‹¥å¼•ç”¨å¤±æ•ˆåˆ™è®¡æ•°å™¨ -1ã€‚å½“è®¡æ•°å™¨ä¸º 0 æ—¶ï¼Œå°±è®¤ä¸ºè¯¥å¯¹è±¡æ— æ•ˆäº†ã€‚
  - è™½ç„¶æ•ˆç‡é«˜ï¼Œä½†å¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼›
- **å¯è¾¾æ€§åˆ†ææ³•**ï¼šæ‰€æœ‰å’Œ GC Roots ç›´æ¥æˆ–é—´æ¥å…³è”çš„å¯¹è±¡éƒ½æ˜¯æœ‰æ•ˆå¯¹è±¡ï¼Œå’Œ GC Roots æ²¡æœ‰å…³è”çš„å¯¹è±¡å°±æ˜¯æ— æ•ˆå¯¹è±¡ã€‚
  - GC RootsæŒ‡ï¼š
    1. Java è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡
    2. æœ¬åœ°æ–¹æ³•æ ˆä¸­å¼•ç”¨çš„å¯¹è±¡
    3. æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡
    4. æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡
  - GC Roots å¹¶ä¸åŒ…æ‹¬å †ä¸­å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚

### å›æ”¶ç®—æ³•

#### 1. æ ‡è®°-æ¸…é™¤ç®—æ³•

- æ ‡è®°çš„è¿‡ç¨‹ï¼šéå†æ‰€æœ‰çš„ `GC Roots`ï¼Œç„¶åå°†æ‰€æœ‰ `GC Roots` å¯è¾¾çš„å¯¹è±¡**æ ‡è®°ä¸ºå­˜æ´»çš„å¯¹è±¡**ã€‚
- æ¸…é™¤çš„è¿‡ç¨‹ï¼šéå†å †ä¸­æ‰€æœ‰çš„å¯¹è±¡ï¼Œå°†æ²¡æœ‰æ ‡è®°çš„å¯¹è±¡å…¨éƒ¨æ¸…é™¤æ‰ã€‚ä¸æ­¤åŒæ—¶ï¼Œæ¸…é™¤é‚£äº›è¢«æ ‡è®°è¿‡çš„å¯¹è±¡çš„æ ‡è®°ï¼Œä»¥ä¾¿ä¸‹æ¬¡çš„åƒåœ¾å›æ”¶ã€‚
- ç¼ºé™·ï¼š
  - æ•ˆç‡ï¼šæ ‡è®°å’Œæ¸…é™¤ä¸¤ä¸ªè¿‡ç¨‹çš„æ•ˆç‡éƒ½ä¸é«˜ï¼›
  - ç©ºé—´ï¼šæ ‡è®°æ¸…é™¤ä¹‹åä¼š**äº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡**ï¼Œç¢ç‰‡å¤ªå¤šå¯èƒ½å¯¼è‡´ä»¥åéœ€è¦åˆ†é…è¾ƒå¤§å¯¹è±¡æ—¶ï¼Œ**æ— æ³•æ‰¾åˆ°è¶³å¤Ÿçš„è¿ç»­å†…å­˜**è€Œä¸å¾—ä¸æå‰è§¦å‘å¦ä¸€æ¬¡åƒåœ¾æ”¶é›†åŠ¨ä½œã€‚

#### 2. å¤åˆ¶ç®—æ³•ï¼ˆæ–°ç”Ÿä»£ï¼‰

ä¸ºäº†è§£å†³æ ‡è®°-æ¸…é™¤ç®—æ³•çš„æ•ˆç‡é—®é¢˜ï¼Œ**å°†å†…å­˜ç­‰åˆ†ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨ä¸€å—**ï¼Œå½“è¿™ä¸€å—å†…å­˜ç”¨å®Œï¼Œéœ€è¦è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œå°±å°†å­˜æ´»è€…çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—ä¸Šé¢ï¼Œç„¶åå°†ç¬¬ä¸€å—å†…å­˜å…¨éƒ¨æ¸…é™¤ã€‚

- ä¼˜ç‚¹ï¼šä¸ä¼šæœ‰å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚
- ç¼ºç‚¹ï¼šå†…å­˜ç¼©å°ä¸ºåŸæ¥çš„ä¸€åŠï¼Œæµªè´¹ç©ºé—´ã€‚

ä¸ºäº†**è§£å†³ç©ºé—´åˆ©ç”¨ç‡**é—®é¢˜ï¼Œå¯ä»¥å°†å†…å­˜åˆ†ä¸ºä¸‰å—ï¼š **Edenã€From Survivorã€To Survivor**ï¼Œæ¯”ä¾‹æ˜¯ **8:1:1**ï¼Œæ¯æ¬¡ä½¿ç”¨ Eden å’Œå…¶ä¸­ä¸€å— Survivorã€‚å›æ”¶æ—¶ï¼Œå°† Eden å’Œ Survivor ä¸­è¿˜å­˜æ´»çš„å¯¹è±¡ä¸€æ¬¡æ€§å¤åˆ¶åˆ°å¦å¤–ä¸€å— Survivor ç©ºé—´ä¸Šï¼Œæœ€åæ¸…ç†æ‰ Eden å’Œåˆšæ‰ä½¿ç”¨çš„ Survivor ç©ºé—´ã€‚è¿™æ ·åªæœ‰ 10% çš„å†…å­˜è¢«æµªè´¹ã€‚

ä½†æ˜¯æˆ‘ä»¬æ— æ³•ä¿è¯æ¯æ¬¡å›æ”¶éƒ½åªæœ‰ä¸å¤šäº 10% çš„å¯¹è±¡å­˜æ´»ï¼Œå½“ Survivor ç©ºé—´ä¸å¤Ÿï¼Œéœ€è¦ä¾èµ–å…¶ä»–å†…å­˜ï¼ˆæŒ‡è€å¹´ä»£ï¼‰è¿›è¡Œåˆ†é…æ‹…ä¿ã€‚

- **åˆ†é…æ‹…ä¿**ï¼šä¸ºå¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´æ—¶ï¼Œå¦‚æœ Eden+Survivor ä¸­ç©ºé—²åŒºåŸŸæ— æ³•è£…ä¸‹è¯¥å¯¹è±¡ï¼Œä¼šè§¦å‘ MinorGC è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚ä½†å¦‚æœ **Minor GC è¿‡åä¾ç„¶æœ‰è¶…è¿‡ 10% çš„å¯¹è±¡å­˜æ´»**ï¼Œè¿™æ ·å­˜æ´»çš„å¯¹è±¡ç›´æ¥é€šè¿‡åˆ†é…æ‹…ä¿æœºåˆ¶è¿›å…¥è€å¹´ä»£ï¼Œç„¶åå†å°†æ–°å¯¹è±¡å­˜å…¥ Eden åŒºã€‚

#### 3. æ ‡è®°-æ•´ç†ç®—æ³•(è€å¹´ä»£)

- æ ‡è®°çš„è¿‡ç¨‹ï¼šå®ƒçš„ç¬¬ä¸€ä¸ªé˜¶æ®µä¸**æ ‡è®°-æ¸…é™¤ç®—æ³•**æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œå‡æ˜¯éå† `GC Roots`ï¼Œç„¶åå°†å­˜æ´»çš„å¯¹è±¡æ ‡è®°ã€‚
- ç§»åŠ¨æ‰€æœ‰**å­˜æ´»çš„å¯¹è±¡**ï¼Œä¸”æŒ‰ç…§å†…å­˜åœ°å€æ¬¡åºä¾æ¬¡**æ’åˆ—**ï¼Œ**ç„¶åå°†æ’åºå·æœ«ç«¯å†…å­˜åœ°å€ä»¥åçš„å†…å­˜å…¨éƒ¨å›æ”¶**ã€‚å› æ­¤ï¼Œç¬¬äºŒé˜¶æ®µæ‰ç§°ä¸ºæ•´ç†é˜¶æ®µã€‚

#### 4. åˆ†ä»£æ”¶é›†ç®—æ³•

æ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒï¼Œå°†å†…å­˜åˆ’åˆ†ä¸ºå‡ å—ã€‚ä¸€èˆ¬æ˜¯æŠŠ Java å †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œé’ˆå¯¹å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é‡‡ç”¨æœ€é€‚å½“çš„æ”¶é›†ç®—æ³•ã€‚

- æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³•
- è€å¹´ä»£ï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•ã€æ ‡è®°-æ•´ç†ç®—æ³•

## åƒåœ¾æ”¶é›†å™¨

### 1. Serialæ”¶é›†å™¨

* ç‰¹ç‚¹ï¼šå•çº¿ç¨‹ï¼Œç®€å•è€Œé«˜æ•ˆï¼›
* å›æ”¶ç®—æ³•ï¼šæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°æ•´ç†ç®—æ³•ï¼›

### 2. ParNewæ”¶é›†å™¨

* `Serial`çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼›

### 3. Parallel Scavenge+Parallel Oldæ”¶é›†å™¨

* å‡ ä¹å’Œ`ParNew`ä¸€æ ·ï¼Œä½†æ˜¯å…¶å…³æ³¨ç‚¹æ˜¯**ååé‡**ï¼ˆé«˜æ•ˆç‡çš„åˆ©ç”¨CPUï¼‰ï¼Œ`CMS`å…³æ³¨ç‚¹åœ¨ç”¨æˆ·çº¿ç¨‹çš„**åœé¡¿æ—¶é—´**ï¼ˆæé«˜ç”¨æˆ·ä½“éªŒï¼‰ï¼›

### 4. CMSæ”¶é›†å™¨

* ç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹åŸºæœ¬åŒæ—¶å·¥ä½œï¼›
* å›æ”¶ç®—æ³•ï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•
  1. **åˆå§‹æ ‡è®°**ï¼šæš‚åœæ‰€æœ‰å…¶ä»–çº¿ç¨‹ï¼Œè®°å½•ç›´æ¥ä¸rootç›¸è¿çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼›
  2. **å¹¶å‘æ ‡è®°**ï¼šç”¨æˆ·çº¿ç¨‹ä¸ä¼šæ–­åœ°æ›´æ–°å¼•ç”¨åŸŸï¼Œéœ€è¦**è·Ÿè¸ªè®°å½•**å¼•ç”¨æ›´æ–°çš„åœ°æ–¹ï¼›
  3. **é‡æ–°æ ‡è®°**ï¼š**ä¿®æ­£**å¹¶å‘æ ‡è®°æœŸé—´å› ä¸ºç”¨æˆ·çº¿ç¨‹å†æ¬¡äº§ç”Ÿå˜åŠ¨çš„æ ‡è®°è®°å½•ï¼›
  4. **å¹¶å‘æ¸…é™¤**ï¼šå¼€å¯ç”¨æˆ·çº¿ç¨‹ï¼ŒåŒæ—¶ GC çº¿ç¨‹å¼€å§‹å¯¹æœªæ ‡è®°çš„åŒºåŸŸåšæ¸…æ‰«ï¼›

### 5. G1(Garbage-First)

* é¢å‘æœåŠ¡å™¨ï¼Œä¸»è¦é’ˆå¯¹å¤šå¤„ç†å™¨ä»¥åŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨
* èƒ½å¤Ÿæ»¡è¶³**GCåœé¡¿æ—¶é—´**çš„è¦æ±‚ï¼Œè¿˜å…·å¤‡**é«˜ååé‡**ï¼›
* å›æ”¶ç®—æ³•ï¼šæ ‡è®°-æ•´ç†
  1. åˆå§‹æ ‡è®°ï¼›
  2. å¹¶å‘æ ‡è®°ï¼›
  3. æœ€ç»ˆæ ‡è®°ï¼›
  4. ç­›é€‰å›æ”¶ï¼›
* G1 æ”¶é›†å™¨åœ¨åå°ç»´æŠ¤äº†ä¸€ä¸ª**ä¼˜å…ˆåˆ—è¡¨**ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆé€‰æ‹©å›æ”¶ä»·å€¼æœ€å¤§çš„åŒºåŸŸï¼›

## ç±»åŠ è½½è¿‡ç¨‹

* ç±»çš„ç”Ÿå‘½å‘¨æœŸ

![ç±»çš„ç”Ÿå‘½å‘¨æœŸ](assets\ç±»çš„ç”Ÿå‘½å‘¨æœŸ.png)

### åŠ è½½

1. é€šè¿‡**å…¨ç±»å**è·å–å®šä¹‰æ­¤ç±»çš„**äºŒè¿›åˆ¶å­—èŠ‚æµ**
2. å°†å­—èŠ‚æµæ‰€ä»£è¡¨çš„**é™æ€å­˜å‚¨ç»“æ„**è½¬æ¢ä¸ºæ–¹æ³•åŒºçš„**è¿è¡Œæ—¶**æ•°æ®ç»“æ„
3. åœ¨å†…å­˜ä¸­**ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ Class å¯¹è±¡**,ä½œä¸ºæ–¹æ³•åŒºè¿™äº›æ•°æ®çš„è®¿é—®å…¥å£

### éªŒè¯

![ç±»çš„éªŒè¯é˜¶æ®µ](assets\ç±»çš„éªŒè¯é˜¶æ®µ.png)

### å‡†å¤‡

**å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼çš„é˜¶æ®µ**ï¼Œè¿™äº›å†…å­˜éƒ½å°†åœ¨æ–¹æ³•åŒºä¸­åˆ†é…ã€‚å¯¹äºè¯¥é˜¶æ®µæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

1. è¿™æ—¶å€™è¿›è¡Œå†…å­˜åˆ†é…çš„ä»…åŒ…æ‹¬ç±»å˜é‡ï¼ˆstaticï¼‰ï¼Œè€Œä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼Œ**å®ä¾‹å˜é‡ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€å—åˆ†é…åœ¨ Java å †ä¸­**ã€‚
2. è¿™é‡Œæ‰€è®¾ç½®çš„åˆå§‹å€¼"é€šå¸¸æƒ…å†µ"ä¸‹æ˜¯**æ•°æ®ç±»å‹é»˜è®¤çš„é›¶å€¼**ï¼ˆå¦‚0ã€0Lã€nullã€falseç­‰ï¼‰ï¼Œæ¯”å¦‚æˆ‘ä»¬å®šä¹‰äº†`public static int value=111` ï¼Œé‚£ä¹ˆ value å˜é‡åœ¨å‡†å¤‡é˜¶æ®µçš„åˆå§‹å€¼å°±æ˜¯ 0 è€Œä¸æ˜¯111ï¼ˆåˆå§‹åŒ–é˜¶æ®µæ‰ä¼šèµ‹å€¼ï¼‰ã€‚ç‰¹æ®Šæƒ…å†µï¼šæ¯”å¦‚ç»™ value å˜é‡åŠ ä¸Šäº† fianl å…³é”®å­—`public static final int value=111` ï¼Œé‚£ä¹ˆå‡†å¤‡é˜¶æ®µ value çš„å€¼å°±è¢«èµ‹å€¼ä¸º 111ã€‚
3. é™æ€å˜é‡åœ¨è¿™ä¸ªé˜¶æ®µä¼šèµ‹ç»™é»˜è®¤å€¼ï¼Œåœ¨æ˜¯åˆå§‹åŒ–é˜¶æ®µçš„**ç±»åˆå§‹åŒ–æ—¶**è¿›è¡Œèµ‹å€¼æ“ä½œçš„ï¼›è€Œé™æ€å¸¸é‡åœ¨è¿™ä¸ªé˜¶æ®µä¼šèµ‹ç»™æœŸæœ›å€¼ã€‚

![åŸºæœ¬æ•°æ®ç±»å‹çš„é›¶å€¼](assets\åŸºæœ¬æ•°æ®ç±»å‹çš„é›¶å€¼.png)



### è§£æ

è§£æé˜¶æ®µæ˜¯è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹

### åˆå§‹åŒ–

åˆå§‹åŒ–æ˜¯ç±»åŠ è½½çš„æœ€åä¸€æ­¥ï¼Œä¹Ÿæ˜¯çœŸæ­£æ‰§è¡Œç±»ä¸­å®šä¹‰çš„ Java ç¨‹åºä»£ç (å­—èŠ‚ç )ï¼Œåˆå§‹åŒ–é˜¶æ®µæ˜¯æ‰§è¡Œç±»æ„é€ å™¨ `<clinit> ()`æ–¹æ³•çš„è¿‡ç¨‹ã€‚

å¯¹äºåˆå§‹åŒ–é˜¶æ®µï¼Œè™šæ‹Ÿæœºä¸¥æ ¼è§„èŒƒäº†æœ‰ä¸”åªæœ‰5ç§æƒ…å†µä¸‹ï¼Œ**å¿…é¡»å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–**(åªæœ‰ä¸»åŠ¨å»ä½¿ç”¨ç±»æ‰ä¼šåˆå§‹åŒ–ç±»)ï¼š

1. å½“é‡åˆ° new ã€ getstaticã€putstaticæˆ–invokestatic è¿™4æ¡ç›´æ¥ç æŒ‡ä»¤æ—¶ï¼Œæ¯”å¦‚ **new** ä¸€ä¸ªç±»ï¼Œè¯»å–ä¸€ä¸ª**é™æ€**å­—æ®µ(æœªè¢« final ä¿®é¥°)ã€æˆ–è°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•æ—¶ã€‚
   - å½“jvmæ‰§è¡ŒnewæŒ‡ä»¤æ—¶ä¼šåˆå§‹åŒ–ç±»ã€‚å³å½“ç¨‹åºåˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡ã€‚
   - å½“jvmæ‰§è¡ŒgetstaticæŒ‡ä»¤æ—¶ä¼šåˆå§‹åŒ–ç±»ã€‚å³ç¨‹åºè®¿é—®ç±»çš„é™æ€å˜é‡(ä¸æ˜¯é™æ€å¸¸é‡ï¼Œå¸¸é‡ä¼šè¢«åŠ è½½åˆ°è¿è¡Œæ—¶å¸¸é‡æ± )ã€‚
   - å½“jvmæ‰§è¡ŒputstaticæŒ‡ä»¤æ—¶ä¼šåˆå§‹åŒ–ç±»ã€‚å³ç¨‹åºç»™ç±»çš„é™æ€å˜é‡èµ‹å€¼ã€‚
   - å½“jvmæ‰§è¡ŒinvokestaticæŒ‡ä»¤æ—¶ä¼šåˆå§‹åŒ–ç±»ã€‚å³ç¨‹åºè°ƒç”¨ç±»çš„é™æ€æ–¹æ³•ã€‚
2. ä½¿ç”¨ `java.lang.reflect` åŒ…çš„æ–¹æ³•å¯¹ç±»è¿›è¡Œ**åå°„è°ƒç”¨**æ—¶å¦‚Class.forname("..."),newInstance()ç­‰ç­‰ã€‚ ï¼Œå¦‚æœç±»æ²¡åˆå§‹åŒ–ï¼Œéœ€è¦è§¦å‘å…¶åˆå§‹åŒ–ã€‚
3. åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œå¦‚æœå…¶çˆ¶ç±»è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™å…ˆè§¦å‘è¯¥**çˆ¶ç±»çš„åˆå§‹åŒ–**ã€‚
4. å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦å®šä¹‰ä¸€ä¸ªè¦æ‰§è¡Œçš„**ä¸»ç±»** (åŒ…å« main æ–¹æ³•çš„é‚£ä¸ªç±»)ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªç±»ã€‚
5. MethodHandleå’ŒVarHandleå¯ä»¥çœ‹ä½œæ˜¯è½»é‡çº§çš„åå°„è°ƒç”¨æœºåˆ¶ï¼Œè€Œè¦æƒ³ä½¿ç”¨è¿™2ä¸ªè°ƒç”¨ï¼Œ å°±å¿…é¡»å…ˆä½¿ç”¨findStaticVarHandleæ¥åˆå§‹åŒ–è¦è°ƒç”¨çš„ç±»ã€‚
6. **ã€Œè¡¥å……ï¼Œæ¥è‡ªissue745ã€** å½“ä¸€ä¸ªæ¥å£ä¸­å®šä¹‰äº†JDK8æ–°åŠ å…¥çš„é»˜è®¤æ–¹æ³•ï¼ˆè¢«defaultå…³é”®å­—ä¿®é¥°çš„æ¥å£æ–¹æ³•ï¼‰æ—¶ï¼Œå¦‚æœæœ‰è¿™ä¸ª**æ¥å£**çš„å®ç°ç±»å‘ç”Ÿäº†åˆå§‹åŒ–ï¼Œé‚£è¯¥æ¥å£è¦åœ¨å…¶**ä¹‹å‰**è¢«åˆå§‹åŒ–ã€‚

### å¸è½½

å¸è½½ç±»å³è¯¥ç±»çš„Classå¯¹è±¡è¢«GCã€‚

**å¸è½½ç±»éœ€è¦æ»¡è¶³3ä¸ªè¦æ±‚:**

1. è¯¥ç±»çš„**æ‰€æœ‰çš„å®ä¾‹å¯¹è±¡éƒ½å·²è¢«GC**ï¼Œä¹Ÿå°±æ˜¯è¯´å †ä¸å­˜åœ¨è¯¥ç±»çš„å®ä¾‹å¯¹è±¡ï¼›
2. è¯¥ç±»**æ²¡æœ‰åœ¨å…¶ä»–ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼›**
3. è¯¥ç±»çš„**ç±»åŠ è½½å™¨çš„å®ä¾‹å·²è¢«GC**ï¼›

æ‰€ä»¥ï¼Œåœ¨JVMç”Ÿå‘½å‘¨æœŸç±»ï¼Œç”±jvmè‡ªå¸¦çš„ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯ä¸ä¼šè¢«å¸è½½çš„ã€‚ä½†æ˜¯ç”±æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯å¯èƒ½è¢«å¸è½½çš„ã€‚

åªè¦æƒ³é€šä¸€ç‚¹å°±å¥½äº†ï¼Œjdkè‡ªå¸¦çš„BootstrapClassLoader,PlatformClassLoader,AppClassLoaderè´Ÿè´£åŠ è½½jdkæä¾›çš„ç±»ï¼Œæ‰€ä»¥å®ƒä»¬(ç±»åŠ è½½å™¨çš„å®ä¾‹)è‚¯å®šä¸ä¼šè¢«å›æ”¶ã€‚è€Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨çš„å®ä¾‹æ˜¯å¯ä»¥è¢«å›æ”¶çš„ï¼Œæ‰€ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯å¯ä»¥è¢«å¸è½½æ‰çš„ã€‚



## JVMè°ƒä¼˜

é€šå¸¸æŒ‡GCè°ƒä¼˜

### GCè°ƒä¼˜åŸåˆ™

å¤šæ•°çš„ Java åº”ç”¨ä¸éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šè¿›è¡Œ GC ä¼˜åŒ–ï¼› å¤šæ•°å¯¼è‡´ GC é—®é¢˜çš„ Java åº”ç”¨ï¼Œéƒ½ä¸æ˜¯å› ä¸ºæˆ‘ä»¬å‚æ•°è®¾ç½®é”™è¯¯ï¼Œè€Œæ˜¯ä»£ç é—®é¢˜ï¼› **åœ¨åº”ç”¨ä¸Šçº¿ä¹‹å‰ï¼Œå…ˆè€ƒè™‘å°†æœºå™¨çš„ JVM å‚æ•°è®¾ç½®åˆ°æœ€ä¼˜ï¼ˆæœ€é€‚åˆï¼‰**ï¼› å‡å°‘åˆ›å»ºå¯¹è±¡çš„æ•°é‡ï¼› å‡å°‘ä½¿ç”¨å…¨å±€å˜é‡å’Œå¤§å¯¹è±¡ï¼› GC ä¼˜åŒ–æ˜¯åˆ°æœ€åä¸å¾—å·²æ‰é‡‡ç”¨çš„æ‰‹æ®µï¼› åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œ**åˆ†æ GC æƒ…å†µä¼˜åŒ–ä»£ç æ¯”ä¼˜åŒ– GC å‚æ•°è¦å¤šå¾—å¤š**ã€‚

### GCè°ƒä¼˜ç›®çš„

å°†è½¬ç§»åˆ°è€å¹´ä»£çš„å¯¹è±¡æ•°é‡é™ä½åˆ°æœ€å°ï¼› å‡å°‘ GC çš„æ‰§è¡Œæ—¶é—´ã€‚

### GCè°ƒä¼˜ç­–ç•¥

1. å°†æ–°å¯¹è±¡é¢„ç•™åœ¨æ–°ç”Ÿä»£ï¼Œç”±äº Full GC çš„æˆæœ¬è¿œé«˜äº Minor GCï¼Œå› æ­¤å°½å¯èƒ½å°†å¯¹è±¡åˆ†é…åœ¨æ–°ç”Ÿä»£æ˜¯æ˜æ™ºçš„åšæ³•ï¼Œå®é™…é¡¹ç›®ä¸­æ ¹æ® GC æ—¥å¿—åˆ†ææ–°ç”Ÿä»£ç©ºé—´å¤§å°åˆ†é…æ˜¯å¦åˆç†ï¼Œé€‚å½“é€šè¿‡â€œ-Xmnâ€å‘½ä»¤è°ƒèŠ‚æ–°ç”Ÿä»£å¤§å°ï¼Œæœ€å¤§é™åº¦é™ä½æ–°å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£çš„æƒ…å†µã€‚
2. å¤§å¯¹è±¡è¿›å…¥è€å¹´ä»£ï¼Œè™½ç„¶å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå°†å¯¹è±¡åˆ†é…åœ¨æ–°ç”Ÿä»£æ˜¯åˆç†çš„ã€‚ä½†æ˜¯å¯¹äºå¤§å¯¹è±¡è¿™ç§åšæ³•å´å€¼å¾—å•†æ¦·ï¼Œå¤§å¯¹è±¡å¦‚æœé¦–æ¬¡åœ¨æ–°ç”Ÿä»£åˆ†é…å¯èƒ½ä¼šå‡ºç°ç©ºé—´ä¸è¶³å¯¼è‡´å¾ˆå¤šå¹´é¾„ä¸å¤Ÿçš„å°å¯¹è±¡è¢«åˆ†é…çš„è€å¹´ä»£ï¼Œç ´åæ–°ç”Ÿä»£çš„å¯¹è±¡ç»“æ„ï¼Œå¯èƒ½ä¼šå‡ºç°é¢‘ç¹çš„ full gcã€‚å› æ­¤ï¼Œå¯¹äºå¤§å¯¹è±¡ï¼Œå¯ä»¥è®¾ç½®ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼ˆå½“ç„¶çŸ­å‘½çš„å¤§å¯¹è±¡å¯¹äºåƒåœ¾å›æ”¶æ¥è¯´ç®€ç›´å°±æ˜¯å™©æ¢¦ï¼‰ã€‚`-XX:PretenureSizeThreshold` å¯ä»¥è®¾ç½®ç›´æ¥è¿›å…¥è€å¹´ä»£çš„å¯¹è±¡å¤§å°ã€‚
3. åˆç†è®¾ç½®è¿›å…¥è€å¹´ä»£å¯¹è±¡çš„å¹´é¾„ï¼Œ`-XX:MaxTenuringThreshold` è®¾ç½®å¯¹è±¡è¿›å…¥è€å¹´ä»£çš„å¹´é¾„å¤§å°ï¼Œå‡å°‘è€å¹´ä»£çš„å†…å­˜å ç”¨ï¼Œé™ä½ full gc å‘ç”Ÿçš„é¢‘ç‡ã€‚
4. è®¾ç½®ç¨³å®šçš„å †å¤§å°ï¼Œå †å¤§å°è®¾ç½®æœ‰ä¸¤ä¸ªå‚æ•°ï¼š`-Xms` åˆå§‹åŒ–å †å¤§å°ï¼Œ`-Xmx` æœ€å¤§å †å¤§å°ã€‚
5. æ³¨æ„ï¼š å¦‚æœæ»¡è¶³ä¸‹é¢çš„æŒ‡æ ‡ï¼Œ**åˆ™ä¸€èˆ¬ä¸éœ€è¦è¿›è¡Œ GC ä¼˜åŒ–ï¼š**
   * MinorGC æ‰§è¡Œæ—¶é—´ä¸åˆ°50msï¼› Minor GC æ‰§è¡Œä¸é¢‘ç¹ï¼Œçº¦10ç§’ä¸€æ¬¡ï¼› Full GC æ‰§è¡Œæ—¶é—´ä¸åˆ°1sï¼› Full GC æ‰§è¡Œé¢‘ç‡ä¸ç®—é¢‘ç¹ï¼Œä¸ä½äº10åˆ†é’Ÿ1æ¬¡ã€‚

# [Javaå¼‚å¸¸](https://blog.csdn.net/qq_29229567/article/details/80773970)

## æ€»è§ˆ

**æ‰€æœ‰çš„é”™è¯¯å’Œå¼‚å¸¸éƒ½ç»§æ‰¿è‡ª`Throwable`ç±»ï¼Œä¸‹åˆ†`Error`å’Œ`Exception`ä¸¤å¤§å­ç±»ï¼›**

* é”™è¯¯å’Œå¼‚å¸¸çš„åŒºåˆ«ï¼šé”™è¯¯æ— æ³•è¢«å¤„ç†ï¼Œå¼‚å¸¸èƒ½è¢«ç¨‹åºæœ¬èº«æ•è·å¹¶å¤„ç†ï¼›
* å¼‚å¸¸`Throwable`åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š
  * å—æŸ¥å¼‚å¸¸ï¼šç¼–è¯‘å™¨è¦æ±‚**å¿…é¡»å¤„ç½®**çš„å¼‚å¸¸ã€‚é™¤äº†`RuntimeException`ç±»åŠå…¶å­ç±»ä»¥å¤–çš„`Exception`å­ç±»ï¼Œç¨‹åºä¸­å‡ºç°è¿™ç±»å¼‚å¸¸ï¼Œè¦ä¹ˆç”¨**`try-catch`æ•è·**ï¼Œè¦ä¹ˆç”¨**`throws`å­å¥å£°æ˜æŠ›å‡º**ï¼Œå¦åˆ™**ç¼–è¯‘ä¸ä¼šé€šè¿‡**ï¼›
  * éå—æŸ¥å¼‚å¸¸ï¼šç¼–è¯‘å™¨**ä¸è¦æ±‚å¼ºåˆ¶å¤„ç½®**çš„å¼‚å¸¸ã€‚åŒ…æ‹¬è¿è¡Œæ—¶å¼‚å¸¸`RuntimeException`åŠå…¶å­ç±»å’Œé”™è¯¯`Error`ã€‚

* `Error`ï¼šæ˜¯**ç¨‹åºæ— æ³•å¤„ç†**çš„é”™è¯¯ï¼Œè¡¨ç¤ºè¿è¡Œçš„åº”ç”¨ç¨‹åºä¸­å‡ºç°è¾ƒä¸¥é‡çš„é—®é¢˜ï¼Œå¤§å¤šæ•°é”™è¯¯ä¸ä»£ç ç¼–å†™è€…æ‰§è¡Œçš„æ“ä½œæ— å…³ï¼Œè¡¨ç¤ºä»£ç è¿è¡Œæ—¶JVMå‡ºç°çš„é—®é¢˜ã€‚è¿™äº›é”™è¯¯æ˜¯**ä¸å¯æŸ¥**çš„ï¼Œå¯¹äºè®¾è®¡åˆç†çš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œä¸åº”è¯¥è¯•å›¾å»å¤„ç†è¿™ç§å¼‚å¸¸çŠ¶å†µã€‚
* `Exception`ï¼šæ˜¯**ç¨‹åºæœ¬èº«å¯ä»¥å¤„ç†**çš„å¼‚å¸¸ï¼Œåˆ†ä¸ºä¸¤å¤§ç±»ï¼š
  * è¿è¡Œæ—¶å¼‚å¸¸ï¼šä¸º`RuntimeException`ç±»åŠå…¶å­ç±»ï¼Œ è¿™äº›å¼‚å¸¸æ˜¯**éå—æŸ¥å¼‚å¸¸**ï¼Œä¸€èˆ¬ç”±ç¨‹åºé€»è¾‘é”™è¯¯å¼•èµ·ï¼Œç¼–è¯‘å™¨ä¸ä¼šå»æ£€æŸ¥å®ƒï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰`tay-catch`å’Œ`throws`ä¹Ÿä¼šç¼–è¯‘é€šè¿‡ï¼›
  * éè¿è¡Œæ—¶å¼‚å¸¸ï¼š`RuntimeException`ä»¥å¤–çš„å¼‚å¸¸ï¼Œå¿…é¡»è¦è¢«å¤„ç†ï¼Œå¦åˆ™ç¨‹åºä¸èƒ½ç¼–è¯‘é€šè¿‡ï¼›

## å¸¸è§å¼‚å¸¸

1. `RuntimeException`å­ç±»ï¼š

| åºå· | å¼‚å¸¸åç§°                                 | å¼‚å¸¸æè¿°                                                     |
| :--- | :--------------------------------------- | :----------------------------------------------------------- |
| 1    | java.lang.ArrayIndexOutOfBoundsException | æ•°ç»„ç´¢å¼•è¶Šç•Œå¼‚å¸¸ã€‚å½“å¯¹æ•°ç»„çš„ç´¢å¼•å€¼ä¸ºè´Ÿæ•°æˆ–å¤§äºç­‰äºæ•°ç»„å¤§å°æ—¶æŠ›å‡ºã€‚ |
| 2    | java.lang.ArithmeticException            | ç®—æœ¯æ¡ä»¶å¼‚å¸¸ã€‚è­¬å¦‚ï¼šæ•´æ•°é™¤é›¶ç­‰ã€‚                             |
| 3    | java.lang.SecurityException              | å®‰å…¨æ€§å¼‚å¸¸                                                   |
| 4    | java.lang.IllegalArgumentException       | éæ³•å‚æ•°å¼‚å¸¸                                                 |
| 5    | java.lang.ArrayStoreException            | æ•°ç»„ä¸­åŒ…å«ä¸å…¼å®¹çš„å€¼æŠ›å‡ºçš„å¼‚å¸¸                               |
| 6    | java.lang.NegativeArraySizeException     | æ•°ç»„é•¿åº¦ä¸ºè´Ÿå¼‚å¸¸                                             |
| 7    | java.lang.NullPointerException           | ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚å½“åº”ç”¨è¯•å›¾åœ¨è¦æ±‚ä½¿ç”¨å¯¹è±¡çš„åœ°æ–¹ä½¿ç”¨äº†nullæ—¶ï¼ŒæŠ›å‡ºè¯¥å¼‚å¸¸ã€‚è­¬å¦‚ï¼šè°ƒç”¨nullå¯¹è±¡çš„å®ä¾‹æ–¹æ³•ã€è®¿é—®nullå¯¹è±¡çš„å±æ€§ã€è®¡ç®—nullå¯¹è±¡çš„é•¿åº¦ã€ä½¿ç”¨throwè¯­å¥æŠ›å‡ºnullç­‰ç­‰ã€‚ |

2. `IOException`

| åºå· | å¼‚å¸¸åç§°              | å¼‚å¸¸æè¿°                           |
| :--- | :-------------------- | :--------------------------------- |
| 1    | IOException           | æ“ä½œè¾“å…¥æµå’Œè¾“å‡ºæµæ—¶å¯èƒ½å‡ºç°çš„å¼‚å¸¸ |
| 2    | EOFException          | æ–‡ä»¶å·²ç»“æŸå¼‚å¸¸                     |
| 3    | FileNotFoundException | æ–‡ä»¶æœªæ‰¾åˆ°å¼‚å¸¸                     |

3. å…¶ä»–å—æŸ¥å¼‚å¸¸

| åºå·     | å¼‚å¸¸åç§°                               | å¼‚å¸¸æè¿°                                                     |
| :------- | :------------------------------------- | :----------------------------------------------------------- |
| 1        | ClassCastException                     | ç±»å‹è½¬æ¢å¼‚å¸¸ç±»                                               |
| 2        | ArrayStoreException                    | æ•°ç»„ä¸­åŒ…å«ä¸å…¼å®¹çš„å€¼æŠ›å‡ºçš„å¼‚å¸¸                               |
| 3        | SQLException                           | æ“ä½œæ•°æ®åº“å¼‚å¸¸ç±»                                             |
| 4        | NoSuchFieldException                   | å­—æ®µæœªæ‰¾åˆ°å¼‚å¸¸                                               |
| 5        | NoSuchMethodException                  | æ–¹æ³•æœªæ‰¾åˆ°æŠ›å‡ºçš„å¼‚å¸¸                                         |
| 6        | NumberFormatException                  | å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—æŠ›å‡ºçš„å¼‚å¸¸                                   |
| 7        | StringIndexOutOfBoundsException        | å­—ç¬¦ä¸²ç´¢å¼•è¶…å‡ºèŒƒå›´æŠ›å‡ºçš„å¼‚å¸¸                                 |
| 8        | IllegalAccessException                 | ä¸å…è®¸è®¿é—®æŸç±»å¼‚å¸¸                                           |
| 9        | InstantiationException                 | å½“åº”ç”¨ç¨‹åºè¯•å›¾ä½¿ç”¨Classç±»ä¸­çš„newInstance()æ–¹æ³•åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹ï¼Œè€ŒæŒ‡å®šçš„ç±»å¯¹è±¡æ— æ³•è¢«å®ä¾‹åŒ–æ—¶ï¼ŒæŠ›å‡ºè¯¥å¼‚å¸¸ |
| ***10*** | ***java.lang.ClassNotFoundException*** | ***æ‰¾ä¸åˆ°ç±»å¼‚å¸¸ã€‚å½“åº”ç”¨è¯•å›¾æ ¹æ®å­—ç¬¦ä¸²å½¢å¼çš„ç±»åæ„é€ ç±»ï¼Œè€Œåœ¨éå†CLASSPAHä¹‹åæ‰¾ä¸åˆ°å¯¹åº”åç§°çš„classæ–‡ä»¶æ—¶ï¼ŒæŠ›å‡ºè¯¥å¼‚å¸¸ã€‚*** |

# [Java I/O](https://snailclimb.gitee.io/javaguide/#/docs/java/BIO-NIO-AIO)

**Javaä¸­æä¾›çš„IOæœ‰å…³çš„APIï¼Œåœ¨æ–‡ä»¶å¤„ç†çš„æ—¶å€™ï¼Œå…¶å®ä¾èµ–æ“ä½œç³»ç»Ÿå±‚é¢çš„IOæ“ä½œå®ç°çš„ã€‚**

## åˆ†ç±»

### 1.æŒ‰æ“ä½œæ–¹å¼åˆ†ç±»

![IOæŒ‰æ“ä½œæ–¹å¼åˆ†ç±»](assets\IOæŒ‰æ“ä½œæ–¹å¼åˆ†ç±».jpg)

### 2. æŒ‰æ“ä½œå¯¹è±¡åˆ†ç±»

![IOæŒ‰æ“ä½œå¯¹è±¡åˆ†ç±»](assets\IOæŒ‰æ“ä½œå¯¹è±¡åˆ†ç±».jpg)

## 1. BIO(Blocking I/O)

### 1.1 ä¼ ç»ŸBIO

![BIOæ¨¡å‹](assets\ä¼ ç»ŸBIOæ¨¡å‹.png)

* é‡‡ç”¨BIOæ¨¡å‹çš„æœåŠ¡ç«¯é€šè¿‡ä¸€ä¸ªç‹¬ç«‹çš„`Acceptor`çº¿ç¨‹è´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯çš„é“¾æ¥ï¼›
* åœ¨`while(true)`å¾ªç¯ä¸­è°ƒç”¨`accept()`ç­‰å¾…æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼›
* å¯¹äºæ¯ä¸€ä¸ªè¯·æ±‚æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å¤„ç†ï¼›

### 1.2 ä¼ªå¼‚æ­¥IO

![ä¼ªå¼‚æ­¥IO](assets\ä¼ªå¼‚æ­¥IO.png)

* å‡å°‘BIOå¤„ç†å¤šè¯·æ±‚äº§ç”Ÿçš„åˆ›å»º/é”€æ¯çº¿ç¨‹å¼€é”€ï¼›
* å°†å®¢æˆ·ç«¯çš„Socketå°è£…æˆä¸€ä¸ªTaskï¼ŒæŠ•é€’åˆ°åç«¯çš„çº¿ç¨‹æ± çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡Œå¤„ç†ï¼›
* å¯ä»¥ä½¿ç”¨çº¿ç¨‹æ•°é‡å›ºå®šçš„çº¿ç¨‹æ± `FixedThreadPool`æˆ–è€…è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼›
* åº•å±‚ä»æ˜¯åŒæ­¥é˜»å¡BIOæ¨¡å‹ï¼Œåªèµ·åˆ°**ç¼“å†²**çš„ä½œç”¨ï¼Œæ— æ³•ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ï¼›

## 2. NIO

**æ”¯æŒé¢å‘ç¼“å†²ï¼ŒåŸºäºé€šé“çš„I/Oæ“ä½œæ–¹æ³•ï¼Œåº”ç”¨äºé«˜è´Ÿè½½ã€é«˜å¹¶å‘çš„åº”ç”¨ã€‚**

### NIOçš„ç‰¹æ€§ä¸IOçš„åŒºåˆ«

#### 2.1 Non-blocking IO

* NIOï¼šå•çº¿ç¨‹ä¸­ä»é€šé“è¯»å–æ•°æ®åˆ°bufferï¼ŒåŒæ—¶å¯ä»¥ç»§ç»­åšåˆ«çš„äº‹æƒ…ï¼Œå½“æ•°æ®è¯»å–åˆ°bufferä¸­åï¼Œçº¿ç¨‹å†ç»§ç»­å¤„ç†æ•°æ®ã€‚ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å†™å…¥ä¸€äº›æ•°æ®åˆ°æŸé€šé“ï¼Œä½†ä¸éœ€è¦ç­‰å¾…å®ƒå®Œå…¨å†™å…¥ï¼Œè¿™ä¸ªçº¿ç¨‹åŒæ—¶å¯ä»¥å»åšåˆ«çš„äº‹æƒ…ã€‚
* IOï¼šå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `read()` æˆ– `write()` æ—¶ï¼Œè¯¥çº¿ç¨‹**è¢«é˜»å¡**ï¼Œç›´åˆ°æœ‰ä¸€äº›æ•°æ®è¢«è¯»å–ï¼Œæˆ–æ•°æ®å®Œå…¨å†™å…¥ï¼Œè¯¥çº¿ç¨‹åœ¨æ­¤æœŸé—´ä¸èƒ½å†å¹²ä»»ä½•äº‹æƒ…äº†ã€‚

#### 2.2 Bufferï¼ˆç¼“å†²åŒºï¼‰

* NIOï¼š**é¢å‘ç¼“å†²åŒº**ã€‚æ‰€æœ‰æ•°æ®éƒ½æ˜¯ç”¨**ç¼“å†²åŒº**å¤„ç†çš„ã€‚åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå®ƒæ˜¯ç›´æ¥è¯»åˆ°ç¼“å†²åŒºä¸­çš„; åœ¨å†™å…¥æ•°æ®æ—¶ï¼Œå†™å…¥åˆ°ç¼“å†²åŒºä¸­ã€‚ä»»ä½•æ—¶å€™è®¿é—®NIOä¸­çš„æ•°æ®ï¼Œéƒ½æ˜¯é€šè¿‡ç¼“å†²åŒºè¿›è¡Œæ“ä½œã€‚
* IOï¼š**é¢å‘æµ**ã€‚å°†æ•°æ®ç›´æ¥å†™å…¥æˆ–è€…å°†æ•°æ®ç›´æ¥è¯»åˆ° Stream å¯¹è±¡ä¸­ã€‚è™½ç„¶ Stream ä¸­ä¹Ÿæœ‰ Buffer å¼€å¤´çš„æ‰©å±•ç±»ï¼Œä½†åªæ˜¯æµçš„åŒ…è£…ç±»ï¼Œè¿˜æ˜¯ä»æµè¯»åˆ°ç¼“å†²åŒºã€‚

#### 2.3 Channelï¼ˆé€šé“ï¼‰

* NIOï¼š**é€šè¿‡Channelè¿›è¡Œè¯»å†™**ã€‚é€šé“æ˜¯**åŒå‘**çš„ï¼Œå¯è¯»ä¹Ÿå¯å†™ï¼Œè€Œ**æµ**çš„è¯»å†™æ˜¯**å•å‘**çš„ã€‚æ— è®ºè¯»å†™ï¼Œ**é€šé“åªèƒ½å’ŒBufferäº¤äº’**ã€‚å› ä¸º Bufferï¼Œ**é€šé“å¯ä»¥å¼‚æ­¥åœ°è¯»å†™**ã€‚

#### 2.4 Selectorï¼ˆé€‰æ‹©å™¨ï¼‰

* NIOï¼šä¸ºäº†å‡å°‘çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ï¼Œæé«˜ç³»ç»Ÿæ•ˆç‡ï¼Œé€‰æ‹©å™¨ç”¨äºä½¿ç”¨**å•ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªé€šé“ã€‚**å› æ­¤ï¼Œå®ƒéœ€è¦è¾ƒå°‘çš„çº¿ç¨‹æ¥å¤„ç†è¿™äº›é€šé“ã€‚

### 3. AIO(Asynchronous I/O)

* AIO ä¹Ÿå°±æ˜¯ NIO 2ã€‚åœ¨ Java 7 ä¸­å¼•å…¥äº† NIO çš„æ”¹è¿›ç‰ˆ NIO 2,å®ƒæ˜¯å¼‚æ­¥éé˜»å¡çš„IOæ¨¡å‹ã€‚**å¼‚æ­¥ IO æ˜¯åŸºäºäº‹ä»¶å’Œå›è°ƒæœºåˆ¶å®ç°çš„**ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ“ä½œä¹‹åä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå µå¡åœ¨é‚£é‡Œï¼Œå½“åå°å¤„ç†å®Œæˆï¼Œæ“ä½œç³»ç»Ÿä¼šé€šçŸ¥ç›¸åº”çš„çº¿ç¨‹è¿›è¡Œåç»­çš„æ“ä½œã€‚

* è™½ç„¶ NIO åœ¨ç½‘ç»œæ“ä½œä¸­ï¼Œæä¾›äº†éé˜»å¡çš„æ–¹æ³•ï¼Œä½†æ˜¯ NIO çš„ IO è¡Œä¸ºè¿˜æ˜¯åŒæ­¥çš„ã€‚å¯¹äº NIO æ¥è¯´ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡çº¿ç¨‹æ˜¯åœ¨ IO æ“ä½œå‡†å¤‡å¥½æ—¶ï¼Œå¾—åˆ°é€šçŸ¥ï¼Œæ¥ç€å°±ç”±è¿™ä¸ªçº¿ç¨‹è‡ªè¡Œè¿›è¡Œ IO æ“ä½œï¼ŒIOæ“ä½œæœ¬èº«æ˜¯åŒæ­¥çš„ã€‚**é™¤äº† AIO å…¶ä»–çš„ IO ç±»å‹éƒ½æ˜¯åŒæ­¥çš„**ï¼Œè¿™ä¸€ç‚¹å¯ä»¥ä»åº•å±‚IOçº¿ç¨‹æ¨¡å‹è§£é‡Šï¼›

# Linux

## [Linuxçš„5ç§IOæ¨¡å‹](https://blog.csdn.net/z_ryan/article/details/80873449)

**å¯ä»¥æŠŠJavaä¸­çš„BIOã€NIOå’ŒAIOç†è§£ä¸ºæ˜¯Javaè¯­è¨€å¯¹æ“ä½œç³»ç»Ÿçš„å„ç§IOæ¨¡å‹çš„å°è£…ã€‚**ç¨‹åºå‘˜åœ¨ä½¿ç”¨è¿™äº›APIçš„æ—¶å€™ï¼Œä¸éœ€è¦å…³å¿ƒæ“ä½œç³»ç»Ÿå±‚é¢çš„çŸ¥è¯†ï¼Œä¹Ÿä¸éœ€è¦æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿç¼–å†™ä¸åŒçš„ä»£ç ã€‚

* ä¸€æ¬¡å®Œæ•´çš„IOæ“ä½œï¼šæ˜¯æ–‡ä»¶ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´(å†…å­˜)ä¸­ï¼›

### 1. é˜»å¡IOæ¨¡å‹

![é˜»å¡IOæ¨¡å‹](assets\é˜»å¡IOæ¨¡å‹.png)

* è¿›ç¨‹æˆ–çº¿ç¨‹ç­‰å¾…å†…æ ¸å‡†å¤‡å¥½æ•°æ®æŠ¥ï¼Œå¦‚æœè¿˜æœªå‡†å¤‡å¥½ï¼Œå°±ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œç›´åˆ°è¾¾åˆ°æ¡ä»¶æ‰æ‰§è¡Œä¸‹ä¸€æ­¥ï¼›

### 2. éé˜»å¡IOæ¨¡å‹

![éé˜»å¡IOæ¨¡å‹](assets\éé˜»å¡IOæ¨¡å‹.png)

* è¿›ç¨‹é€šè¿‡è½®è¯¢çš„æ–¹å¼æŸ¥çœ‹å†…æ ¸ä¸­æ•°æ®æŠ¥æ˜¯å¦å‡†å¤‡å¥½ï¼Œ**åœ¨è½®è¯¢çš„é—´éš”å†…å¯ä»¥å»æ‰§è¡Œå…¶ä»–æ“ä½œ**ï¼Œä¸‹ä¸€æ¬¡è½®è¯¢å‘ç°æ•°æ®å·²ç»å‡†å¤‡å¥½äº†ï¼Œå°±æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ä¸­ï¼Œå¢åŠ äº†æ—¶é—´åˆ©ç”¨ç‡ï¼›

### 3. ä¿¡å·é©±åŠ¨IOæ¨¡å‹

![ä¿¡å·é©±åŠ¨IOæ¨¡å‹](assets\ä¿¡å·é©±åŠ¨IOæ¨¡å‹.png)

* ä¸å†å¤šæ¬¡è½®è¯¢ï¼Œè¿›ç¨‹é¢„å…ˆå‘å†…æ ¸æ³¨å†Œä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œç„¶åè¿”å›æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œç­‰å†…æ ¸æ•°æ®å‡†å¤‡å°±ç»ªæ—¶ï¼Œå‘é€ä¿¡å·é€šçŸ¥è¿›ç¨‹æ•°æ®å‡†å¤‡å¥½ï¼Œå¯ä»¥è¿›è¡Œæ‰§è¡Œæ‹·è´æ“ä½œï¼›

### 4. IOå¤ç”¨æ¨¡å‹ï¼ˆselectï¼Œpollï¼Œepollï¼‰

 ![IOå¤ç”¨æ¨¡å‹](assets\IOå¤ç”¨æ¨¡å‹.png)

* å•ä¸ªè¿›ç¨‹åŒæ—¶å¤„ç†å¤šä¸ªç½‘ç»œè¿æ¥çš„IOï¼Œéœ€è¦ä½¿ç”¨**ä¸¤ä¸ªsystem call** (select å’Œ recvfrom)ï¼Œé˜»å¡IOåªè°ƒç”¨recvfromä¸€ä¸ªsystem calï¼›
* **åŸºæœ¬åŸç†**å°±æ˜¯ä¸å†ç”±åº”ç”¨ç¨‹åºè‡ªå·±ç›‘è§†è¿æ¥ï¼Œå–è€Œä»£ä¹‹**ç”±å†…æ ¸æ›¿åº”ç”¨ç¨‹åºç›‘è§†æ–‡ä»¶æè¿°ç¬¦**ã€‚
* ä»¥selectä¸ºä¾‹ï¼Œå½“ç”¨æˆ·è¿›ç¨‹è°ƒç”¨äº†selectï¼Œé‚£ä¹ˆæ•´ä¸ª**è¿›ç¨‹ä¼šè¢«é˜»å¡**ï¼Œè€ŒåŒæ—¶ï¼Œkernelä¼šâ€œç›‘è§†â€æ‰€æœ‰selectè´Ÿè´£çš„socketï¼Œå½“ä»»ä½•ä¸€ä¸ªsocketä¸­çš„æ•°æ®å‡†å¤‡å¥½äº†ï¼Œselectå°±ä¼šè¿”å›ã€‚è¿™ä¸ªæ—¶å€™ç”¨æˆ·è¿›ç¨‹å†è°ƒç”¨readæ“ä½œï¼Œå°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ï¼›
* ä¹Ÿå±äºé˜»å¡IOï¼Œåªä¸è¿‡è¿›ç¨‹**è¢«selectå‡½æ•°é˜»å¡**ï¼Œè€Œä¸æ˜¯è¢«IOæ“ä½œé˜»å¡ï¼›
* **é€‚ç”¨äºè¿æ¥æ•°æ¯”è¾ƒå¤§**çš„æƒ…å†µï¼Œç³»ç»Ÿä¸éœ€è¦åˆ›å»ºæ–°çš„é¢å¤–è¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œä¹Ÿä¸éœ€è¦ç»´æŠ¤è¿™äº›è¿›ç¨‹å’Œçº¿ç¨‹çš„è¿è¡Œï¼Œå¦åˆ™å¯èƒ½ä¸å¦‚é˜»å¡IOæ•ˆç‡é«˜ï¼›

### 5. å¼‚æ­¥IOæ¨¡å‹

**ä»¥ä¸Šéƒ½æ˜¯åŒæ­¥çš„IOæ¨¡å‹ï¼Œå³ä½¿æ˜¯éé˜»å¡ï¼Œä¹Ÿåªæ˜¯åœ¨æ•°æ®å‡†å¤‡é˜¶æ®µæ˜¯å¼‚æ­¥çš„ï¼Œæ•°æ®æ‹·è´æ“ä½œéƒ½æ˜¯åŒæ­¥çš„ã€‚**

![å¼‚æ­¥IOæ¨¡å‹](assets\å¼‚æ­¥IOæ¨¡å‹.png)

* è¿›ç¨‹åŒ…IOè¯·æ±‚ä¼ ç»™å†…æ ¸åï¼Œå®Œå…¨æœ‰å†…æ ¸å»æ“ä½œæ–‡ä»¶æ‹·è´ï¼Œå†…æ ¸å®Œæˆç›¸å…³æ“ä½œåï¼Œä¼šå‘ä¿¡å·å‘Šè¯‰åº”ç”¨è¿›ç¨‹æœ¬æ¬¡IOå·²ç»å®Œæˆã€‚
* ç”¨æˆ·è¿›ç¨‹å‘èµ·`aio_read`æ“ä½œä¹‹åï¼Œç»™å†…æ ¸ä¼ é€’æè¿°ç¬¦ã€ç¼“å†²åŒºæŒ‡é’ˆã€ç¼“å†²åŒºå¤§å°ç­‰ï¼Œå‘Šè¯‰å†…æ ¸å½“æ•´ä¸ªæ“ä½œå®Œæˆæ—¶ï¼Œå¦‚ä½•é€šçŸ¥è¿›ç¨‹ï¼Œç„¶åå°±ç«‹åˆ»å»åšå…¶ä»–äº‹æƒ…äº†ã€‚å½“**å†…æ ¸æ”¶åˆ°`aio_read`åï¼Œä¼šç«‹åˆ»è¿”å›**ï¼Œç„¶åå†…æ ¸å¼€å§‹ç­‰å¾…æ•°æ®å‡†å¤‡ï¼Œæ•°æ®å‡†å¤‡å¥½ä»¥åï¼Œç›´æ¥æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ§ä»¶ï¼Œç„¶åå†é€šçŸ¥è¿›ç¨‹æœ¬æ¬¡IOå·²ç»å®Œæˆã€‚

### 5ç§IOæ¨¡å‹å¯¹æ¯”

![Linuxäº”ç§IOæ¨¡å‹å¯¹æ¯”](assets\Linuxäº”ç§IOæ¨¡å‹å¯¹æ¯”.png)

## å¸¸ç”¨å‘½ä»¤

- æŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µï¼š

```shell
## æ•´ä½“èµ„æºä½¿ç”¨æƒ…å†µ
top

## æŸ¥çœ‹è´Ÿè½½
uptime

## æŸ¥çœ‹å ç”¨cpuæœ€é«˜çš„è¿›ç¨‹
ps aux|head -1;ps aux|grep -v PID|sort -rn -k +3|head

## æŸ¥çœ‹å ç”¨å†…å­˜æœ€é«˜çš„è¿›ç¨‹
ps aux|head -1;ps aux|grep -v PID|sort -rn -k +4|head

```

å…¶ä¸­ç¬¬ä¸€å¥ä¸»è¦æ˜¯ä¸ºäº†è·å–æ ‡é¢˜ï¼ˆUSER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMANDï¼‰ã€‚
æ¥ä¸‹æ¥çš„grep -v PIDæ˜¯å°†ps auxå‘½ä»¤å¾—åˆ°çš„æ ‡é¢˜å»æ‰ï¼Œå³grepä¸åŒ…å«PIDè¿™ä¸‰ä¸ªå­—æ¯ç»„åˆçš„è¡Œï¼Œå†å°†å…¶ä¸­ç»“æœä½¿ç”¨sortæ’åºã€‚
sort -rn -k +3è¯¥å‘½ä»¤ä¸­çš„-rnçš„rè¡¨ç¤ºæ˜¯ç»“æœå€’åºæ’åˆ—ï¼Œnä¸ºä»¥æ•°å€¼å¤§å°æ’åºï¼Œè€Œ-k +3åˆ™æ˜¯é’ˆå¯¹ç¬¬3åˆ—çš„å†…å®¹è¿›è¡Œæ’åºï¼Œå†ä½¿ç”¨headå‘½ä»¤è·å–é»˜è®¤å‰10è¡Œæ•°æ®ã€‚(å…¶ä¸­çš„|è¡¨ç¤ºç®¡é“æ“ä½œ)

**è¡¥å……:å†…å®¹è§£é‡Š**

- PIDï¼šè¿›ç¨‹çš„ID
  USERï¼šè¿›ç¨‹æ‰€æœ‰è€…
  PRï¼šè¿›ç¨‹çš„ä¼˜å…ˆçº§åˆ«ï¼Œè¶Šå°è¶Šä¼˜å…ˆè¢«æ‰§è¡Œ
  NIniceï¼šå€¼
  VIRTï¼šè¿›ç¨‹å ç”¨çš„è™šæ‹Ÿå†…å­˜
  RESï¼šè¿›ç¨‹å ç”¨çš„ç‰©ç†å†…å­˜
  SHRï¼šè¿›ç¨‹ä½¿ç”¨çš„å…±äº«å†…å­˜
  Sï¼šè¿›ç¨‹çš„çŠ¶æ€ã€‚Sè¡¨ç¤ºä¼‘çœ ï¼ŒRè¡¨ç¤ºæ­£åœ¨è¿è¡Œï¼ŒZè¡¨ç¤ºåƒµæ­»çŠ¶æ€ï¼ŒNè¡¨ç¤ºè¯¥è¿›ç¨‹ä¼˜å…ˆå€¼ä¸ºè´Ÿæ•°
  %CPUï¼šè¿›ç¨‹å ç”¨CPUçš„ä½¿ç”¨ç‡
  %MEMï¼šè¿›ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜å’Œæ€»å†…å­˜çš„ç™¾åˆ†æ¯”
  TIME+ï¼šè¯¥è¿›ç¨‹å¯åŠ¨åå ç”¨çš„æ€»çš„CPUæ—¶é—´ï¼Œå³å ç”¨CPUä½¿ç”¨æ—¶é—´çš„ç´¯åŠ å€¼ã€‚
  COMMANDï¼šè¿›ç¨‹å¯åŠ¨å‘½ä»¤åç§°

- ç®¡é“ç¬¦|ï¼šå®é™…æ˜¯shellåœ¨ä¸ºæ¯ä¸€ä¸ªå‘½ä»¤åˆ›å»ºä¸€ä¸ªè¿›ç¨‹çš„æ—¶å€™ä¿®æ”¹äº†æ‰“å¼€æ–‡ä»¶åˆ—è¡¨ï¼Œå°†ä¸Šä¸€ä¸ªå‘½ä»¤è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºè®¾ä¸ºä¸‹ä¸€ä¸ªå‘½ä»¤è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥

## [Linuxæ€§èƒ½åˆ†æå·¥å…·åˆé›†](https://snailclimb.gitee.io/javaguide/#/docs/operating-system/Linux%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E5%90%88%E9%9B%86)



## Linuxè¿›ç¨‹é—´é€šä¿¡

1. **ç®¡é“**ï¼ˆPipeï¼‰åŠ**æœ‰åç®¡é“**ï¼ˆnamed pipeï¼‰ï¼šç®¡é“å¯ç”¨äºå…·æœ‰äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œæœ‰åç®¡é“å…‹æœäº†ç®¡é“æ²¡æœ‰åå­—çš„é™åˆ¶ï¼Œå› æ­¤ï¼Œé™¤å…·æœ‰ç®¡é“æ‰€å…·æœ‰çš„åŠŸèƒ½å¤–ï¼Œå®ƒè¿˜å…è®¸æ— äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡ï¼›
2. **ä¿¡å·**ï¼ˆSignalï¼‰ï¼šä¿¡å·æ˜¯æ¯”è¾ƒå¤æ‚çš„é€šä¿¡æ–¹å¼ï¼Œ**ç”¨äºé€šçŸ¥æ¥å—è¿›ç¨‹æœ‰æŸç§äº‹ä»¶å‘ç”Ÿ**ï¼Œé™¤äº†ç”¨äºè¿›ç¨‹é—´é€šä¿¡å¤–ï¼Œè¿›ç¨‹è¿˜å¯ä»¥å‘é€ä¿¡å·ç»™è¿›ç¨‹æœ¬èº«ï¼›linuxé™¤äº†æ”¯æŒUnixæ—©æœŸä¿¡å·è¯­ä¹‰å‡½æ•°sigalå¤–ï¼Œè¿˜æ”¯æŒè¯­ä¹‰ç¬¦åˆPosix.1æ ‡å‡†çš„ä¿¡å·å‡½æ•°sigactionï¼ˆå®é™…ä¸Šï¼Œè¯¥å‡½æ•°æ˜¯åŸºäºBSDçš„ï¼ŒBSDä¸ºäº†å®ç°å¯é ä¿¡å·æœºåˆ¶ï¼Œåˆèƒ½å¤Ÿç»Ÿä¸€å¯¹å¤–æ¥å£ï¼Œç”¨sigactionå‡½æ•°é‡æ–°å®ç°äº†signalå‡½æ•°ï¼‰ï¼›
3. **æŠ¥æ–‡**ï¼ˆMessageï¼‰**é˜Ÿåˆ—**ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ¶ˆæ¯çš„é“¾æ¥è¡¨ï¼ŒåŒ…æ‹¬Posixæ¶ˆæ¯é˜Ÿåˆ—system Væ¶ˆæ¯é˜Ÿåˆ—ã€‚æœ‰è¶³å¤Ÿæƒé™çš„è¿›ç¨‹å¯ä»¥å‘é˜Ÿåˆ—ä¸­æ·»åŠ æ¶ˆæ¯ï¼Œè¢«èµ‹äºˆè¯»æƒé™çš„è¿›ç¨‹åˆ™å¯ä»¥è¯»èµ°é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†**ä¿¡å·æ‰¿è½½ä¿¡æ¯é‡å°‘**ï¼Œ**ç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™**ç­‰ç¼ºç‚¹ã€‚
4. **å…±äº«å†…å­˜**ï¼šä½¿å¾—å¤š**ä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜ç©ºé—´**ï¼Œæ˜¯æœ€å¿«çš„å¯ç”¨IPCå½¢å¼ã€‚æ˜¯é’ˆå¯¹å…¶ä»–é€šä¿¡æœºåˆ¶è¿è¡Œæ•ˆç‡è¾ƒä½è€Œè®¾è®¡çš„ã€‚å¾€å¾€ä¸å…¶å®ƒé€šä¿¡æœºåˆ¶ï¼Œå¦‚**ä¿¡å·é‡ç»“åˆä½¿ç”¨ï¼Œæ¥è¾¾åˆ°è¿›ç¨‹é—´çš„åŒæ­¥åŠäº’æ–¥**ã€‚
5. **ä¿¡å·é‡**ï¼ˆsemaphoreï¼‰ï¼šä¸»è¦**ä½œä¸ºè¿›ç¨‹é—´ä»¥åŠåŒä¸€è¿›ç¨‹ä¸åŒçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ‰‹æ®µ**ã€‚
6. **å¥—æ¥å­—**ï¼ˆSocketï¼‰ï¼šæ›´ä¸ºä¸€èˆ¬çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œ**å¯ç”¨äºä¸åŒæœºå™¨ä¹‹é—´çš„è¿›ç¨‹é—´é€šä¿¡**ã€‚èµ·åˆæ˜¯ç”±Unixç³»ç»Ÿçš„BSDåˆ†æ”¯å¼€å‘å‡ºæ¥çš„ï¼Œä½†ç°åœ¨ä¸€èˆ¬å¯ä»¥ç§»æ¤åˆ°å…¶å®ƒç±»Unixç³»ç»Ÿä¸Šï¼šLinuxå’ŒSystem Vçš„å˜ç§éƒ½æ”¯æŒå¥—æ¥å­—ã€‚



# æ“ä½œç³»ç»Ÿ

## è¿›ç¨‹å’Œçº¿ç¨‹

### è¿›ç¨‹

* æ˜¯ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ†é…å’Œç®¡ç†èµ„æºçš„åŸºæœ¬å•ä½ï¼›
* ç‰¹å¾ï¼š
  * åŠ¨æ€æ€§ï¼šè¿›ç¨‹æ˜¯**ç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹**ï¼Œæ˜¯ä¸´æ—¶çš„ï¼Œæœ‰ç”Ÿå‘½æœŸçš„ï¼Œæ˜¯åŠ¨æ€äº§ç”Ÿï¼ŒåŠ¨æ€æ¶ˆäº¡çš„ï¼›
  * å¹¶å‘æ€§ï¼šä»»ä½•è¿›ç¨‹éƒ½å¯ä»¥åŒå…¶ä»–è¿›è¡Œä¸€èµ·å¹¶å‘æ‰§è¡Œï¼›
  * ç‹¬ç«‹æ€§ï¼šè¿›ç¨‹æ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„ä¸€ä¸ªç‹¬ç«‹å•ä½ï¼›
  * ç»“æ„æ€§ï¼šè¿›ç¨‹ç”±**ç¨‹åºï¼Œæ•°æ®å’Œè¿›ç¨‹æ§åˆ¶å—**ä¸‰éƒ¨åˆ†ç»„æˆï¼›

### çº¿ç¨‹

* æ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½ï¼›
* å¯ä¸åŒå±ä¸€ä¸ªè¿›ç¨‹çš„å…¶ä»–çš„çº¿ç¨‹**å…±äº«**è¿›ç¨‹æ‰€æ‹¥æœ‰çš„å…¨éƒ¨èµ„æºï¼›

### åŒºåˆ«

1. æ ¹æœ¬åŒºåˆ«ï¼šè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œè€Œçº¿ç¨‹æ˜¯ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œçš„åŸºæœ¬å•ä½ï¼›
2. å¼€é”€ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ä»£ç å’Œæ•°æ®ç©ºé—´ï¼ˆç¨‹åºä¸Šä¸‹æ–‡ï¼‰ï¼Œ**è¿›ç¨‹ä¹‹é—´åˆ‡æ¢å¼€é”€å¤§**ï¼›æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿è¡Œæ ˆå’Œç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ï¼Œçº¿ç¨‹æ‰§è¡Œå¼€é”€å°ï¼Œä½†ä¸åˆ©äºèµ„æºçš„ç®¡ç†å’Œä¿æŠ¤ï¼›
3. å†…å­˜åˆ†é…ï¼šç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸åŒçš„å†…å­˜ç©ºé—´ï¼›è€Œå¯¹çº¿ç¨‹è€Œè¨€ï¼Œé™¤äº†CPUå¤–ï¼Œç³»ç»Ÿä¸ä¼šä¸ºçº¿ç¨‹åˆ†é…å†…å­˜ï¼ˆ**çº¿ç¨‹æ‰€ä½¿ç”¨çš„èµ„æºæ¥è‡ªå…¶æ‰€å±è¿›ç¨‹çš„èµ„æº**ï¼‰ï¼Œçº¿ç¨‹ç»„ä¹‹é—´åªèƒ½å…±äº«åŒä¸€ä¸ªè¿›ç¨‹çš„èµ„æºï¼›
4. åŒ…å«å…³ç³»ï¼šçº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥**çº¿ç¨‹ä¹Ÿè¢«ç§°ä¸ºè½»æƒè¿›ç¨‹æˆ–è€…è½»é‡çº§è¿›ç¨‹**ï¼›

# è®¡ç®—æœºç½‘ç»œ

TCPä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹

cookieå’Œsession

# å…¶ä»–

### 1. å¹¶å‘æ“ä½œä¸‹æ‰£å‡åº“å­˜é¿å…è¶…å–

1. ä½¿ç”¨`synchronized`æˆ–è€…`Lock`åŠ é”åŒæ­¥ï¼›

   * ç¼ºç‚¹ï¼šæ•ˆç‡ä¸é«˜ï¼›

2. ä½¿ç”¨`select for update`ï¼Œè¿™æ˜¯æ•°æ®åº“è¡Œé”ï¼Œé”å®šæ›´æ–°è¡Œçš„æ“ä½œï¼›

   * è¡Œé”å¹¶ä¸æ˜¯ç›´æ¥é”è®°å½•ï¼Œè€Œæ˜¯é”ç´¢å¼•ï¼Œå¦‚æœä¸€æ¡sqlè¯­å¥ç”¨åˆ°äº†ä¸»é”®ç´¢å¼•ï¼Œmysqlä¼šé”ä½ä¸»é”®ç´¢å¼•ï¼›å¦‚æœè¯­å¥**æ“ä½œäº†éä¸»é”®ç´¢å¼•**ï¼Œå°±ä¼š**å…ˆé”ä½éä¸»é”®ç´¢å¼•**ï¼Œ**å†é”å®šä¸»é”®ç´¢å¼•**ã€‚

   * ç¼ºç‚¹ï¼šå®¹æ˜“é€ æˆæ­»é”ï¼š(idä¸ºä¸»é”®ç´¢å¼•ï¼Œuser_idï¼Œitem_idä¸ºéä¸»é”®ç´¢å¼•)

     * `update user_item set status=1 where user_id=? and item_id=?`ï¼›

       1. ç”±äºç”¨åˆ°äº†éä¸»é”®ç´¢å¼•ï¼Œé¦–å…ˆéœ€è¦è·å–idx_1ä¸Šçš„è¡Œçº§é”

       2. ç´§æ¥ç€æ ¹æ®ä¸»é”®è¿›è¡Œæ›´æ–°ï¼Œæ‰€ä»¥éœ€è¦è·å–ä¸»é”®ä¸Šçš„è¡Œçº§é”ï¼›

       3. æ›´æ–°å®Œæ¯•åï¼Œæäº¤ï¼Œå¹¶é‡Šæ”¾æ‰€æœ‰é”ã€‚

     * `update user_item .....where id=? and user_id=?`è¿™æ¡è¯­å¥æ’å…¥åˆ°ä¸Šé¢æ­¥éª¤çš„1å’Œ2ä¹‹é—´ï¼Œå®ƒä¼šå…ˆè·å–ä¸»é”®ä¸Šçš„è¡Œçº§é”ï¼Œå†ç­‰å¾…è·å–éä¸»é”®çš„è¡Œçº§é”ï¼Œè¿™æ ·ä¸¤ä¸ªéƒ½è¦ç­‰å¾…å¯¹æ–¹æŒæœ‰çš„é”é‡Šæ”¾ï¼Œå°±äº§ç”Ÿäº†æ­»é”ï¼›

3. `Redis`åˆ†å¸ƒå¼é”ï¼šæ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œå¤šå°æœºå™¨ä¸Šå¤šä¸ªè¿›ç¨‹å¯¹ä¸€ä¸ªæ•°æ®è¿›è¡Œæ“ä½œçš„äº’æ–¥ï¼›

   1. ç”¨`setnx`é”ä½ï¼Œå¦‚æœå¯ä»¥è®¾ç½®ï¼ˆproductIdï¼Œ å½“å‰æ—¶é—´+è¶…æ—¶æ—¶é—´ï¼‰ï¼Œå°±è¿”å›`true`ï¼Œä¹Ÿå°±æ˜¯è·å–åˆ°é”ï¼›
   2. æ ¹æ®å…ˆé€šè¿‡`get(key)`è·å–çš„è¶…æ—¶æ—¶é—´åˆ¤æ–­é”æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±å°è¯•å»è·å–é”ï¼šé€šè¿‡`getAndSet(key,value)`å…ˆè·å–ä¸Šä¸ªé”çš„æ—¶é—´ï¼Œå†è®¾ç½®è‡ªå·±çš„æ—¶é—´è¿›å»ï¼Œå¹¶åˆ¤æ–­å…ˆåä¸¤æ¬¡è·å–çš„æ—¶é—´æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œå°±æ„å‘³ç€ï¼Œå·²ç»æœ‰å…¶ä»–çº¿ç¨‹`getAndSet`å¹¶ä¸”è·å–åˆ°äº†é”ã€‚

### 2. SimpleDateFormatçº¿ç¨‹ä¸å®‰å…¨

`SimpleDateFormat`ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•`parse()`å’Œ`format()`å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›